
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ECN System â€” v8 (Monthly Sim Data)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f7f8fb; --panel:#ffffff; --muted:#6b7280; --text:#0f172a;
    --primary:#0ea5e9; --primary-600:#0284c7; --accent:#10b981; --warn:#f59e0b; --danger:#ef4444; --ok:#22c55e;
    --border:#e5e7eb; --shadow:0 8px 24px rgba(2,6,23,.08);
    --task1:#0ea5e9; --task2:#22c55e; --taskbarH:28px;
    --rankA:#16a34a; --rankB:#2563eb; --rankC:#f59e0b; --rankD:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:linear-gradient(180deg,#fbfdff,var(--bg) 30%)}
  .app{display:grid;grid-template-columns:184px 1fr;min-height:100dvh}
  aside{background:#0b1220;color:#cbd5e1;padding:14px 10px;position:sticky;top:0;height:100dvh}
  .brand{display:flex;align-items:center;gap:8px;margin-bottom:10px}
  .brand .logo{width:34px;height:34px;border-radius:10px;background:conic-gradient(from 180deg at 50% 50%, #22c55e, #0ea5e9, #7c3aed, #22c55e);display:grid;place-items:center;color:#fff;font-weight:900;font-size:14px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
  .brand .logo::after{content:"AI";filter:drop-shadow(0 1px 2px rgba(0,0,0,.35))}
  .brand h1{font-size:14px;margin:0;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  nav{margin-top:6px}
  .nav-section{margin-top:10px;font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:#94a3b8;padding:0 4px 4px}
  .nav-section.support{margin-top:37.8px; position:relative;}
  .nav-section.support::before{content:""; position:absolute; top:-22px; left:6px; right:6px; height:1px; background:linear-gradient(90deg,transparent,#1f2937,transparent); box-shadow:0 1px 0 rgba(255,255,255,.05)}
  .nav-item{padding:7px 8px;border-radius:10px;cursor:pointer;color:#cbd5e1;font-size:13px}
  .nav-item:hover{background:#0f172a}.nav-item.active{background:#111827;color:#fff;font-weight:600}
  .ai-launch{margin:10px 6px 8px;padding:10px;border-radius:12px;background:linear-gradient(135deg,#0ea5e9,#7c3aed); display:flex;align-items:center;gap:10px;cursor:pointer;box-shadow:0 10px 20px rgba(2,6,23,.35)}
  .ai-launch svg{width:18px;height:18px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.35))}
  .ai-launch span{font-weight:800;color:#fff}
  .user{position:absolute;bottom:10px;left:10px;right:10px;padding:8px;border-radius:12px;background:#0f172a;color:#e5e7eb;font-size:12px}
  main{padding:10px 12px 16px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{padding:5px 9px;border-radius:10px;background:#eef2ff;color:#3730a3;font-weight:600;display:inline-flex;gap:6px}
  .badge{padding:3px 9px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#fff}
  .spacer{flex:1}
  .search{min-width:220px;flex:1;max-width:420px;position:relative}
  .search input{width:100%;padding:8px 38px 8px 34px;border-radius:10px;border:1px solid var(--border);background:#fff;outline:none;font-size:13px}
  .search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:18px;height:18px;opacity:.7}
  .btn{border:1px solid var(--primary);color:#fff;background:linear-gradient(180deg,var(--primary),var(--primary-600));padding:7px 10px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:var(--shadow);font-size:13px}
  .btn.secondary{border-color:var(--border);background:#fff;color:#0f172a}
  .lang{min-width:120px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow)}
  .card .head{padding:8px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .card .body{padding:8px 10px 10px}
  .filters{display:flex;gap:8px;flex-wrap:wrap}
  .filter{border:1px solid var(--border);background:#fff;border-radius:10px;padding:5px 7px;display:flex;align-items:center;gap:6px;font-size:13px}
  select,input{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 8px;font-size:13px;outline:none}
  .hidden{display:none!important}
  /* Tables */
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  thead th{text-align:left;font-size:12px;color:#fff;padding:6px 8px}
  thead tr.taskbar{background:linear-gradient(90deg,var(--task1),var(--task2));height:var(--taskbarH)}
  tbody tr{background:#fff;border:1px solid var(--border)}
  tbody tr td{padding:6px 8px;font-size:12.5px;vertical-align:middle}
  tbody tr{border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
  tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  /* Drawer (view) with section tiles */
  .drawer{position:fixed;top:0;right:-520px;width:520px;height:100dvh;background:#fff;border-left:1px solid var(--border);box-shadow:-12px 0 32px rgba(2,6,23,.12);transition:right .28s ease;z-index:60;display:flex;flex-direction:column}
  .drawer.open{right:0}
  .drawer .dh{padding:10px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:1}
  .drawer .dc{padding:10px;overflow:auto}
  .tabs{display:flex;gap:6px;border-bottom:1px solid var(--border);margin-bottom:8px}
  .tab{padding:6px 10px;border-radius:8px 8px 0 0;border:1px solid var(--border);border-bottom:none;background:#f8fafc;cursor:pointer}
  .tab.active{background:#fff;font-weight:700}
  .kv-tile{background:linear-gradient(180deg,#fbfbfe,#f6f7fb);border:1px solid #e9ecf3;border-radius:12px;padding:8px 10px;margin:6px 0;box-shadow:0 6px 16px rgba(2,6,23,.06)}
  .kv-tile .k{color:#6b7280;font-size:11px;text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .badge-mini{padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:11px}
  /* Heatmap & charts slim */
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:stretch}
  canvas{height:200px !important}
  .heatmap{display:grid;grid-template-columns:80px repeat(12,1fr);border:1px solid var(--border);background:#fff;border-radius:10px;overflow:hidden}
  .heatmap div{padding:6px;border-bottom:1px solid var(--border);border-right:1px solid var(--border);text-align:center;font-size:11px}
  .heatmap .hhead{background:#0f172a;color:#fff;font-weight:700}
  /* Status icons & Rank */
  .s-dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle}
  .s-pending{background:var(--warn)} .s-progress{background:var(--primary)} .s-done{background:var(--ok)}
  .rank{display:inline-flex;align-items:center;gap:6px}
  .rank-badge{min-width:22px;height:22px;border-radius:6px;display:grid;place-items:center;color:#fff;font-weight:900;font-size:12px;box-shadow:var(--shadow)}
  .rank-A{background:var(--rankA)} .rank-B{background:var(--rankB)} .rank-C{background:var(--rankC)} .rank-D{background:var(--rankD)}
  /* Pagination top */
  .topline{display:flex;align-items:center;gap:8px}
  .pagination{margin-left:auto;display:flex;gap:8px;align-items:center}
  .page-mini{font-size:11px;color:var(--muted);margin-top:4px;text-align:right}
  /* KPI tiny cards */
  .kpis{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:10px}
  .kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:var(--shadow)}
  .kpi .k{color:var(--muted);font-size:12px} .kpi .v{font-size:20px;font-weight:900;margin-top:2px}
  /* Chatroom */
  .chat-bubble{max-width:80%;padding:8px 12px;border-radius:16px;margin:4px 0;box-shadow:0 4px 10px rgba(2,6,23,.08)}
  .me{background:#dcfce7;margin-left:auto} .other{background:#e5f3ff}
  .chat-sender{font-size:11px;color:#64748b;margin-top:-2px}
  /* Language switcher placement */
  .lang-wrap{display:flex;align-items:center;gap:6px}
  @media (max-width: 980px){
    .app{grid-template-columns:1fr}
    .drawer{width:100%}
    .row-2{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<script>window.ECN = Array.isArray(window.ECN) ? window.ECN : [];</script>
<div class="app">
  <aside>
    <div class="brand">
      <div class="logo"></div>
      <h1>ECN System</h1>
    </div>
    <div class="ai-launch" id="openAI">
      <svg viewBox="0 0 24 24" fill="none"><path d="M12 3l2.5 4.5L20 9l-3.5 3 1 5-5-2.5L7.5 17l1-5L5 9l5.5-1.5L12 3z" stroke="#fff" stroke-width="1.5" stroke-linejoin="round"/></svg>
      <span>ECN AI Advisor</span>
    </div>
    <nav id="nav">
      <div class="nav-section">Main</div>
      <div class="nav-item active" data-nav="dashboard">Dashboard</div>
      <div class="nav-item" data-nav="ecnMaster">ECN Master</div>
      <div class="nav-item" data-nav="department">Department</div>
      <div class="nav-item" data-nav="admin">Admin</div>
      <div class="nav-section support">Support Tools</div>
      <div class="nav-item" data-nav="chatroom">Chatroom</div>
      <div class="nav-item" data-nav="convertBOM">Convert BOM</div>
      <div class="nav-item" data-nav="wiVerify">WI Verify</div>
    </nav>
    <div class="user"><div style="font-weight:700">App Mode:</div><small>Demo UI â€” offline</small></div>
  </aside>

  <main>
    <div class="toolbar">
      <div class="chip">Ready</div><div class="badge">UI v8</div>
      <div class="spacer"></div>
      <div class="search">
        <svg viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 110-15 7.5 7.5 0 010 15z" stroke="#64748b" stroke-width="2" stroke-linecap="round"/></svg>
        <input id="q" placeholder="Search ECN (no., content, dept, owner)..." />
      </div>
      <div class="lang-wrap">
        <span class="badge">Language</span>
        <select id="langTop" class="lang">
<option value="en">English</option><option value="vi">Tiáº¿ng Viá»‡t</option><option value="ja">æ—¥æœ¬èªž</option>
          <option value="en">English</option><option value="vi">Tiáº¿ng Viá»‡t</option><option value="zh">ä¸­æ–‡</option>
          <option value="ja">æ—¥æœ¬èªž</option><option value="ko">í•œêµ­ì–´</option><option value="es">EspaÃ±ol</option>
          <option value="fr">FranÃ§ais</option><option value="de">Deutsch</option>
        </select>
      </div>
      <button class="btn secondary" id="btnExportAll">Export ECN CSV</button>
      <button class="btn" id="btnNew">+ New ECN</button>
      <input type="file" id="newFile" accept=".csv,.tsv,.txt" class="hidden" />
    </div>

    <!-- DASHBOARD -->
    <section id="page-dashboard" class="grid">
      <section class="card">
        <div class="head"><strong>KPIs</strong></div>
        <div class="body">
          <div class="kpis">
            <div class="kpi"><div class="k">Not Yet Apply</div><div class="v" id="kPending">0</div></div>
            <div class="kpi"><div class="k">Not yet apply</div><div class="v" id="kProgress">0</div></div>
            <div class="kpi"><div class="k">In progress</div><div class="v" id="kEffective">0</div></div>
            <div class="kpi"><div class="k">Completed</div><div class="v" id="kArchived">0</div></div>
          </div>
        </div>
      </section>
      <section class="card">
        <div class="head"><strong>Trends</strong></div>
        <div class="body row-2">
          <canvas id="yearlyChart"></canvas>
          <canvas id="monthlyChart"></canvas>
        </div>
      </section>
      <section class="card">
        <div class="head"><strong>Department Ã— Month Heatmap</strong></div>
        <div class="body"><div class="heatmap" id="heatmap"></div></div>
      </section>
    </section>

    <!-- ECN MASTER -->
    <section id="page-ecnMaster" class="grid hidden">
      <section class="card">
        <div class="head topline">
          <strong>ECN Master</strong>
          <div class="filters">
            <div class="filter"><span>Status</span>
              <select id="fStatusSel"><option value="">All</option><option>Not Yet Apply</option><option>In progress</option><option>Completed</option></select>
            </div>
            <div class="filter"><label>Department</label>
              <select id="fDept">
                <option value="">All</option><option>SMT</option><option>DIP</option><option>FA</option><option>FE</option>
                <option>PE</option><option>QC</option><option>PMS</option><option>PSCD</option><option>COS</option>
              </select>
            </div>
            <div class="filter"><label>Effective</label><input id="fDateFrom" type="date" />â€“<input id="fDateTo" type="date" /></div>
          </div>
          <!-- Legend on the right -->
          <div class="pagination">
            <div class="badge"><span class="s-dot s-pending"></span>Not Yet Apply</div>
            <div class="badge"><span class="s-dot s-progress"></span>In progress</div>
            <div class="badge"><span class="s-dot s-done"></span>Completed</div>
            <button class="btn secondary" id="prevPage">Back</button>
            <button class="btn" id="nextPage">Go</button>
          </div>
        </div>
        <div class="body">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr class="taskbar">
                  <th>Rank</th><th>ECN No.</th><th>Sub ECN</th><th>Model</th><th>Title</th><th>Before</th><th>After</th><th>Effective</th><th>Valid BOM</th><th>Status</th><th>View</th>
                </tr>
              </thead>
              <tbody id="ecnRows"></tbody>
            </table>
            <div class="page-mini" id="miniInfo">Page 1/1 â€” 0 items</div>
          </div>
        </div>
      </section>

      <!-- Staging panel -->
      <section class="card hidden" id="stagingPanel">
        <div class="head"><strong>Staging â€” Review imported ECN</strong><div class="spacer"></div><button class="btn" id="confirmImport">Confirm & Push</button></div>
        <div class="body">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr class="taskbar">
                  <th>ECN No.</th><th>Sub ECN</th><th>Model</th><th>Title</th><th>Before</th><th>After</th><th>Effective</th><th>Valid BOM</th><th>Status</th>
                </tr>
              </thead>
              <tbody id="stagingRows"></tbody>
            </table>
          </div>
        </div>
      </section>
    </section>

    <!-- DEPARTMENT -->
    <section id="page-department" class="grid hidden">
      <section class="card">
        <div class="head"><strong>Department</strong>
          <div class="filters">
            <div class="filter"><label>Department</label>
              <select id="dDept">
                <option>SMT</option><option>DIP</option><option>FA</option><option>FE</option><option>PE</option><option>QC</option><option>PMS</option><option>PSCD</option><option>COS</option>
              </select>
            </div>
            
            
          </div>
        </div>
        <div class="body">
          <div id="deptFields" class="filters" style="margin-bottom:8px"></div>
          <div style="overflow:auto">
            <table>
              <thead id="deptHead"><tr class="taskbar"><th>Rank</th><th>ECN No.</th><th>Sub ECN</th><th>Model</th><th>Title</th><th>Before</th><th>After</th><th>Effective</th><th>Valid BOM</th><th>Status</th><th>View</th></tr></thead>
              <tbody id="deptRows"></tbody>
            </table>
          </div>
        </div>
      </section>
    </section>

    <!-- ADMIN -->
    <section id="page-admin" class="grid hidden">
<!-- Integrated ECN_Admin Module.html via iframe -->
<div style="height:70vh;max-height:calc(100dvh - 160px);"><iframe title="ECN Admin Module" id="adminFrame" style="width:100%;height:100%;border:0;border-radius:12px;background:#fff" srcdoc="&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1&quot;&gt;
&lt;title&gt;ECN Admin â€” Users Â· Jobs Â· Notifications Â· Integrations Â· API Keys&lt;/title&gt;
&lt;style&gt;

:root{
  --bg:#ffffff; 
  --panel:#f9fafb; 
  --muted:#6b7280; 
  --text:#111827;
  --accent:#2563eb; 
  --chip:#f3f4f6; 
  --border:#d1d5db; 
  --card:#ffffff;
  --ok:#16a34a; 
  --stop:#dc2626; 
  --idle:#d97706;
}

*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#ffffff,#ffffffcc);border-bottom:1px solid var(--border);backdrop-filter:blur(6px)}
.wrap{max-width:1160px;margin:0 auto;padding:12px 18px;display:flex;gap:12px;align-items:center}
.title{font-weight:800;letter-spacing:.2px}
.muted{color:var(--muted);font-size:12px}
.app{max-width:1160px;margin:18px auto;padding:0 18px}
.tabs{display:flex;gap:8px;margin-bottom:14px}
.tab{flex:1;display:flex;justify-content:center;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;user-select:none}
.tab.active{outline:2px solid var(--accent)}
.view{display:none;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
.view.active{display:block}
.card{background:linear-gradient(180deg,var(--card),#f9fafb);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:14px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;font-size:13.5px;vertical-align:top}
input,select,textarea{background:#ffffff;border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:10px;font-size:14px}
textarea{min-height:76px;resize:vertical}
.btn{background:#f3f4f6;color:var(--text);border:1px solid var(--border);padding:9px 12px;border-radius:10px;cursor:pointer}
.btn.sm{padding:7px 10px;font-size:12px}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.kv{display:grid;grid-template-columns:170px 1fr;gap:10px;align-items:center;margin-top:8px}
.badge{display:inline-flex;gap:8px;align-items:center;background:#ffffff;border:1px solid var(--border);padding:6px 12px;border-radius:999px;font-size:12px}
.code{font-family:ui-monospace,Consolas,monospace;background:#f3f4f6;border:1px solid var(--border);padding:6px 10px;border-radius:8px;display:inline-block}
.status{display:inline-flex;gap:6px;align-items:center;padding:5px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px}
.s-ok{background:rgba(34,197,94,.12)} .s-stop{background:rgba(239,68,68,.12)}
.note{background:#ffffff;border:1px dashed var(--border);border-radius:12px;padding:12px;white-space:pre-wrap}
.small{font-size:12px;color:var(--muted)}
.hidden{display:none}
h3{margin:0 0 8px 0;font-weight:700}
h4{margin:10px 0 6px 0}
.search{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.search input{min-width:220px}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{background:#ffffff;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
.chip.active{outline:2px solid var(--accent)}

/* --- Tweaks for Integrations layout fit --- */
.grid2.intg{grid-template-columns:2fr 1fr;}
#integrations .kv &gt; div:first-child{min-width:160px}
#integrations input,#integrations select,#integrations textarea{width:100%}
#integrations textarea#sapEndpoints{min-height:96px}
#integrations .card &gt; h3{margin-bottom:6px}
/* Right table sizing */
#integrations #intTable .code{display:inline-block;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#integrations #intTable td,#integrations #intTable th{font-size:12.5px;padding:8px 10px}
#integrations #intTable .btn.sm{padding:6px 8px}
/* Status color polish */
.status{border-width:0}
.status.s-ok{background:rgba(22,163,74,.14)}
.status.s-stop{background:rgba(107,114,128,.14)}
/* Helper notes spacing */
#helperNotes{line-height:1.55}
/* Mobile fallback */
@media (max-width: 960px){
  .grid2.intg{grid-template-columns:1fr}
}


/* ==== Integrations fit overrides v2 ==== */
.grid2.intg{
  grid-template-columns: minmax(560px, 1fr) 380px;
  gap: 16px;
}
#integrations .card.right-col{max-width:380px}
#integrations #intTable{table-layout:fixed;width:100%}
#integrations #intTable th:nth-child(3),
#integrations #intTable td:nth-child(3){ /* URL col */
  width: 170px;
}
#integrations #intTable .code{max-width:160px}
#integrations .kv{grid-template-columns: 160px 1fr}
#integrations .kv .label{padding-top:8px}
#integrations .kv .field{min-width:0}
#integrations .card{padding:14px 16px}
#integrations input,#integrations select,#integrations textarea{height:38px}
#integrations textarea{height:auto;min-height:110px}
#integrations .status{font-size:12px;padding:4px 10px;border-radius:999px}
#integrations .btn.sm{font-size:12px;padding:6px 10px;border-radius:10px}
@media (max-width: 1100px){
  .grid2.intg{grid-template-columns:1fr}
  #integrations .card.right-col{max-width:100%}
}


/* ==== Integrations fit overrides v3 (balance) ==== */
.grid2.intg{
  grid-template-columns: 1.4fr 1fr;
  gap: 18px;
}
#integrations .card.right-col{max-width:none}
#integrations .kv{grid-template-columns:150px 1fr}
#integrations input,#integrations select,#integrations textarea{width:100%;min-width:0}
#integrations #intTable{table-layout:fixed;width:100%}
#integrations #intTable th,#integrations #intTable td{word-wrap:break-word;word-break:break-word}
@media(max-width:1100px){
  .grid2.intg{grid-template-columns:1fr}
}


/* ==== Integrations fit overrides v4 (left narrower, right wider) ==== */
.grid2.intg{
  /* right column wider than left */
  grid-template-columns: 1fr 1.25fr;
  gap: 20px;
}
#integrations .kv{grid-template-columns:140px 1fr}
#integrations .card.right-col{max-width:none}
/* table gets more room + safer wrapping */
#integrations #intTable{table-layout:fixed;width:100%}
#integrations #intTable th:nth-child(3),
#integrations #intTable td:nth-child(3){ /* URL */
  width: 230px;
}
#integrations #intTable th,#integrations #intTable td{
  word-break:break-word; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
/* inputs keep full width but won&#x27;t force the column wider */
#integrations input,#integrations select,#integrations textarea{min-width:0;width:100%}
@media(max-width:1200px){
  .grid2.intg{grid-template-columns:1fr}
}


/* ==== Integrations fit overrides v5 (stacked) ==== */
.grid2.intg{
  display:grid;
  grid-template-columns: 1fr !important; /* force single column */
  grid-auto-flow: row;
  gap: 18px;
}
#integrations .card{width:100%}
#integrations .card.right-col{max-width:100%}
#integrations .kv{grid-template-columns: 160px 1fr}
#integrations input,#integrations select,#integrations textarea{width:100%;min-width:0}
#integrations #intTable{table-layout:fixed;width:100%}
#integrations #intTable th,#integrations #intTable td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#integrations #intTable th:nth-child(3),
#integrations #intTable td:nth-child(3){ /* URL column wider on full width */
  width: 360px;
}


/* ==== Integrations fit overrides v6 (no text loss) ==== */
.grid2.intg{
  grid-template-columns: 1fr !important;
  gap: 24px; /* larger spacing between blocks */
}
#integrations .card{width:100%}
#integrations .card.right-col{max-width:100%}

/* Ensure ALL text is visible â€” allow wrapping, remove ellipsis */
#integrations #intTable{table-layout:auto;width:100%}
#integrations #intTable th,
#integrations #intTable td{
  white-space: normal !important;
  overflow: visible !important;
  text-overflow: clip !important;
  word-break: break-word;
}
#integrations #intTable th:nth-child(3),
#integrations #intTable td:nth-child(3){
  width: auto !important; /* URL not fixed width */
}
#integrations #intTable .code{max-width:none;display:block}

/* Inputs wrap naturally and won&#x27;t force overflow */
#integrations input,#integrations select,#integrations textarea{min-width:0;width:100%}


/* ==== Integrations fit overrides v7 (full-width stacked everywhere) ==== */
#integrations .grid2{
  display: grid !important;
  grid-template-columns: 1fr !important;
  gap: 24px !important;
}
#integrations .grid2 &gt; .card{width:100% !important; max-width:100% !important; order: initial}
/* In case some markup wraps the right list with .card.right-col, ensure it&#x27;s second */
#integrations .grid2 &gt; .card.right-col{order: 2 !important}
#integrations .grid2 &gt; .card:first-child{order:1 !important}

/* Table: wrap naturally */
#integrations table,#integrations thead,#integrations tbody,#integrations tr,#integrations th,#integrations td{display:table; border-collapse:separate}
#integrations th,#integrations td{
  white-space: normal !important;
  overflow: visible !important;
  text-overflow: clip !important;
  word-break: break-word !important;
}

/* Make the notes block full width as well */
#helperNotes, .helper-notes, #notesCard{width:100% !important; max-width:100% !important}


/* ==== Integrations fit overrides v8 (restore table rows, proper order) ==== */
#integrations .grid2{
  display:grid !important;
  grid-template-columns:1fr !important;
  gap:24px !important;
}
#integrations .grid2 &gt; .card:first-child{order:1 !important}   /* Káº¿t ná»‘i pháº§n má»m */
#integrations .grid2 &gt; .card.right-col{order:2 !important}     /* Danh sÃ¡ch Ä‘Ã£ káº¿t ná»‘i */

/* Restore native table layout to avoid vertical stacked letters */
#integrations table{display:table !important; width:100% !important; border-collapse:separate; table-layout:auto !important}
#integrations thead{display:table-header-group !important}
#integrations tbody{display:table-row-group !important}
#integrations tr{display:table-row !important}
#integrations th,#integrations td{display:table-cell !important; white-space:normal !important; word-break:break-word !important; overflow:visible !important; text-overflow:clip !important; padding:8px 10px}

/* Ensure inputs don&#x27;t overflow */
#integrations input,#integrations select,#integrations textarea{min-width:0; width:100%}


/* Fix Jobs / Schedulers layout: ensure cards khÃ´ng chá»“m ra ngoÃ i */
#jobs .grid2{
  align-items: flex-start;
}
#jobs .grid2 &gt; .card{
  width: 100%;
  box-sizing: border-box;
}

/* Jobs table buttons equal width */
#jobs .btn-eq{
  min-width:72px;
  text-align:center;
}
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;header&gt;
  &lt;div class=&quot;wrap&quot;&gt;
    &lt;div class=&quot;title&quot;&gt;ECN Admin&lt;/div&gt;
    &lt;div class=&quot;muted&quot;&gt;Users Â· Jobs Â· Notifications Â· Integrations Â· API Keys&lt;/div&gt;
  &lt;/div&gt;
&lt;/header&gt;

&lt;div class=&quot;app&quot;&gt;
  &lt;div class=&quot;tabs&quot;&gt;
    &lt;div class=&quot;tab active&quot; data-tab=&quot;users&quot;&gt;ðŸ‘¥ User Management&lt;/div&gt;
    &lt;div class=&quot;tab&quot; data-tab=&quot;jobs&quot;&gt;â± Jobs / Schedulers&lt;/div&gt;
    &lt;div class=&quot;tab&quot; data-tab=&quot;notify&quot;&gt;ðŸ”” Notifications&lt;/div&gt;
    &lt;div class=&quot;tab&quot; data-tab=&quot;integrations&quot;&gt;ðŸ”— Integrations&lt;/div&gt;
    &lt;div class=&quot;tab&quot; data-tab=&quot;api&quot;&gt;ðŸ”‘ API Keys&lt;/div&gt;
  &lt;/div&gt;

  &lt;!-- USERS --&gt;
  &lt;section id=&quot;users&quot; class=&quot;view active&quot;&gt;
    &lt;div class=&quot;card right-col&quot;&gt;
      &lt;div class=&quot;grid2 intg&quot;&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;h3&gt;ThÃªm ngÆ°á»i dÃ¹ng&lt;/h3&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Há» tÃªn&lt;/div&gt;&lt;input id=&quot;uName&quot; placeholder=&quot;Nguyá»…n VÄƒn A&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Global ID&lt;/div&gt;&lt;input id=&quot;uGlobal&quot; placeholder=&quot;Panasonic Global ID&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Email&lt;/div&gt;&lt;input id=&quot;uEmail&quot; placeholder=&quot;a@company.com&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;PhÃ²ng ban&lt;/div&gt;
            &lt;select id=&quot;uDept&quot;&gt;&lt;option&gt;FE&lt;/option&gt;&lt;option&gt;PE&lt;/option&gt;&lt;option&gt;QC&lt;/option&gt;&lt;option&gt;SMT&lt;/option&gt;&lt;option&gt;COS&lt;/option&gt;&lt;option&gt;PCS&lt;/option&gt;&lt;option&gt;SCM&lt;/option&gt;&lt;option&gt;DIP&lt;/option&gt;&lt;option&gt;FA&lt;/option&gt;&lt;option&gt;PMS&lt;/option&gt;&lt;option&gt;IT&lt;/option&gt;&lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Vai trÃ²&lt;/div&gt;
            &lt;select id=&quot;uRole&quot;&gt;&lt;option&gt;Viewer&lt;/option&gt;&lt;option&gt;Editor&lt;/option&gt;&lt;option&gt;Admin&lt;/option&gt;&lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Tráº¡ng thÃ¡i&lt;/div&gt;
            &lt;select id=&quot;uStatus&quot;&gt;&lt;option&gt;Active&lt;/option&gt;&lt;option&gt;Suspended&lt;/option&gt;&lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Ghi chÃº&lt;/div&gt;&lt;textarea id=&quot;uNote&quot; placeholder=&quot;Pháº¡m vi, lÆ°u Ã½ cáº¥p quyá»n...&quot;&gt;&lt;/textarea&gt;&lt;/div&gt;
          &lt;div class=&quot;flex&quot; style=&quot;margin-top:10px&quot;&gt;
            &lt;button class=&quot;btn&quot; id=&quot;btnUserSave&quot;&gt;LÆ°u&lt;/button&gt;
            &lt;button class=&quot;btn&quot; id=&quot;btnUserReset&quot;&gt;Reset&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;h3&gt;Danh sÃ¡ch ngÆ°á»i dÃ¹ng&lt;/h3&gt;
          &lt;div class=&quot;search&quot;&gt;
            &lt;input id=&quot;uSearch&quot; placeholder=&quot;TÃ¬m theo tÃªn hoáº·c email&quot;&gt;
            &lt;div class=&quot;chips&quot;&gt;
              &lt;span class=&quot;chip active&quot; data-u-filter=&quot;all&quot;&gt;All&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;Active&quot;&gt;Active&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;Suspended&quot;&gt;Suspended&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;FE&quot;&gt;FE&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;PE&quot;&gt;PE&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;QC&quot;&gt;QC&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;SMT&quot;&gt;SMT&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;COS&quot;&gt;COS&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;PCS&quot;&gt;PCS&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;SCM&quot;&gt;SCM&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;DIP&quot;&gt;DIP&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;FA&quot;&gt;FA&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;PMS&quot;&gt;PMS&lt;/span&gt;
              &lt;span class=&quot;chip&quot; data-u-filter=&quot;IT&quot;&gt;IT&lt;/span&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          
&lt;table class=&quot;table&quot; id=&quot;tblUsers&quot;&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;Há» tÃªn&lt;/th&gt;
                &lt;th&gt;Global ID&lt;/th&gt;
                &lt;th&gt;Email&lt;/th&gt;
                &lt;th&gt;PhÃ²ng ban&lt;/th&gt;
                &lt;th&gt;Vai trÃ²&lt;/th&gt;
                &lt;th&gt;Tráº¡ng thÃ¡i&lt;/th&gt;
                &lt;th&gt;Thao tÃ¡c&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;&lt;/tbody&gt;
          &lt;/table&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/section&gt;

  &lt;!-- JOBS / SCHEDULERS --&gt;
  &lt;section id=&quot;jobs&quot; class=&quot;view&quot;&gt;
    &lt;div class=&quot;card&quot;&gt;
      &lt;h3&gt;Jobs / Schedulers&lt;/h3&gt;
      &lt;div class=&quot;grid2&quot;&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;h4&gt;CÃ i Ä‘áº·t Job&lt;/h4&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;TÃªn Job&lt;/div&gt;
            &lt;select id=&quot;jobType&quot;&gt;
              &lt;option&gt;SAP Valid BOM Sync&lt;/option&gt;
              &lt;option&gt;SAP Production plan Sync&lt;/option&gt;
              &lt;option&gt;Custom&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv hidden&quot;&gt;&lt;div&gt;TÃªn Job (Custom)&lt;/div&gt;
            &lt;input id=&quot;jobCustomName&quot; placeholder=&quot;Nháº­p tÃªn job má»›i khi chá»n Custom&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Nguá»“n dá»¯ liá»‡u&lt;/div&gt;
            &lt;input id=&quot;jobSource&quot; placeholder=&quot;ÄÆ°á»ng dáº«n file/URL IT export tá»« SAP (share path, HTTP, ... )&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Lá»‹ch cháº¡y&lt;/div&gt;
            &lt;input id=&quot;jobFreq&quot; placeholder=&quot;VÃ­ dá»¥: má»—i 15 phÃºt, má»—i 1 giá», hÃ ng ngÃ y 02:00...&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Báº­t job&lt;/div&gt;
            &lt;select id=&quot;jobEnabled&quot;&gt;
              &lt;option value=&quot;On&quot;&gt;Enabled&lt;/option&gt;
              &lt;option value=&quot;Off&quot;&gt;Disabled&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Ghi chÃº&lt;/div&gt;
            &lt;textarea id=&quot;jobNote&quot; placeholder=&quot;VD: Sync ECN valid tá»« SAP má»—i 15 phÃºt, Ä‘á»ƒ tá»± Ä‘á»™ng update ECN Master.&quot;&gt;&lt;/textarea&gt;
          &lt;/div&gt;
          &lt;div class=&quot;flex&quot; style=&quot;margin-top:10px&quot;&gt;
            &lt;button class=&quot;btn&quot; id=&quot;btnJobSave&quot;&gt;LÆ°u job&lt;/button&gt;
            &lt;button class=&quot;btn&quot; id=&quot;btnJobReset&quot;&gt;Reset&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;h4&gt;Danh sÃ¡ch job&lt;/h4&gt;
          &lt;p class=&quot;small&quot;&gt;Theo dÃµi cÃ¡c job sync vá»›i SAP, MES, job cáº£nh bÃ¡o ValidDeadline...&lt;/p&gt;
          &lt;table class=&quot;table&quot; id=&quot;tblJobs&quot;&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;TÃªn job&lt;/th&gt;
                &lt;th&gt;Loáº¡i&lt;/th&gt;
                &lt;th&gt;Nguá»“n&lt;/th&gt;
                &lt;th&gt;Lá»‹ch cháº¡y&lt;/th&gt;
                &lt;th&gt;Last run&lt;/th&gt;
                &lt;th&gt;Tráº¡ng thÃ¡i&lt;/th&gt;
                &lt;th&gt;Thao tÃ¡c&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;&lt;/tbody&gt;
          &lt;/table&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;note small&quot; id=&quot;jobHelper&quot;&gt;
        Gá»£i Ã½: táº¡o tá»‘i thiá»ƒu 1 job &quot;SAP ECN Sync&quot; cháº¡y má»—i 15 phÃºt Ä‘á»ƒ cáº­p nháº­t valid ECN tá»± Ä‘á»™ng tá»« SAP.
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/section&gt;

  &lt;!-- NOTIFICATIONS / SUBSCRIPTIONS --&gt;
  &lt;section id=&quot;notify&quot; class=&quot;view&quot;&gt;
    &lt;div class=&quot;card&quot;&gt;
      &lt;h3&gt;Notifications / Subscriptions&lt;/h3&gt;
      &lt;div class=&quot;grid2&quot;&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;h4&gt;ÄÄƒng kÃ½ nháº­n cáº£nh bÃ¡o&lt;/h4&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;NgÆ°á»i nháº­n&lt;/div&gt;&lt;input id=&quot;nName&quot; placeholder=&quot;TrÆ°á»Ÿng phÃ²ng QC&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Email&lt;/div&gt;&lt;input id=&quot;nEmail&quot; placeholder=&quot;qc.manager@company.com&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Bá»™ pháº­n&lt;/div&gt;
            &lt;select id=&quot;nDept&quot;&gt;
              &lt;option&gt;FE&lt;/option&gt;&lt;option&gt;PE&lt;/option&gt;&lt;option&gt;QC&lt;/option&gt;&lt;option&gt;SMT&lt;/option&gt;
              &lt;option&gt;COS&lt;/option&gt;&lt;option&gt;DIP&lt;/option&gt;&lt;option&gt;FA&lt;/option&gt;&lt;option&gt;PMS&lt;/option&gt;&lt;option&gt;IT&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Sá»± kiá»‡n&lt;/div&gt;
            &lt;div class=&quot;flex small&quot; style=&quot;align-items:flex-start&quot;&gt;
              &lt;label&gt;&lt;input type=&quot;checkbox&quot; id=&quot;nEvtValid&quot; checked&gt; Valid ECN thay Ä‘á»•i&lt;/label&gt;
              &lt;label&gt;&lt;input type=&quot;checkbox&quot; id=&quot;nEvtNew&quot; checked&gt; New ECN Effective&lt;/label&gt;
              &lt;label&gt;&lt;input type=&quot;checkbox&quot; id=&quot;nEvtDeadline&quot;&gt; Deadline ECN sáº¯p tá»›i&lt;/label&gt;
              &lt;label&gt;&lt;input type=&quot;checkbox&quot; id=&quot;nEvtJobError&quot;&gt; Job sync lá»—i&lt;/label&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;KÃªnh&lt;/div&gt;
            &lt;select id=&quot;nChannel&quot;&gt;
              &lt;option&gt;Popup&lt;/option&gt;
              &lt;option&gt;Email&lt;/option&gt;
              &lt;option&gt;Popup + Email&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Táº§n suáº¥t&lt;/div&gt;
            &lt;select id=&quot;nFreq&quot;&gt;
              &lt;option&gt;Real-time&lt;/option&gt;
              &lt;option&gt;Hourly digest&lt;/option&gt;
              &lt;option&gt;Daily summary&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Ghi chÃº&lt;/div&gt;
            &lt;textarea id=&quot;nNote&quot; placeholder=&quot;VD: Chá»‰ nháº­n ECN Effective liÃªn quan tá»›i QC.&quot;&gt;&lt;/textarea&gt;
          &lt;/div&gt;
          &lt;div class=&quot;flex&quot; style=&quot;margin-top:10px&quot;&gt;
            &lt;button class=&quot;btn&quot; id=&quot;btnNotifySave&quot;&gt;LÆ°u subscriber&lt;/button&gt;
            &lt;button class=&quot;btn&quot; id=&quot;btnNotifyReset&quot;&gt;Reset&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;h4&gt;Danh sÃ¡ch Ä‘Äƒng kÃ½&lt;/h4&gt;
          &lt;p class=&quot;small&quot;&gt;Danh sÃ¡ch email/phÃ²ng ban sáº½ nháº­n cáº£nh bÃ¡o khi ECN thay Ä‘á»•i valid, effective, deadline... &lt;/p&gt;
          &lt;table class=&quot;table&quot; id=&quot;tblNotify&quot;&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th&gt;NgÆ°á»i nháº­n&lt;/th&gt;
                &lt;th&gt;Email&lt;/th&gt;
                &lt;th&gt;Bá»™ pháº­n&lt;/th&gt;
                &lt;th&gt;Sá»± kiá»‡n&lt;/th&gt;
                &lt;th&gt;KÃªnh&lt;/th&gt;
                &lt;th&gt;Táº§n suáº¥t&lt;/th&gt;
                &lt;th&gt;Thao tÃ¡c&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;&lt;/tbody&gt;
          &lt;/table&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;note small&quot;&gt;
        Sau nÃ y backend sáº½ dÃ¹ng danh sÃ¡ch nÃ y Ä‘á»ƒ gá»­i email/broadcast SignalR tá»›i Ä‘Ãºng ngÆ°á»i phá»¥ trÃ¡ch khi cÃ¡c job SAP/ValidDeadlineJob cáº­p nháº­t ECN.
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/section&gt;

  &lt;!-- INTEGRATIONS --&gt;
  &lt;section id=&quot;integrations&quot; class=&quot;view&quot;&gt;
    &lt;div class=&quot;card&quot;&gt;
      &lt;div class=&quot;grid2&quot;&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;h3&gt;Káº¿t ná»‘i pháº§n má»m&lt;/h3&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Loáº¡i pháº§n má»m&lt;/div&gt;
            &lt;select id=&quot;softType&quot;&gt;
              &lt;option value=&quot;SAP&quot;&gt;SAP&lt;/option&gt;
              &lt;option value=&quot;MES&quot;&gt;MES&lt;/option&gt;
              &lt;option value=&quot;DMS&quot;&gt;DMS&lt;/option&gt;
              &lt;option value=&quot;QMS&quot;&gt;QMS&lt;/option&gt;
              &lt;option value=&quot;Custom&quot;&gt;Custom&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;TÃªn hiá»ƒn thá»‹&lt;/div&gt;&lt;input id=&quot;displayName&quot; placeholder=&quot;VD: SAP S/4HANA / MES Nexus&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Base URL&lt;/div&gt;&lt;input id=&quot;baseUrl&quot; placeholder=&quot;https://example.company.com&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Auth&lt;/div&gt;
            &lt;select id=&quot;authType&quot;&gt;
              &lt;option&gt;API Key&lt;/option&gt;
              &lt;option&gt;Bearer token (OAuth2)&lt;/option&gt;
              &lt;option&gt;Basic Auth&lt;/option&gt;
              &lt;option&gt;None&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;

          &lt;div id=&quot;blockCommon&quot; class=&quot;kv&quot;&gt;&lt;div&gt;API Key / Token&lt;/div&gt;&lt;input id=&quot;apiToken&quot; placeholder=&quot;DÃ¡n API key hoáº·c token táº¡i Ä‘Ã¢y&quot;&gt;&lt;/div&gt;
          &lt;div id=&quot;blockBasic&quot; class=&quot;grid2 hidden&quot;&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Username&lt;/div&gt;&lt;input id=&quot;basicUser&quot; placeholder=&quot;user&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Password&lt;/div&gt;&lt;input id=&quot;basicPass&quot; placeholder=&quot;password&quot;&gt;&lt;/div&gt;
          &lt;/div&gt;
          &lt;div id=&quot;blockOAuth&quot; class=&quot;hidden&quot;&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Token URL&lt;/div&gt;&lt;input id=&quot;oauthTokenUrl&quot; placeholder=&quot;https://.../oauth/token&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;grid2&quot;&gt;
              &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Client ID&lt;/div&gt;&lt;input id=&quot;oauthClientId&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Client Secret&lt;/div&gt;&lt;input id=&quot;oauthClientSecret&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Scope&lt;/div&gt;&lt;input id=&quot;oauthScope&quot; placeholder=&quot;vd: openid profile&quot;&gt;&lt;/div&gt;
          &lt;/div&gt;

          &lt;div id=&quot;blockSAP&quot; class=&quot;hidden&quot;&gt;
            &lt;h4&gt;SAP (khuyáº¿n nghá»‹)&lt;/h4&gt;
            &lt;div class=&quot;grid3&quot;&gt;
              &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;System&lt;/div&gt;
                &lt;select id=&quot;sapSystem&quot;&gt;&lt;option&gt;S/4HANA&lt;/option&gt;&lt;option&gt;ECC&lt;/option&gt;&lt;option&gt;Business One&lt;/option&gt;&lt;/select&gt;
              &lt;/div&gt;
              &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Client&lt;/div&gt;&lt;input id=&quot;sapClient&quot; placeholder=&quot;Mandant vd 100&quot;&gt;&lt;/div&gt;
              &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Company&lt;/div&gt;&lt;input id=&quot;sapBukrs&quot; placeholder=&quot;BUKRS&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Plant&lt;/div&gt;&lt;input id=&quot;sapWerks&quot; placeholder=&quot;WERKS&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Endpoints&lt;/div&gt;
              &lt;textarea id=&quot;sapEndpoints&quot; placeholder=&quot;/sap/opu/odata/sap/ZECN_SRV/ECNSet&amp;#10;/sap/opu/odata/sap/ZWI_SRV/WISet&quot;&gt;&lt;/textarea&gt;
            &lt;/div&gt;
          &lt;/div&gt;

          &lt;div id=&quot;blockMES&quot; class=&quot;hidden&quot;&gt;
            &lt;h4&gt;MES&lt;/h4&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Line/Factory&lt;/div&gt;&lt;input id=&quot;mesFactory&quot; placeholder=&quot;VD: Line-2, Factory-A&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Webhook&lt;/div&gt;&lt;input id=&quot;mesHook&quot; placeholder=&quot;https://mes.../hooks/ecn&quot;&gt;&lt;/div&gt;
          &lt;/div&gt;

          &lt;div id=&quot;blockDMS&quot; class=&quot;hidden&quot;&gt;
            &lt;h4&gt;DMS&lt;/h4&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Library&lt;/div&gt;&lt;input id=&quot;dmsLib&quot; placeholder=&quot;ThÆ° viá»‡n tÃ i liá»‡u (vd: ECN)&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Folder&lt;/div&gt;&lt;input id=&quot;dmsFolder&quot; placeholder=&quot;/ECN/2025/&quot;&gt;&lt;/div&gt;
          &lt;/div&gt;

          &lt;div id=&quot;blockQMS&quot; class=&quot;hidden&quot;&gt;
            &lt;h4&gt;QMS&lt;/h4&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Module&lt;/div&gt;&lt;input id=&quot;qmsModule&quot; placeholder=&quot;vd: Deviation, CAPA&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Project&lt;/div&gt;&lt;input id=&quot;qmsProject&quot; placeholder=&quot;MÃ£ dá»± Ã¡n náº¿u cÃ³&quot;&gt;&lt;/div&gt;
          &lt;/div&gt;

          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Tráº¡ng thÃ¡i&lt;/div&gt;
            &lt;select id=&quot;connStatus&quot;&gt;&lt;option&gt;Connected&lt;/option&gt;&lt;option&gt;Stopped&lt;/option&gt;&lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Ghi chÃº&lt;/div&gt;&lt;textarea id=&quot;note&quot; placeholder=&quot;Má»¥c Ä‘Ã­ch káº¿t ná»‘i; bá»™ pháº­n chá»‹u trÃ¡ch nhiá»‡m; dá»¯ liá»‡u nÃ o sáº½ Ä‘á»“ng bá»™...&quot;&gt;&lt;/textarea&gt;&lt;/div&gt;

          &lt;div class=&quot;flex&quot; style=&quot;margin-top:10px&quot;&gt;
            &lt;button class=&quot;btn&quot; id=&quot;btnSaveInt&quot;&gt;LÆ°u káº¿t ná»‘i&lt;/button&gt;
            &lt;button class=&quot;btn&quot; id=&quot;btnTestInt&quot;&gt;Test káº¿t ná»‘i&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;card&quot;&gt;
          &lt;h3&gt;Danh sÃ¡ch Ä‘Ã£ káº¿t ná»‘i&lt;/h3&gt;
          &lt;table class=&quot;table&quot; id=&quot;intTable&quot;&gt;
            &lt;thead&gt;&lt;tr&gt;&lt;th&gt;Loáº¡i&lt;/th&gt;&lt;th&gt;TÃªn&lt;/th&gt;&lt;th&gt;URL&lt;/th&gt;&lt;th&gt;Auth&lt;/th&gt;&lt;th&gt;Tráº¡ng thÃ¡i&lt;/th&gt;&lt;th&gt;Thao tÃ¡c&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
            &lt;tbody&gt;&lt;/tbody&gt;
          &lt;/table&gt;
          &lt;div id=&quot;testResult&quot; class=&quot;small&quot; style=&quot;margin-top:8px&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;card&quot; style=&quot;margin-top:12px&quot;&gt;
        &lt;h3&gt;Ghi chÃº hÆ°á»›ng dáº«n&lt;/h3&gt;
        &lt;div id=&quot;helperNotes&quot; class=&quot;note&quot;&gt;&lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/section&gt;

  &lt;!-- API KEYS --&gt;
  &lt;section id=&quot;api&quot; class=&quot;view&quot;&gt;
    &lt;div class=&quot;card&quot;&gt;
      &lt;div class=&quot;badge&quot;&gt;Base URL (demo): &lt;span class=&quot;code&quot;&gt;https://ecn.local/api/v1/&lt;/span&gt;&lt;/div&gt;
      &lt;div class=&quot;grid2&quot; style=&quot;margin-top:12px&quot;&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;h3&gt;Táº¡o API Key (Ä‘Æ¡n giáº£n)&lt;/h3&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;App name&lt;/div&gt;&lt;input id=&quot;appName&quot; placeholder=&quot;VD: MES Connector&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Scope&lt;/div&gt;
            &lt;select id=&quot;scope&quot;&gt;&lt;option&gt;read&lt;/option&gt;&lt;option&gt;write&lt;/option&gt;&lt;option&gt;admin&lt;/option&gt;&lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Expire date&lt;/div&gt;&lt;input id=&quot;expire&quot; type=&quot;date&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;Status&lt;/div&gt;
            &lt;select id=&quot;status&quot;&gt;&lt;option&gt;Active&lt;/option&gt;&lt;option&gt;Revoked&lt;/option&gt;&lt;/select&gt;
          &lt;/div&gt;
          &lt;div class=&quot;kv&quot;&gt;&lt;div&gt;API Key&lt;/div&gt;&lt;span id=&quot;previewKey&quot; class=&quot;code&quot;&gt;chÆ°a táº¡o&lt;/span&gt;&lt;/div&gt;
          &lt;div class=&quot;flex&quot; style=&quot;margin-top:10px&quot;&gt;
            &lt;button class=&quot;btn&quot; id=&quot;btnGen&quot;&gt;Generate&lt;/button&gt;
            &lt;button class=&quot;btn&quot; id=&quot;btnSaveKey&quot;&gt;Save&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;h3&gt;Issued keys&lt;/h3&gt;
          &lt;table class=&quot;table&quot; id=&quot;keyTable&quot;&gt;
            &lt;thead&gt;&lt;tr&gt;&lt;th&gt;App&lt;/th&gt;&lt;th&gt;Key&lt;/th&gt;&lt;th&gt;Scope&lt;/th&gt;&lt;th&gt;Expire&lt;/th&gt;&lt;th&gt;Status&lt;/th&gt;&lt;th&gt;Actions&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
            &lt;tbody&gt;&lt;/tbody&gt;
          &lt;/table&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;small muted&quot; style=&quot;margin-top:8px&quot;&gt;Keys dÃ¹ng Ä‘á»ƒ app khÃ¡c gá»i API ECN. Scope â€œread/write/adminâ€ lÃ  3 má»©c phá»• biáº¿n.&lt;/div&gt;
    &lt;/div&gt;
  &lt;/section&gt;
&lt;/div&gt;

&lt;script&gt;
// Tabs
document.querySelectorAll(&#x27;.tab&#x27;).forEach(t=&gt;{
  t.addEventListener(&#x27;click&#x27;,()=&gt;{
    document.querySelectorAll(&#x27;.tab&#x27;).forEach(x=&gt;x.classList.remove(&#x27;active&#x27;));
    t.classList.add(&#x27;active&#x27;);
    document.querySelectorAll(&#x27;.view&#x27;).forEach(v=&gt;v.classList.remove(&#x27;active&#x27;));
    document.getElementById(t.dataset.tab).classList.add(&#x27;active&#x27;);
  });
});

// Storage helpers
const K_USERS=&#x27;ecn_users_tab_v1&#x27;, K_INT=&#x27;ecn_int_tab_v1&#x27;, K_KEY=&#x27;ecn_key_tab_v1&#x27;, K_JOB=&#x27;ecn_jobs_tab_v1&#x27;, K_NOTIFY=&#x27;ecn_notify_tab_v1&#x27;;
const read = (k)=&gt;JSON.parse(localStorage.getItem(k)||&#x27;[]&#x27;);
const write = (k,v)=&gt;localStorage.setItem(k, JSON.stringify(v));
function genKey(){const s=&#x27;ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789&#x27;;let o=&#x27;&#x27;;for(let i=0;i&lt;28;i++)o+=s[Math.floor(Math.random()*s.length)];return &#x27;ECN-&#x27;+o;}


// === Admin API helpers (DB-backed) ===
let gUsers = [];
let gJobs = [];
let gNotify = [];

const AdminApi = {
  getUsers: () =&gt; fetch(&#x27;/api/admin/users&#x27;).then(r =&gt; r.ok ? r.json() : Promise.reject()),
  addUser: (u) =&gt; fetch(&#x27;/api/admin/users&#x27;, {method:&#x27;POST&#x27;, headers:{&#x27;Content-Type&#x27;:&#x27;application/json&#x27;}, body:JSON.stringify(u)}).catch(()=&gt;{}),
  getJobs: () =&gt; fetch(&#x27;/api/admin/jobs&#x27;).then(r =&gt; r.ok ? r.json() : Promise.reject()),
  addJob: (j) =&gt; fetch(&#x27;/api/admin/jobs&#x27;, {method:&#x27;POST&#x27;, headers:{&#x27;Content-Type&#x27;:&#x27;application/json&#x27;}, body:JSON.stringify(j)}).catch(()=&gt;{}),
  getNotify: () =&gt; fetch(&#x27;/api/admin/notify&#x27;).then(r =&gt; r.ok ? r.json() : Promise.reject()),
  addNotify: (n) =&gt; fetch(&#x27;/api/admin/notify&#x27;, {method:&#x27;POST&#x27;, headers:{&#x27;Content-Type&#x27;:&#x27;application/json&#x27;}, body:JSON.stringify(n)}).catch(()=&gt;{})
};

// ===== USERS =====
const uSearch=document.getElementById(&#x27;uSearch&#x27;); let userFilter=&#x27;all&#x27;;
function renderUsers(){
  const tb=document.querySelector(&#x27;#tblUsers tbody&#x27;); tb.innerHTML=&#x27;&#x27;;
  const kw=(uSearch.value||&#x27;&#x27;).toLowerCase();
  gUsers.forEach((u,i)=&gt;{
    const byKw = (u.name||&#x27;&#x27;).toLowerCase().includes(kw) || (u.email||&#x27;&#x27;).toLowerCase().includes(kw) || (u.gid||&#x27;&#x27;).toLowerCase().includes(kw);
    const byChip = (userFilter===&#x27;all&#x27; || u.status===userFilter || u.dept===userFilter);
    if(byKw &amp;&amp; byChip){
      const tr=document.createElement(&#x27;tr&#x27;);
      tr.innerHTML=`&lt;td&gt;${u.name}&lt;/td&gt;&lt;td&gt;${u.gid||&#x27;&#x27;}&lt;/td&gt;&lt;td&gt;${u.email}&lt;/td&gt;&lt;td&gt;${u.dept}&lt;/td&gt;&lt;td&gt;${u.role}&lt;/td&gt;
        &lt;td&gt;&lt;span class=&quot;status ${u.status===&#x27;Active&#x27;?&#x27;s-ok&#x27;:&#x27;s-stop&#x27;}&quot;&gt;${u.status}&lt;/span&gt;&lt;/td&gt;
        &lt;td&gt;&lt;button class=&quot;btn sm&quot; onclick=&quot;editUser(${i})&quot;&gt;Edit&lt;/button&gt;
            &lt;button class=&quot;btn sm&quot; onclick=&quot;delUser(${i})&quot;&gt;Delete&lt;/button&gt;&lt;/td&gt;`;
      tb.appendChild(tr);
    }
  });
}
document.getElementById(&#x27;btnUserSave&#x27;).addEventListener(&#x27;click&#x27;,()=&gt;{
  const u={
    name:uName.value.trim(),
    gid:(uGlobal.value||&#x27;&#x27;).trim(),
    email:uEmail.value.trim(),
    dept:uDept.value,
    role:uRole.value,
    status:uStatus.value,
    note:uNote.value.trim()
  };
  if(!u.name||!u.gid){alert(&#x27;Nháº­p Há» tÃªn &amp; Global ID&#x27;); return;}
  gUsers.push(u); write(K_USERS,gUsers); renderUsers(); AdminApi.addUser(u);
});
document.getElementById(&#x27;btnUserReset&#x27;).addEventListener(&#x27;click&#x27;,()=&gt;{
  uName.value=&#x27;&#x27;; uGlobal.value=&#x27;&#x27;; uEmail.value=&#x27;&#x27;; uDept.value=&#x27;FE&#x27;; uRole.value=&#x27;Viewer&#x27;; uStatus.value=&#x27;Active&#x27;; uNote.value=&#x27;&#x27;;
});
document.querySelectorAll(&#x27;[data-u-filter]&#x27;).forEach(ch=&gt;{
  ch.addEventListener(&#x27;click&#x27;,()=&gt;{
    document.querySelectorAll(&#x27;[data-u-filter]&#x27;).forEach(x=&gt;x.classList.remove(&#x27;active&#x27;));
    ch.classList.add(&#x27;active&#x27;); userFilter=ch.dataset.uFilter; renderUsers();
  });
});
uSearch.addEventListener(&#x27;input&#x27;,renderUsers);
function editUser(i){
  const u=gUsers[i];
  uName.value=u.name||&#x27;&#x27;;
  uGlobal.value=u.gid||&#x27;&#x27;;
  uEmail.value=u.email||&#x27;&#x27;;
  uDept.value=u.dept||&#x27;FE&#x27;;
  uRole.value=u.role||&#x27;Viewer&#x27;;
  uStatus.value=u.status||&#x27;Active&#x27;;
  uNote.value=u.note||&#x27;&#x27;;
  arr.splice(i,1); write(K_USERS,arr); renderUsers();
}
function delUser(i){const a=gUsers; a.splice(i,1); write(K_USERS,a); renderUsers();}

function loadUsers(){
  AdminApi.getUsers().then(arr=&gt;{ gUsers=arr; write(K_USERS,gUsers); renderUsers(); }).catch(()=&gt;{ gUsers=read(K_USERS); renderUsers(); });
}



// ===== JOBS / SCHEDULERS =====
const jobType=document.getElementById(&#x27;jobType&#x27;);
const jobCustom=document.getElementById(&#x27;jobCustomName&#x27;);
const jobSource=document.getElementById(&#x27;jobSource&#x27;);
const jobFreq=document.getElementById(&#x27;jobFreq&#x27;);
const jobEnabled=document.getElementById(&#x27;jobEnabled&#x27;);
const jobNote=document.getElementById(&#x27;jobNote&#x27;);

function syncJobCustomVisibility(){
  if(!jobType || !jobCustom) return;
  const isCustom = jobType.value===&#x27;Custom&#x27;;
  jobCustom.parentElement.classList.toggle(&#x27;hidden&#x27;, !isCustom);
}

if(jobType){
  jobType.addEventListener(&#x27;change&#x27;, syncJobCustomVisibility);
  syncJobCustomVisibility();
}

function renderJobs(){
  const tb=document.querySelector(&#x27;#tblJobs tbody&#x27;);
  if(!tb) return;
  tb.innerHTML=&#x27;&#x27;;
  gJobs.forEach((j,i)=&gt;{
    const tr=document.createElement(&#x27;tr&#x27;);
    tr.innerHTML=`&lt;td&gt;${j.name}&lt;/td&gt;
      &lt;td&gt;${j.type}&lt;/td&gt;
      &lt;td&gt;${j.source||&#x27;&#x27;}&lt;/td&gt;
      &lt;td&gt;${j.schedule}&lt;/td&gt;
      &lt;td&gt;${j.last||&#x27;-&#x27;}&lt;/td&gt;
      &lt;td&gt;&lt;span class=&quot;status ${j.enabled===&#x27;On&#x27;?&#x27;s-ok&#x27;:&#x27;s-stop&#x27;}&quot;&gt;${j.enabled===&#x27;On&#x27;?&#x27;Enabled&#x27;:&#x27;Disabled&#x27;}&lt;/span&gt;&lt;/td&gt;
      &lt;td&gt;
        &lt;button class=&quot;btn sm btn-eq&quot; onclick=&quot;editJob(${i})&quot;&gt;Edit&lt;/button&gt;
        &lt;button class=&quot;btn sm btn-eq&quot; onclick=&quot;toggleJob(${i})&quot;&gt;${j.enabled===&#x27;On&#x27;?&#x27;Pause&#x27;:&#x27;Enable&#x27;}&lt;/button&gt;
        &lt;button class=&quot;btn sm btn-eq&quot; onclick=&quot;delJob(${i})&quot;&gt;Delete&lt;/button&gt;
      &lt;/td&gt;`;
    tb.appendChild(tr);
  });
}

function resetJobForm(){
  if(!jobType) return;
  jobType.value=&#x27;SAP Valid BOM Sync&#x27;;
  if(jobCustom){jobCustom.value=&#x27;&#x27;; jobCustom.parentElement.classList.add(&#x27;hidden&#x27;);}
  jobSource.value=&#x27;&#x27;;
  jobFreq.value=&#x27;&#x27;;
  jobEnabled.value=&#x27;On&#x27;;
  jobNote.value=&#x27;&#x27;;
}

document.getElementById(&#x27;btnJobSave&#x27;).addEventListener(&#x27;click&#x27;,()=&gt;{
  const baseType = jobType.value;
  let name = baseType;
  if(baseType===&#x27;Custom&#x27;){
    const customName = (jobCustom.value||&#x27;&#x27;).trim();
    if(!customName){alert(&#x27;Nháº­p TÃªn Job cho Custom&#x27;); return;}
    name = customName;
    // náº¿u chÆ°a cÃ³ thÃ¬ thÃªm vÃ o danh sÃ¡ch chá»n
    let exists = false;
    Array.from(jobType.options).forEach(o=&gt;{if(o.value===customName) exists=true;});
    if(!exists){
      const opt=document.createElement(&#x27;option&#x27;);
      opt.textContent=customName; opt.value=customName;
      jobType.appendChild(opt);
    }
  }
  const j={
    name,
    type:baseType,
    source:jobSource.value.trim(),
    schedule:jobFreq.value,
    enabled:jobEnabled.value,
    note:jobNote.value.trim(),
    last:&#x27;&#x27;
  };
  gJobs.push(j); write(K_JOB,gJobs); renderJobs(); AdminApi.addJob(j);
});

document.getElementById(&#x27;btnJobReset&#x27;).addEventListener(&#x27;click&#x27;,()=&gt;resetJobForm());

function editJob(i){
  const j=gJobs[i];
  if(jobType){
    // náº¿u lÃ  custom name khÃ´ng trÃ¹ng loáº¡i chuáº©n thÃ¬ set Custom vÃ  hiá»ƒn thá»‹ tÃªn
    if(j.type===&#x27;Custom&#x27;){
      jobType.value=&#x27;Custom&#x27;;
      if(jobCustom){jobCustom.value=j.name; jobCustom.parentElement.classList.remove(&#x27;hidden&#x27;);}
    }else{
      jobType.value=j.type;
      if(jobCustom){jobCustom.value=&#x27;&#x27;; jobCustom.parentElement.classList.add(&#x27;hidden&#x27;);}
    }
  }
  jobSource.value=j.source||&#x27;&#x27;;
  jobFreq.value=j.schedule||&#x27;&#x27;;
  jobEnabled.value=j.enabled||&#x27;On&#x27;;
  jobNote.value=j.note||&#x27;&#x27;;
  arr.splice(i,1); write(K_JOB,arr); renderJobs();
}

function toggleJob(i){
  const arr=read(K_JOB);
  arr[i].enabled = arr[i].enabled===&#x27;On&#x27; ? &#x27;Off&#x27; : &#x27;On&#x27;;
  write(K_JOB,arr); renderJobs();
}

function delJob(i){
  const arr=read(K_JOB); arr.splice(i,1); write(K_JOB,arr); renderJobs();
}

function loadJobs(){
  AdminApi.getJobs().then(arr=&gt;{ gJobs=arr; write(K_JOB,gJobs); renderJobs(); }).catch(()=&gt;{ gJobs=read(K_JOB); renderJobs(); });
}




// ===== NOTIFICATIONS / SUBSCRIPTIONS =====
const nName=document.getElementById(&#x27;nName&#x27;);
const nEmail=document.getElementById(&#x27;nEmail&#x27;);
const nDept=document.getElementById(&#x27;nDept&#x27;);
const nEvtValid=document.getElementById(&#x27;nEvtValid&#x27;);
const nEvtNew=document.getElementById(&#x27;nEvtNew&#x27;);
const nEvtDeadline=document.getElementById(&#x27;nEvtDeadline&#x27;);
const nEvtJobError=document.getElementById(&#x27;nEvtJobError&#x27;);
const nChannel=document.getElementById(&#x27;nChannel&#x27;);
const nFreq=document.getElementById(&#x27;nFreq&#x27;);
const nNote=document.getElementById(&#x27;nNote&#x27;);

function buildEventText(sub){
  const evts=[];
  if(sub.evtValid) evts.push(&#x27;Valid changed&#x27;);
  if(sub.evtNew) evts.push(&#x27;New effective&#x27;);
  if(sub.evtDeadline) evts.push(&#x27;Deadline coming&#x27;);
  if(sub.evtJobError) evts.push(&#x27;Job error&#x27;);
  return evts.join(&#x27;, &#x27;);
}

function renderNotify(){
  const tb=document.querySelector(&#x27;#tblNotify tbody&#x27;);
  if(!tb) return;
  tb.innerHTML=&#x27;&#x27;;
  gNotify.forEach((n,i)=&gt;{
    const tr=document.createElement(&#x27;tr&#x27;);
    tr.innerHTML=`&lt;td&gt;${n.name}&lt;/td&gt;
      &lt;td&gt;${n.email}&lt;/td&gt;
      &lt;td&gt;${n.dept}&lt;/td&gt;
      &lt;td&gt;${buildEventText(n)}&lt;/td&gt;
      &lt;td&gt;${n.channel}&lt;/td&gt;
      &lt;td&gt;${n.freq}&lt;/td&gt;
      &lt;td&gt;
        &lt;button class=&quot;btn sm&quot; onclick=&quot;editNotify(${i})&quot;&gt;Edit&lt;/button&gt;
        &lt;button class=&quot;btn sm&quot; onclick=&quot;delNotify(${i})&quot;&gt;Delete&lt;/button&gt;
      &lt;/td&gt;`;
    tb.appendChild(tr);
  });
}

function resetNotifyForm(){
  if(!nName) return;
  nName.value=&#x27;&#x27;;
  nEmail.value=&#x27;&#x27;;
  nDept.value=&#x27;FE&#x27;;
  nEvtValid.checked=true;
  nEvtNew.checked=true;
  nEvtDeadline.checked=false;
  nEvtJobError.checked=false;
  nChannel.value=&#x27;Popup + Email&#x27;;
  nFreq.value=&#x27;Real-time&#x27;;
  nNote.value=&#x27;&#x27;;
}

document.getElementById(&#x27;btnNotifySave&#x27;).addEventListener(&#x27;click&#x27;,()=&gt;{
  const name=(nName.value||&#x27;&#x27;).trim();
  const email=(nEmail.value||&#x27;&#x27;).trim();
  if(!name || !email){alert(&#x27;Nháº­p tÃªn &amp; email ngÆ°á»i nháº­n&#x27;); return;}
  const sub={
    name,
    email,
    dept:nDept.value,
    evtValid:nEvtValid.checked,
    evtNew:nEvtNew.checked,
    evtDeadline:nEvtDeadline.checked,
    evtJobError:nEvtJobError.checked,
    channel:nChannel.value,
    freq:nFreq.value,
    note:nNote.value.trim()
  };
  gNotify.push(sub); write(K_NOTIFY,gNotify); renderNotify(); AdminApi.addNotify(sub);
});

document.getElementById(&#x27;btnNotifyReset&#x27;).addEventListener(&#x27;click&#x27;,()=&gt;resetNotifyForm());

function editNotify(i){
  const n=gNotify[i];
  nName.value=n.name;
  nEmail.value=n.email;
  nDept.value=n.dept;
  nEvtValid.checked=!!n.evtValid;
  nEvtNew.checked=!!n.evtNew;
  nEvtDeadline.checked=!!n.evtDeadline;
  nEvtJobError.checked=!!n.evtJobError;
  nChannel.value=n.channel;
  nFreq.value=n.freq;
  nNote.value=n.note||&#x27;&#x27;;
  arr.splice(i,1); write(K_NOTIFY,arr); renderNotify();
}

function delNotify(i){
  const arr=read(K_NOTIFY); arr.splice(i,1); write(K_NOTIFY,arr); renderNotify();
}

function loadNotify(){
  AdminApi.getNotify().then(arr=&gt;{ gNotify=arr; write(K_NOTIFY,gNotify); renderNotify(); }).catch(()=&gt;{ gNotify=read(K_NOTIFY); renderNotify(); });
}



// ===== INTEGRATIONS =====
// ===== INTEGRATIONS =====
const helper=document.getElementById(&#x27;helperNotes&#x27;);
const typeSel=document.getElementById(&#x27;softType&#x27;);
const authSel=document.getElementById(&#x27;authType&#x27;);
const NOTES={
  SAP:`SAP:
- Base URL: https://sap.company.com
- Auth: Bearer (OAuth2) hoáº·c Basic
- Token URL/Client ID/Secret/Scope: dÃ¹ng khi láº¥y token OAuth2
- Client/Bukrs/Werks: Mandant/CÃ´ng ty/NhÃ  mÃ¡y Ä‘á»ƒ lá»c dá»¯ liá»‡u
- Endpoints: /sap/opu/odata/sap/ZECN_SRV/ECNSet ...`,
  MES:`MES:
- Base URL MES
- Auth: API Key/Bearer
- Webhook: MES gá»i ngÆ°á»£c khi bÃ n giao WI/lot`,
  DMS:`DMS:
- Base URL
- Library/Folder: cáº¥u trÃºc lÆ°u ECN/WI`,
  QMS:`QMS:
- Base URL
- Module/Project: Deviation/CAPA/Change Control`,
  Custom:`Custom: chá»n Auth phÃ¹ há»£p (hoáº·c None).`
};
function setVisible(id, show){document.getElementById(id).classList.toggle(&#x27;hidden&#x27;, !show);}
function refreshBlocks(){
  const t=typeSel.value;
  setVisible(&#x27;blockSAP&#x27;, t===&#x27;SAP&#x27;);
  setVisible(&#x27;blockMES&#x27;, t===&#x27;MES&#x27;);
  setVisible(&#x27;blockDMS&#x27;, t===&#x27;DMS&#x27;);
  setVisible(&#x27;blockQMS&#x27;, t===&#x27;QMS&#x27;);
  helper.textContent = NOTES[t] || NOTES.Custom;
  const a=authSel.value;
  setVisible(&#x27;blockCommon&#x27;, a===&#x27;API Key&#x27; || a===&#x27;Bearer token (OAuth2)&#x27;);
  setVisible(&#x27;blockBasic&#x27;, a===&#x27;Basic Auth&#x27;);
  setVisible(&#x27;blockOAuth&#x27;, a===&#x27;Bearer token (OAuth2)&#x27;);
}
typeSel.addEventListener(&#x27;change&#x27;,refreshBlocks);
authSel.addEventListener(&#x27;change&#x27;,refreshBlocks);
refreshBlocks();

function renderInts(){
  const tb=document.querySelector(&#x27;#intTable tbody&#x27;); tb.innerHTML=&#x27;&#x27;;
  read(K_INT).forEach((it,i)=&gt;{
    const tr=document.createElement(&#x27;tr&#x27;);
    tr.innerHTML=`&lt;td&gt;${it.type}&lt;/td&gt;&lt;td&gt;${it.name}&lt;/td&gt;&lt;td&gt;&lt;span class=&quot;code&quot;&gt;${it.url}&lt;/span&gt;&lt;/td&gt;&lt;td&gt;${it.auth}&lt;/td&gt;
      &lt;td&gt;&lt;span class=&quot;status ${it.status===&#x27;Connected&#x27;?&#x27;s-ok&#x27;:&#x27;s-stop&#x27;}&quot;&gt;${it.status}&lt;/span&gt;&lt;/td&gt;
      &lt;td&gt;&lt;button class=&quot;btn sm&quot; onclick=&quot;toggleInt(${i})&quot;&gt;${it.status===&#x27;Connected&#x27;?&#x27;Stop&#x27;:&#x27;Connect&#x27;}&lt;/button&gt;
          &lt;button class=&quot;btn sm&quot; onclick=&quot;delInt(${i})&quot;&gt;Delete&lt;/button&gt;&lt;/td&gt;`;
    tb.appendChild(tr);
  });
}
function toggleInt(i){const a=read(K_INT); a[i].status=a[i].status===&#x27;Connected&#x27;?&#x27;Stopped&#x27;:&#x27;Connected&#x27;; write(K_INT,a); renderInts();}
function delInt(i){const a=read(K_INT); a.splice(i,1); write(K_INT,a); renderInts();}

document.getElementById(&#x27;btnSaveInt&#x27;).addEventListener(&#x27;click&#x27;,()=&gt;{
  const it={
    type: typeSel.value,
    name: document.getElementById(&#x27;displayName&#x27;).value.trim() || typeSel.value,
    url: document.getElementById(&#x27;baseUrl&#x27;).value.trim(),
    auth: authSel.value,
    token: document.getElementById(&#x27;apiToken&#x27;).value.trim(),
    status: document.getElementById(&#x27;connStatus&#x27;).value,
    sap: (typeSel.value===&#x27;SAP&#x27;)? {
      system: document.getElementById(&#x27;sapSystem&#x27;).value,
      client: document.getElementById(&#x27;sapClient&#x27;).value,
      bukrs: document.getElementById(&#x27;sapBukrs&#x27;).value,
      werks: document.getElementById(&#x27;sapWerks&#x27;).value,
      endpoints: document.getElementById(&#x27;sapEndpoints&#x27;).value,
      oauth: (authSel.value===&#x27;Bearer token (OAuth2)&#x27;)? {
        tokenUrl: document.getElementById(&#x27;oauthTokenUrl&#x27;).value,
        clientId: document.getElementById(&#x27;oauthClientId&#x27;).value,
        clientSecret: document.getElementById(&#x27;oauthClientSecret&#x27;).value,
        scope: document.getElementById(&#x27;oauthScope&#x27;).value
      } : null
    } : null,
    mes: (typeSel.value===&#x27;MES&#x27;)? {factory: document.getElementById(&#x27;mesFactory&#x27;).value, hook: document.getElementById(&#x27;mesHook&#x27;).value} : null,
    dms: (typeSel.value===&#x27;DMS&#x27;)? {lib: document.getElementById(&#x27;dmsLib&#x27;).value, folder: document.getElementById(&#x27;dmsFolder&#x27;).value} : null,
    qms: (typeSel.value===&#x27;QMS&#x27;)? {module: document.getElementById(&#x27;qmsModule&#x27;).value, project: document.getElementById(&#x27;qmsProject&#x27;).value} : null
  };
  if(!it.url){alert(&#x27;Nháº­p Base URL&#x27;); return;}
  const arr=read(K_INT); arr.push(it); write(K_INT,arr); renderInts();
});
document.getElementById(&#x27;btnTestInt&#x27;).addEventListener(&#x27;click&#x27;,()=&gt;{
  document.getElementById(&#x27;testResult&#x27;).textContent = Math.random()&gt;0.2 ? &#x27;âœ… Káº¿t ná»‘i OK (mÃ´ phá»ng)&#x27; : &#x27;âŒ KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c (mÃ´ phá»ng)&#x27;;
});

// Seed integrations
if(read(K_INT).length===0){
  write(K_INT,[
    {type:&quot;SAP&quot;, name:&quot;SAP S/4HANA&quot;, url:&quot;https://sap.company.com&quot;, auth:&quot;Bearer token (OAuth2)&quot;, token:&quot;â€¢â€¢â€¢&quot;, status:&quot;Connected&quot;},
    {type:&quot;MES&quot;, name:&quot;MES Nexus&quot;, url:&quot;https://mes.company.com&quot;, auth:&quot;API Key&quot;, token:&quot;â€¢â€¢â€¢&quot;, status:&quot;Stopped&quot;}
  ]);
}
renderInts();

// ===== API KEYS =====
function renderKeys(){
  const tb=document.querySelector(&#x27;#keyTable tbody&#x27;); tb.innerHTML=&#x27;&#x27;;
  read(K_KEY).forEach((k,i)=&gt;{
    const tr=document.createElement(&#x27;tr&#x27;);
    tr.innerHTML=`&lt;td&gt;${k.app}&lt;/td&gt;&lt;td&gt;&lt;span class=&quot;code&quot;&gt;${k.key}&lt;/span&gt;&lt;/td&gt;&lt;td&gt;${k.scope}&lt;/td&gt;&lt;td&gt;${k.expire||&#x27;-&#x27;}&lt;/td&gt;
      &lt;td&gt;&lt;span class=&quot;status ${k.status===&#x27;Active&#x27;?&#x27;s-ok&#x27;:&#x27;s-stop&#x27;}&quot;&gt;${k.status}&lt;/span&gt;&lt;/td&gt;
      &lt;td&gt;&lt;button class=&quot;btn sm&quot; onclick=&quot;copyKey(&#x27;${k.key}&#x27;)&quot;&gt;Copy&lt;/button&gt;
          &lt;button class=&quot;btn sm&quot; onclick=&quot;toggleKey(${i})&quot;&gt;${k.status===&#x27;Active&#x27;?&#x27;Revoke&#x27;:&#x27;Enable&#x27;}&lt;/button&gt;
          &lt;button class=&quot;btn sm&quot; onclick=&quot;delKey(${i})&quot;&gt;Delete&lt;/button&gt;&lt;/td&gt;`;
    tb.appendChild(tr);
  });
}
function copyKey(v){navigator.clipboard.writeText(v); alert(&#x27;Copied&#x27;);}
function toggleKey(i){const a=read(K_KEY); a[i].status=a[i].status===&#x27;Active&#x27;?&#x27;Revoked&#x27;:&#x27;Active&#x27;; write(K_KEY,a); renderKeys();}
function delKey(i){const a=read(K_KEY); a.splice(i,1); write(K_KEY,a); renderKeys();}

document.getElementById(&#x27;btnGen&#x27;).addEventListener(&#x27;click&#x27;,()=&gt;{document.getElementById(&#x27;previewKey&#x27;).textContent=genKey();});
document.getElementById(&#x27;btnSaveKey&#x27;).addEventListener(&#x27;click&#x27;,()=&gt;{
  const app=document.getElementById(&#x27;appName&#x27;).value.trim(); if(!app){alert(&#x27;Nháº­p App name&#x27;);return;}
  const scope=document.getElementById(&#x27;scope&#x27;).value; const status=document.getElementById(&#x27;status&#x27;).value; const expire=document.getElementById(&#x27;expire&#x27;).value;
  const key=document.getElementById(&#x27;previewKey&#x27;).textContent.includes(&#x27;ECN-&#x27;)?document.getElementById(&#x27;previewKey&#x27;).textContent:genKey();
  const arr=read(K_KEY); arr.push({app,scope,expire,status,key}); write(K_KEY,arr); renderKeys(); alert(&#x27;Saved&#x27;);
});

if(read(K_KEY).length===0){write(K_KEY,[{app:&quot;MES Connector&quot;, key:genKey(), scope:&quot;read&quot;, expire:&quot;&quot;, status:&quot;Active&quot;}]);}
renderKeys();

// Initial load from API (fallback to localStorage if API not ready)
loadUsers();
resetJobForm();
loadJobs();
resetNotifyForm();
loadNotify();
&lt;/script&gt;
"></iframe></div>
</section>
      <section class="card">
        <div class="head"><strong>User Management</strong></div>
        <div class="body">
          <div class="filters">
            <input id="uName" placeholder="Há» vÃ  TÃªn" /><input id="uEmail" placeholder="Email" /><input id="uID" placeholder="ID" />
            <select id="uDept"><option>SMT</option><option>DIP</option><option>FA</option><option>FE</option><option>PE</option><option>QC</option><option>PMS</option><option>PSCD</option><option>COS</option></select>
            <select id="uRole"><option>Viewer</option><option>Editor</option><option>Approver</option><option>Admin</option></select>
            <button class="btn" id="uAdd">Add</button>
          </div>
          <div style="overflow:auto;margin-top:8px">
            <table>
              <thead><tr class="taskbar"><th>Há» vÃ  TÃªn</th><th>Email</th><th>ID</th><th>Department</th><th>Role</th><th>Delete</th></tr></thead>
              <tbody id="uRows"></tbody>
            </table>
          </div>
          <!-- AI Advisor prompt config -->
          <div class="head" style="border:none;padding-left:0;margin-top:8px"><strong>ECN AI Advisor â€” Prompt</strong></div>
          <textarea id="aiPrompt" placeholder="System prompt for ECN Advisor (guidelines, tone, rules)..." style="min-height:80px"></textarea>
          <button class="btn" id="savePrompt" style="margin-top:6px">Save Prompt</button>
        </div>
      </section>
    </section>

    <!-- CHATROOM -->
    <section id="page-chatroom" class="grid hidden">
      <section class="card">
        <div class="head"><strong>Team Chat</strong></div>
        <div class="body">
          <div id="chatLog" style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;min-height:180px;max-height:280px;overflow:auto"></div>
          <div class="chat-sender" id="chatHint">Demo: team messages appear hereâ€¦</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <textarea id="chatTxt" placeholder="Type a message..." style="flex:1;min-height:42px"></textarea>
            <button class="btn" id="chatSend">Send</button>
          </div>
        </div>
      </section>
    </section>

    <!-- CONVERT BOM -->
    <section id="page-convertBOM" class="grid hidden">
      <section class="card">
        <div class="head"><strong>Convert BOM (CSV)</strong></div>
        <div class="body">
          <div class="filters">
            <input type="file" id="bomFile" accept=".csv,.tsv,.txt" /><button class="btn secondary" id="bomParse">Parse File</button>
            <div class="spacer"></div><button class="btn" id="bomDownload">Download Normalized CSV</button>
          </div>
          <div style="margin-top:8px" class="label">Or paste CSV below:</div>
          <textarea id="bomPaste" placeholder="PartNo, Description, Qty, RefDes"></textarea>
          <div id="bomOutWrap" style="margin-top:10px;overflow:auto">
            <table id="bomOut" style="min-width:720px">
              <thead><tr class="taskbar"><th>PartNo</th><th>Description</th><th>Qty</th><th>RefDes</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </section>

    <!-- WI VERIFY -->
    <section id="page-wiVerify" class="grid hidden">
<!-- Integrated WI_Verify Module (Temp).html via iframe -->
<div style="height:72vh;max-height:calc(100dvh - 160px);"><iframe title="WI Verify Module" id="wiFrame" style="width:100%;height:100%;border:0;border-radius:12px;background:#fff" srcdoc="
<meta charset=&quot;utf-8&quot;/><meta content=&quot;width=device-width, initial-scale=1&quot; name=&quot;viewport&quot;/>
<title>WI Verify â€” Rev3m Debug</title>
<style>
:root{
  --bg:#f6f8fc;--panel:#fff;--text:#0f172a;--border:#e5e7eb;--shadow:0 10px 30px rgba(2,6,23,.10);
  --primary:#0ea5e9;--primary-600:#0284c7;--hdr-grad:linear-gradient(135deg,#0ea5e9 0%,#3b82f6 45%,#1d4ed8 80%,#0b154a 100%);
}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#fafcff 0%,var(--bg) 60%);color:#0f172a}
main{max-width:1120px;margin:12px auto;padding:0 12px 18px;display:grid;gap:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
.card .head{padding:8px 10px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.card .body{padding:10px}
.btn{border:1px solid var(--primary);color:#fff;background:linear-gradient(180deg,var(--primary),var(--primary-600));padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700;font-size:12.5px;box-shadow:0 4px 12px rgba(14,165,233,.25)}
.btn.secondary{border-color:var(--border);background:#fff;color:#0f172a} input[type=file]{display:none} .spacer{flex:1}
.tag{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px}
.proglbl{font-size:12px;color:#475569;margin-bottom:4px;display:flex;justify-content:space-between}
.progwrap{margin:6px 0;background:#eef2f7;border:1px solid #e2e8f0;border-radius:999px;height:8px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.05)}
.progbar{height:100%;width:0%;background:linear-gradient(90deg,#06b6d4,#3b82f6);transition:width .2s ease}

/* Slimmer header */
.hdrband{display:grid;grid-template-columns:1.2fr .7fr 2.5fr 2.5fr 2.5fr .8fr;gap:8px;background:var(--hdr-grad);color:#fff;
  padding:6px 8px;border-radius:10px;box-shadow:inset 0 -1px 0 rgba(255,255,255,.22),0 6px 12px rgba(2,6,23,.14)}
.h-title{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.28);
  border-radius:8px;padding:4px 6px;font-weight:800;backdrop-filter:blur(1.5px)}
.h-group{display:grid;grid-template-rows:auto auto;gap:6px;border:1px solid rgba(255,255,255,.3);border-radius:9px;padding:4px 6px;
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.05));box-shadow:inset 0 1px 0 rgba(255,255,255,.3)}
.h-group .top{font-weight:900;text-align:center;text-shadow:0 1px 1px rgba(0,0,0,.25)}
.h-group .sub{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.h-sub{display:flex;align-items:center;justify-content:center;border:1px dashed rgba(255,255,255,.35);border-radius:8px;padding:4px 6px;font-weight:700}

/* Rows */
.rows{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.row-card{display:grid;grid-template-columns:1.2fr .7fr 1.25fr 1.25fr 1.25fr 1.25fr 1.25fr 1.25fr .8fr;gap:8px;align-items:center;background:#fff;
  border:1px solid #e8ecf3;border-radius:12px;box-shadow:0 4px 12px rgba(2,6,23,.06);padding:8px 10px;overflow:hidden}
.cell{font-size:12px;line-height:1.2;display:flex;align-items:center;justify-content:center;min-height:26px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mono{font-family:ui-monospace,Menlo,monospace}
.bad{color:#dc2626;text-decoration:underline wavy #dc2626 1px}
.soft{background:#fff7d1;border-radius:6px;padding:1px 4px}

/* Result pill bigger */
.pill{display:inline-flex;align-items:center;justify-content:center;padding:3px 10px;border-radius:999px;font-size:14px;font-weight:700;border:1px solid var(--border);min-width:40px}
.pill.ok{background:#eafff1;color:#065f46;border-color:#a7f3d0}
.pill.ng{background:#ffecec;color:#7f1d1d;border-color:#fecaca}

/* Debug */
.tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);padding:6px 10px;background:#fff;position:sticky;top:0;z-index:1}
.tab{padding:6px 10px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#f8fafc;cursor:pointer;font-weight:700;font-size:12px}
.tab.active{background:#fff;border-color:#cbd5e1}
.debugWrap{display:none}
.debugWrap.active{display:block}
.table{width:100%;border-collapse:separate;border-spacing:0 6px}
.table th,.table td{font-size:12px;text-align:left;padding:8px 10px;background:#fff;border:1px solid #e8ecf3}
.table th{background:#f1f5f9}
.small{font-size:11px;color:#475569}
.badge{display:inline-block;padding:2px 6px;border:1px solid #cbd5e1;border-radius:999px;font-size:11px;background:#f8fafc}
.kv{display:grid;grid-template-columns:140px 1fr;gap:6px;margin:8px 0}
pre.snip{white-space:pre-wrap;word-break:break-word;background:#f8fafc;border:1px dashed #e2e8f0;padding:8px;border-radius:8px;max-height:120px;overflow:auto}
</style>
<main>
<section class=&quot;card&quot;>
<div class=&quot;head&quot;>
<label class=&quot;btn secondary&quot; for=&quot;wiFolder&quot;>ðŸ“ Chá»n WI Revision Folder</label>
<input accept=&quot;.pdf,.xlsx,.xls&quot; directory=&quot;&quot; id=&quot;wiFolder&quot; multiple=&quot;&quot; type=&quot;file&quot; webkitdirectory=&quot;&quot;/>
<label class=&quot;btn secondary&quot; for=&quot;ecnFile&quot;>ðŸ“„ Chá»n ECN Master File (.xlsx)</label>
<input accept=&quot;.xlsx,.xls&quot; id=&quot;ecnFile&quot; type=&quot;file&quot;/>
<button class=&quot;btn&quot; id=&quot;btnCompare&quot;>ðŸ”Ž Compare</button>
<button class=&quot;btn&quot; id=&quot;btnExport&quot;>â¬‡ï¸ Export Excel File</button>
<button class=&quot;btn secondary&quot; id=&quot;btnSamples&quot;>ðŸ”„ Load 15 Sample Rows</button>
<button class=&quot;btn secondary&quot; id=&quot;btnDebug&quot;>ðŸž Debug Panel</button>
<div class=&quot;spacer&quot;></div><span class=&quot;tag&quot; id=&quot;badgeWI&quot;>WI: 0</span><span class=&quot;tag&quot; id=&quot;badgeECN&quot;>ECN: 0</span>
</div>
<div class=&quot;body&quot;>
<div class=&quot;proglbl&quot;><span id=&quot;progText&quot;>Sáºµn sÃ ng so sÃ¡nh.</span><span id=&quot;progPct&quot;></span></div>
<div class=&quot;progwrap&quot;><div class=&quot;progbar&quot; id=&quot;progBar&quot;></div></div>
<div class=&quot;hdrband&quot;>
<div class=&quot;h-title&quot;>Model</div>
<div class=&quot;h-title&quot;>WI Page</div>
<div class=&quot;h-group&quot;>
<div class=&quot;top&quot;>Before</div>
<div class=&quot;sub&quot;><div class=&quot;h-sub&quot;>WI</div><div class=&quot;h-sub&quot;>ECN</div></div>
</div>
<div class=&quot;h-group&quot;>
<div class=&quot;top&quot;>After</div>
<div class=&quot;sub&quot;><div class=&quot;h-sub&quot;>WI</div><div class=&quot;h-sub&quot;>ECN</div></div>
</div>
<div class=&quot;h-group&quot;>
<div class=&quot;top&quot;>Valid Date</div>
<div class=&quot;sub&quot;><div class=&quot;h-sub&quot;>WI</div><div class=&quot;h-sub&quot;>ECN</div></div>
</div>
<div class=&quot;h-title&quot;>Result</div>
</div>
<div class=&quot;rows&quot; id=&quot;rows&quot;></div>
</div>
</section>
<section class=&quot;card debugWrap&quot; id=&quot;debugWrap&quot;>
<div class=&quot;tabs&quot;>
<div class=&quot;tab active&quot; data-tab=&quot;tabWI&quot;>WI Parsed</div>
<div class=&quot;tab&quot; data-tab=&quot;tabECN&quot;>ECN Mapping</div>
<div class=&quot;tab&quot; data-tab=&quot;tabREASON&quot;>Reasons / Errors</div>
</div>
<div class=&quot;body&quot;>
<div class=&quot;debugWrap active&quot; id=&quot;tabWI&quot;>
<table class=&quot;table&quot; id=&quot;tblWI&quot;>
<thead><tr><th>File</th><th>ECN no.</th><th>Model</th><th>WI Page</th><th>Before (WI)</th><th>After (WI)</th><th>Valid (WI)</th><th>Notes</th></tr></thead>
<tbody></tbody>
</table>
</div>
<div class=&quot;debugWrap&quot; id=&quot;tabECN&quot;>
<table class=&quot;table&quot; id=&quot;tblECN&quot;>
<thead><tr><th>Model</th><th>Matched?</th><th>Before (ECN)</th><th>After (ECN)</th><th>Valid (ECN)</th><th>Candidate Count</th><th>Score</th></tr></thead>
<tbody></tbody>
</table>
</div>
<div class=&quot;debugWrap&quot; id=&quot;tabREASON&quot;>
<div id=&quot;reasons&quot;></div>
</div>
</div>
</section>
</main>
<script src=&quot;https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js&quot;></script>
<script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js&quot;></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
<script>
const SAMPLE_ROWS = [{&quot;model&quot;: &quot;VL-MZ35-K01&quot;, &quot;page&quot;: &quot;H1&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1100ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1100ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2200YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2200YA&quot;, &quot;validWI&quot;: &quot;2025-09-01&quot;, &quot;validM&quot;: &quot;2025-09-01&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K02&quot;, &quot;page&quot;: &quot;H2&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1101ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1101ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2201YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2201YA&quot;, &quot;validWI&quot;: &quot;2025-09-02&quot;, &quot;validM&quot;: &quot;2025-09-02&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K03&quot;, &quot;page&quot;: &quot;H3&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1102ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1102ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2202YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2202YA&quot;, &quot;validWI&quot;: &quot;2025-09-03&quot;, &quot;validM&quot;: &quot;2025-09-03&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K04&quot;, &quot;page&quot;: &quot;H4&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1103ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1103ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2203YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2203YA&quot;, &quot;validWI&quot;: &quot;2025-09-04&quot;, &quot;validM&quot;: &quot;2025-09-04&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K05&quot;, &quot;page&quot;: &quot;H5&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1104ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1104ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2204YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2204YA&quot;, &quot;validWI&quot;: &quot;2025-09-05&quot;, &quot;validM&quot;: &quot;2025-09-05&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K06&quot;, &quot;page&quot;: &quot;H6&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1105ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1105ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2205YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2205YA&quot;, &quot;validWI&quot;: &quot;2025-09-06&quot;, &quot;validM&quot;: &quot;2025-09-06&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K07&quot;, &quot;page&quot;: &quot;H7&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1106ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1106ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2206YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2206YA&quot;, &quot;validWI&quot;: &quot;2025-09-07&quot;, &quot;validM&quot;: &quot;2025-09-07&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K08&quot;, &quot;page&quot;: &quot;H8&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1107ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1107ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2207YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2207YA&quot;, &quot;validWI&quot;: &quot;2025-09-08&quot;, &quot;validM&quot;: &quot;2025-09-08&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K09&quot;, &quot;page&quot;: &quot;H9&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1108ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1108ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2208YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2208YB&quot;, &quot;validWI&quot;: &quot;2025-09-09&quot;, &quot;validM&quot;: &quot;2025-09-09&quot;, &quot;result&quot;: &quot;NG&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K10&quot;, &quot;page&quot;: &quot;H10&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1109ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1109ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2209YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2209YA&quot;, &quot;validWI&quot;: &quot;2025-09-10&quot;, &quot;validM&quot;: &quot;2025-09-10&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K11&quot;, &quot;page&quot;: &quot;H11&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1110ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1110ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2210YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2210YA&quot;, &quot;validWI&quot;: &quot;2025-09-11&quot;, &quot;validM&quot;: &quot;2025-09-11&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K12&quot;, &quot;page&quot;: &quot;H12&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1111ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1111ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2211YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2211YA&quot;, &quot;validWI&quot;: &quot;2025-09-12&quot;, &quot;validM&quot;: &quot;2025-09-12&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K13&quot;, &quot;page&quot;: &quot;H13&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1112ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1112ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2212YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2212YA&quot;, &quot;validWI&quot;: &quot;2025-09-13&quot;, &quot;validM&quot;: &quot;2025-09-13&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K14&quot;, &quot;page&quot;: &quot;H14&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1113ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1113ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2213YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2213YA&quot;, &quot;validWI&quot;: &quot;2025-09-14&quot;, &quot;validM&quot;: &quot;2025-09-14&quot;, &quot;result&quot;: &quot;OK&quot;}, {&quot;model&quot;: &quot;VL-MZ35-K15&quot;, &quot;page&quot;: &quot;H15&quot;, &quot;beforeWI&quot;: &quot;99-PNHR1114ZA&quot;, &quot;beforeM&quot;: &quot;99-PNHR1114ZA&quot;, &quot;afterWI&quot;: &quot;99-PNHR2214YA&quot;, &quot;afterM&quot;: &quot;99-PNHR2214YA&quot;, &quot;validWI&quot;: &quot;2025-09-15&quot;, &quot;validM&quot;: &quot;2025-09-15&quot;, &quot;result&quot;: &quot;OK&quot;}];

let WI_FILES=[], ECN_MASTER=[], RESULTS=[], DIAG={wi:[], ecn:[], reasons:[]};
const CODE_RE=/\b[A-Z0-9][A-Z0-9\-](2,)\b/g;
const PNHR_RE=/\bPNHR\d(3, 6)[A-Z](1, 2)\b/i;
const PAGE_RE=/\b(H\d(1, 3)|Page\s*[:ï¼š]?\s*[A-Z]?\d(1, 3))\b/i;
function clean(v){return String(v||'').trim().replace(/\s+/g,' ');}
function normalizeDate(s){if(!s) return '';const dp1=/\b(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})\b/;const dp2=/\b(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})\b/;
 const m2=s.match(dp2);if(m2){const y=m2[1],mo=(''+m2[2]).padStart(2,'0'),d=(''+m2[3]).padStart(2,'0');return `${y}-${mo}-${d}`;} 
 const m1=s.match(dp1);if(m1){const d=(''+m1[1]).padStart(2,'0'),mo=(''+m1[2]).padStart(2,'0');const y=(m1[3].length===2?('20'+m1[3]):m1[3]);return `${y}-${mo}-${d}`;} return s;}
function findValid(tokens){const s=tokens.join(' ');const m=s.match(/(?:Valid|Effective|NgÃ y Ã¡p dá»¥ng|Ãp dá»¥ng)[^0-9]{0,12}((?:\d{4}[\/-]\d{1,2}[\/-]\d{1,2})|(?:\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}))/i);return normalizeDate(m?m[1]:'');}
function clampCodes(s){const list=(s.match(CODE_RE)||[]).filter(x=>x.length<=24);const pn=list.filter(x=>PNHR_RE.test(x));return (pn.length?pn:list).slice(0,8).join(' | ');}

function extractWI(text){
  const out={model:'',page:'',before:'',after:'',valid:''};
  const tokens=text.split(/\s+/);
  let m=text.match(/([A-Za-z0-9\-]+)\s*\*?\s*Series/i);
  if(m) out.model=m[0];
  if(!out.model){ m=text.match(/\b([A-Za-z0-9\-]+(?:\/[A-Za-z0-9\-]+)+)\b/); if(m) out.model=m[1]; }
  if(!out.model){ m=text.match(/\bModel[:ï¼š]?\s*([A-Za-z0-9\-_/]+)/i); if(m) out.model=m[1]; }
  m=text.match(PAGE_RE); if(m){ out.page=m[1].replace(/Page[:ï¼š]?\s*/i,'').toUpperCase(); }
  let p=text.match(/Before\s*[:ï¼š]?\s*([A-Z0-9\-\/\s\|,;]+?)(?:\.|,|;|\n|After|â†’|->)/i);
  let a=text.match(/(?:After|â†’|->)\s*[:ï¼š]?\s*([A-Z0-9\-\/\s\|,;]+)/i);
  if(p) out.before=clampCodes(p[1]);
  if(a) out.after=clampCodes(a[1]);
  if(!out.before || !out.after){
    const arrow=text.match(/([A-Z0-9][A-Z0-9\-]{2,})\s*(?:â†’|->)\s*([A-Z0-9][A-Z0-9\-]{2,})/);
    if(arrow){ out.before=arrow[1]; out.after=arrow[2]; }
  }
  out.valid=findValid(tokens);
  return out;
}

function diffChars(a,b){a=String(a||'');b=String(b||'');const outA=[],outB=[];const n=Math.max(a.length,b.length);
 for(let i=0;i<n;i++){const ca=a[i]||'',cb=b[i]||'';if(ca===cb){outA.push(ca);outB.push(cb);} else {outA.push(`<span class='bad'>${ca||'âˆ…'}</span>`);outB.push(`<span class='bad'>${cb||'âˆ…'}</span>`);}} 
 return {a:`<span class='mono'>${outA.join('')}</span>`,b:`<span class='mono'>${outB.join('')}</span>`};}
function splitOrList(s){const t=clean(s).replace(/\s*(?:or|OR|hoáº·c)\s*/g,'|');return [...new Set(t.split(/[\|\/;,ã€]+/).map(x=>x.trim()).filter(Boolean))];}
function renderValueOrListDiff(wiVal,mVal){const L=splitOrList(wiVal),R=splitOrList(mVal);
  if(L.length<=1 && R.length<=1){const d=diffChars(wiVal,mVal);return {htmlL:d.a,htmlR:d.b,ok:wiVal===mVal};} 
  const miss=L.filter(x=>!R.includes(x)); const ok=miss.length===0 && R.length>0;
  const fmtL=L.map(x=> miss.includes(x)?`<span class=&quot;bad&quot;>${x}</span>`:x).join(' | ');
  const fmtR=R.join(' | ');
  return {htmlL:`<span class=&quot;mono&quot;>${fmtL}</span>`, htmlR:`<span class=&quot;mono&quot;>${fmtR}</span>`, ok};
}

function renderRow(r){
  const row=document.createElement('div');row.className='row-card';
  const beforeD=diffChars(r.beforeWI,r.beforeM);
  const afterD=renderValueOrListDiff(r.afterWI,r.afterM);
  const validD=diffChars(r.validWI,r.validM);
  const okAll=(r.beforeWI===r.beforeM)&&afterD.ok&&(r.validWI===r.validM);
  const pill=okAll?'<span class=&quot;pill ok&quot;>OK</span>':'<span class=&quot;pill ng&quot;>NG</span>'; const mark=(ok)=> ok? '':'soft';
  row.innerHTML=`
    <div class='cell mono' title='${r.model||&quot;-&quot;}'>${r.model||&quot;-&quot;}</div>
    <div class='cell mono' title='${r.page||&quot;-&quot;}'>${r.page||&quot;-&quot;}</div>
    <div class='cell ${mark(r.beforeWI===r.beforeM)}' title='${r.beforeWI}'>${beforeD.a}</div>
    <div class='cell ${mark(r.beforeWI===r.beforeM)}' title='${r.beforeM}'>${beforeD.b}</div>
    <div class='cell ${mark(afterD.ok)}' title='${r.afterWI}'>${afterD.htmlL}</div>
    <div class='cell ${mark(afterD.ok)}' title='${r.afterM}'>${afterD.htmlR}</div>
    <div class='cell ${mark(r.validWI===r.validM)}' title='${r.validWI}'>${validD.a}</div>
    <div class='cell ${mark(r.validWI===r.validM)}' title='${r.validM}'>${validD.b}</div>
    <div class='cell'>${pill}</div>`; 
  return row;
}
function renderAll(rows){const wrap=document.getElementById('rows'); wrap.innerHTML=''; rows.forEach(r=> wrap.appendChild(renderRow(r)));}

function addDiagWI(file, wi, note, rawSnippet){DIAG.wi.push({file, ...wi, note, rawSnippet});}
function addDiagECN(model, matched, m, candCount, score){DIAG.ecn.push({model, matched, before:m?.before||'', after:m?.after||'', valid:m?.valid||'', candCount, score});}
function addReason(idx, title, detail){DIAG.reasons.push({idx, title, detail});}
function renderDebug(){const tb1=document.querySelector('#tblWI tbody'); tb1.innerHTML='';
  DIAG.wi.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.file||'-'}</td><td>${r.model||'-'}</td><td>${r.page||'-'}</td><td class='mono'>${r.before||'-'}</td><td class='mono'>${r.after||'-'}</td><td>${r.valid||'-'}</td><td class='small'>${r.note||''}${r.rawSnippet?`<div><details><summary class='badge'>raw</summary><pre class='snip'>${r.rawSnippet}</pre></details></div>`:''}</td>`; tb1.appendChild(tr);});
  const tb2=document.querySelector('#tblECN tbody'); tb2.innerHTML='';
  DIAG.ecn.forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.model||'-'}</td><td>${r.matched? 'Yes':'No'}</td><td class='mono'>${r.before||'-'}</td><td class='mono'>${r.after||'-'}</td><td>${r.valid||'-'}</td><td>${r.candCount||0}</td><td>${r.score||0}</td>`; tb2.appendChild(tr);});
  const rz=document.getElementById('reasons'); rz.innerHTML='';
  DIAG.reasons.forEach((r,i)=>{const div=document.createElement('div'); div.className='kv'; div.innerHTML=`<div><span class='badge'>Row #${r.idx+1}</span></div><div><b>${r.title}</b><div class='small'>${r.detail||''}</div></div>`; rz.appendChild(div);});
}
document.getElementById('btnDebug').addEventListener('click', ()=>{const wrap=document.getElementById('debugWrap'); wrap.classList.toggle('active'); if(wrap.classList.contains('active')) renderDebug();});
document.querySelectorAll('.tabs .tab').forEach(t=>{t.addEventListener('click', ()=>{document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const target=t.getAttribute('data-tab'); document.querySelectorAll('#debugWrap .debugWrap').forEach(x=>x.classList.remove('active')); document.getElementById(target).classList.add('active');});});

// Loaders
document.getElementById('wiFolder').addEventListener('change',(e)=>{WI_FILES=Array.from(e.target.files||[]).filter(f=>/\.(pdf|xlsx?|xls)$/i.test(f.name)); document.getElementById('badgeWI').textContent=`WI: ${WI_FILES.length}`;});
document.getElementById('ecnFile').addEventListener('change', async (e)=>{const f=e.target.files?.[0]; if(!f) return; const buf=await f.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'});
  const ws=wb.Sheets[wb.SheetNames[0]]; const arr=XLSX.utils.sheet_to_json(ws,{header:1,defval:''}); if(!arr.length) return;
  const H=arr[0].map(v=>String(v||'')); const idx={model:-1,before:-1,after:-1,valid:-1};
  H.forEach((h,i)=>{const s=h.toLowerCase(); if(idx.model<0 && s.includes('model')) idx.model=i; if(idx.before<0 && s.includes('before')) idx.before=i;
                    if(idx.after<0 && s.includes('after')) idx.after=i; if(idx.valid<0 && (s.includes('valid')||s.includes('effective')||s.includes('Ã¡p dá»¥ng'))) idx.valid=i;});
  ECN_MASTER=[]; for(let i=1;i<arr.length;i++){const r=arr[i]; ECN_MASTER.push({model: clean(r[idx.model]||''), before: clean(r[idx.before]||''), after: clean(r[idx.after]||''), valid: normalizeDate(clean(r[idx.valid]||''))});}
  document.getElementById('badgeECN').textContent=`ECN: ${ECN_MASTER.length}`;});

// Parsers
async function parseWIPDF(file){const buf=await file.arrayBuffer(); const pdf=await pdfjsLib.getDocument({data:buf}).promise; let text='';
  for(let p=1;p<=pdf.numPages;p++){const page=await pdf.getPage(p); const c=await page.getTextContent(); const seg=c.items.map(i=>i.str).join(' '); text+=' '+seg;} const wi=extractWI(text); return {wi, raw:text.slice(0,800)};}
async function parseWIXLSX(file){const buf=await file.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'}); let text='';
  wb.SheetNames.forEach(name=>{const ws=wb.Sheets[name]; const arr=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,defval:''}); if(arr&&arr.length) text+=' '+arr.map(r=>r.join(' ')).join('\n');});
  const wi=extractWI(text); return {wi, raw:text.slice(0,800)};}

// Samples & Compare
document.getElementById('btnSamples').addEventListener('click', ()=>{RESULTS=SAMPLE_ROWS.map(s=>({...s})); DIAG={wi:[], ecn:[], reasons:[]};
  SAMPLE_ROWS.forEach((r,idx)=>{addDiagWI(`SAMPLE_${idx+1}.pdf`, {model:r.model,page:r.page,before:r.beforeWI,after:r.afterWI,valid:r.validWI}, 'sample', '');
    const matched = r.result==='OK'; addDiagECN(r.model, true, {before:r.beforeM, after:r.afterM, valid:r.validM}, 1, matched?8:6);
    if(!matched) addReason(idx,'Mismatched AFTER', `WI: ${r.afterWI} vs ECN: ${r.afterM}`);});
  renderAll(RESULTS); document.getElementById('progBar').style.width='0%'; document.getElementById('progText').textContent='Hiá»ƒn thá»‹ 15 vÃ­ dá»¥ (cÃ³ 1 NG cá»‘ Ã½).'; document.getElementById('progPct').textContent='';});
document.getElementById('btnSamples').click();

document.getElementById('btnCompare').addEventListener('click', async ()=>{if(!WI_FILES.length){alert('ChÆ°a chá»n thÆ° má»¥c WI.'); return;} if(!ECN_MASTER.length){alert('ChÆ°a chá»n file ECN Master.'); return;} 
  RESULTS=[]; DIAG={wi:[], ecn:[], reasons:[]}; let done=0; const total=WI_FILES.length; const bar=document.getElementById('progBar');
  for(const f of WI_FILES){try{const parsed = /\.pdf$/i.test(f.name)? await parseWIPDF(f) : await parseWIXLSX(f); const wi = parsed.wi;
      addDiagWI(f.name, wi, (!wi.model?'missing model; ':'')+(!wi.before?'missing before; ':'')+(!wi.after?'missing after; ':'')+(!wi.valid?'missing valid; ':''), parsed.raw);
      const cands = ECN_MASTER.filter(r=> wi.model && r.model && r.model===wi.model);
      let best=null,score=-1; for(const r of cands){let s=0; if(wi.before && r.before && wi.before===r.before) s+=3; if(wi.after && r.after && wi.after===r.after) s+=3; if(wi.valid && r.valid && wi.valid===r.valid) s+=2;
        if(s>score){score=s; best=r;}} addDiagECN(wi.model, !!best, best, cands.length, Math.max(score,0));
      const m = best || {model:'',before:'',after:'',valid:''};
      const row={model: wi.model||'', page: wi.page||'', beforeWI: wi.before||'', beforeM: m.before||'', afterWI: wi.after||'', afterM: m.after||'', validWI: wi.valid||'', validM: m.valid||''};
      row.result = (row.beforeWI===row.beforeM)&&(row.afterWI===row.afterM)&&(row.validWI===row.validM)?'OK':'NG';
      if(row.result==='NG'){if(row.beforeWI!==row.beforeM) addReason(RESULTS.length,'Mismatch BEFORE', `WI: ${row.beforeWI} | ECN: ${row.beforeM}`);
        if(row.afterWI!==row.afterM) addReason(RESULTS.length,'Mismatch AFTER', `WI: ${row.afterWI} | ECN: ${row.afterM}`);
        if(row.validWI!==row.validM) addReason(RESULTS.length,'Mismatch VALID', `WI: ${row.validWI} | ECN: ${row.validM}`);} RESULTS.push(row);
    }catch(e){RESULTS.push({model:f.name, page:'-', beforeWI:'', beforeM:'', afterWI:'', afterM:'', validWI:'', validM:'', result:'NG'}); addReason(RESULTS.length,'Parse error', e.message||String(e)); console.error('Parse error', f.name, e);} 
    done++; const pct=Math.round(done*100/total); bar.style.width=pct+'%'; document.getElementById('progText').textContent= done<total?`Äang so sÃ¡nh ${done}/${total} fileâ€¦`:'HoÃ n táº¥t so sÃ¡nh.'; document.getElementById('progPct').textContent=pct+'%';}
  renderAll(RESULTS); if(document.getElementById('debugWrap').classList.contains('active')) renderDebug();});

// Export
document.getElementById('btnExport').addEventListener('click', ()=>{if(!RESULTS.length){alert('ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t.'); return;} const rows=[['Model','WI Page','Before (WI)','Before (ECN)','After (WI)','After (ECN)','Valid (WI)','Valid (ECN)','Result']];
  RESULTS.forEach(r=> rows.push([r.model,r.page,r.beforeWI,r.beforeM,r.afterWI,r.afterM,r.validWI,r.validM,r.result]));
  const ws=XLSX.utils.aoa_to_sheet(rows); ws['!cols']=[{wch:18},{wch:10},{wch:26},{wch:26},{wch:26},{wch:26},{wch:14},{wch:14},{wch:9}];
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'WI_Verify'); XLSX.writeFile(wb, 'WI_Revision_Verify_Result.xlsx');});
</script>"></iframe></div>
</section>
    </section>
  </main>
</div>

<!-- Drawer for ECN detail -->
<div class="drawer" id="drawer">
  <div class="dh"><strong>ECN Detail</strong><div class="spacer"></div><button class="btn secondary" id="closeDrawer">Close</button></div>
  <div class="dc">
    <div class="tabs">
      <div class="tab active" data-t="info">Info</div>
      <div class="tab" data-t="history">History</div>
      <div class="tab" data-t="feedback">Feedback</div>
    </div>
    <div id="panel-info">
      <div class="kv-tile"><div class="k">NgÃ y issue</div><div id="v-issue"></div></div>
      <div class="kv-tile"><div class="k">TiÃªu Ä‘á»</div><div id="v-title" style="font-weight:700"></div></div>
      <div class="kv-tile"><div class="k">Reason</div><div id="v-reason" style="white-space:pre-wrap"></div></div>
      <div class="kv-tile"><div class="k">Hiá»‡u lá»±c</div><div id="v-effect"></div></div>
      <div class="grid2">
        <div class="kv-tile"><div class="k">Tráº¡ng thÃ¡i</div><div id="v-status"></div></div>
        <div class="kv-tile">
          <div class="k">Perâ€‘Department Effective</div>
          <div id="v-perdept" style="display:flex;gap:6px;flex-wrap:wrap"></div>
        </div>
      </div>
      <div class="kv-tile"><div class="k">Latest change</div><div id="v-last"></div></div>
    </div>
    <div id="panel-history" class="hidden"><div id="historyList"></div></div>
    <div id="panel-feedback" class="hidden">
      <div class="kv-tile">
        <div class="k">Feedback</div>
        <div><textarea id="fbMsg" placeholder="MÃ´ táº£ váº¥n Ä‘á», áº£nh hÆ°á»Ÿng, Ä‘á» xuáº¥t..." style="width:100%;min-height:120px"></textarea></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label>Priority</label>
        <select id="fbPrio"><option>High</option><option>Medium</option><option>Low</option></select>
        <button class="btn" id="fbSend">Send feedback</button>
      </div>
      <div id="fbNote" class="muted" style="margin-top:8px;color:var(--muted)"></div>
    </div>
  </div>
</div>

<!-- AI panel floating (opened from sidebar button) -->
<div class="ai-panel" id="aiPanel" style="right:18px;bottom:78px;width:340px;display:none">
  <div class="ai-head">ECN AI Advisor</div>
  <div class="ai-body" id="aiBody"><em>Ask about ECN status, effective dates, or history...</em></div>
  <div class="ai-input"><input id="aiAsk" placeholder="e.g., status ECN-1012" /><button id="aiSend">Send</button></div>
</div>

<script>
// Value label plugin (bar-only) + color helpers â€” minimal and safe
const LineValueLabelPlugin={id:'lineValueLabel',afterDatasetsDraw(chart){if(chart.config.type!=='line')return;const{ctx,data}=chart;const meta=chart.getDatasetMeta(0);ctx.save();ctx.fillStyle='#111';ctx.font='bold 11px Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial';meta.data.forEach((pt,i)=>{const val=data.datasets[0].data[i];if(val==null)return;const p=pt.tooltipPosition();ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(String(val),p.x,p.y-6);});ctx.restore();}};Chart.register(LineValueLabelPlugin);
(function(){
  if(!window.Chart || !Chart.register) return;
  const ValueLabelPlugin = {
    id: 'barValueLabel',
    afterDatasetsDraw(chart, args, opts){
      if(chart.config.type!=='bar') return;
      const {ctx, data} = chart;
      const meta = chart.getDatasetMeta(0);
      ctx.save();
      ctx.fillStyle = '#111';
      ctx.font = 'bold 12px Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      meta.data.forEach((el, i)=>{
        const val = data.datasets[0].data[i];
        if(val==null) return;
        const p = el.tooltipPosition();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillText(String(val), p.x, p.y - 4);
      });
      ctx.restore();
    }
  };
  Chart.register(ValueLabelPlugin);
})();
// Map value to HSL: 140 (green) â†’ 28 (deep orange), avoid red
function colorScale(v, vmin, vmax){
  var t = (v - vmin) / Math.max(1, (vmax - vmin));
  if (t < 0) t = 0; if (t > 1) t = 1;
  var hue = 140 - (140-28)*t;    // green to deep orange
  var sat = 85;                   // vivid
  var light = 50 - 5*t;           // slightly darker on high
  return 'hsl(' + hue + ' ' + sat + '% ' + light + '%)';
}

// ----- Router -----
const nav = document.getElementById('nav');
function showTab(id){
  document.querySelectorAll('main > section').forEach(sec=>sec.classList.add('hidden'));
  const target = document.getElementById('page-'+id);
  if(target) target.classList.remove('hidden');
  localStorage.setItem('ecn_last_tab', id);
}
nav.addEventListener('click', (e)=>{
  const item = e.target.closest('.nav-item'); if(!item) return;
  nav.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  item.classList.add('active'); showTab(item.dataset.nav);
});
(function restoreTab(){
  const t = localStorage.getItem('ecn_last_tab') || 'dashboard';
  const el = nav.querySelector(`[data-nav="${t}"]`); if(el){ el.classList.add('active'); showTab(t); }
})();
// Language switch sync
document.getElementById('langTop').addEventListener('change', (e)=> localStorage.setItem('ecn_lang', e.target.value));
(function(){ const L = localStorage.getItem('ecn_lang'); if(L) document.getElementById('langTop').value=L; })();

// ----- Demo data (heavy, month-distributed) -----
const statuses = ["Pending","In progress","Completed"];
const departments = ["SMT","DIP","FA","FE","PE","QC","PMS","PSCD","COS"];
const models = ["MDL-310","MDL-220","MDL-450","MDL-500","MDL-700","MDL-900"];
const titles = ["Update PCB layout","Change resistor type","Modify housing","Firmware update","Relocate label","Harness length adj","Spec tighten","Safety marking adj","Sealant change","Connector pin swap"];
const owners = ["Minh Nguyen","Lan Tran","Quang Le","Anh Ho","Bao Pham","Duong Vo","COS Bot","QC Team","PE Lead","FE Owner"];
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function randCode(len){ const c="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; let s=""; for(let i=0;i<len;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; }
function partCode(){ return randCode(10+Math.floor(Math.random()*6)); }
function pad(n){ return n<10?("0"+n):(""+n); }
function randomInt(a,b){ return a+Math.floor(Math.random()*(b-a+1)); }
function randReason(){
  const pool=[
    "Quality drift found on line\n- Root cause: solder voids\n- Action: change paste type",
    "Supplier EOL notice; migrate to alt part",
    "Regulatory label relocation per IEC update",
    "Improve torque margin for FA station",
    "Optimize oven profile for DIP",
    "Address OQC NCR-455: add spacer"
  ];
  return rand(pool);
}
// Monthly plan with light seasonality
const monthPlan = [28,30,26,32,34,36,38,42,40,35,30,28]; // Jan..Dec
// Slight randomness per month
const ECN=[]; let idx=1;
for(let m=0;m<12;m++){
  const count = monthPlan[m] + randomInt(-4,4);
  for(let k=0;k<count; k++){
    const day = randomInt(1, Math.max(25, randomInt(24,28)));
    const issueDay = Math.max(1, day - randomInt(1,7));
    const dt = `2025-${pad(m+1)}-${pad(day)}`;
    const issue = `2025-${pad(m+1)}-${pad(issueDay)}`;
    const priority = rand(["High","Medium","Low","Low","Medium"]);
    const status = rand(statuses);
    const rec = {
      idx: idx++,
      ecnNo: "ECN-"+(1000+idx),
      sub: "SUB-"+(1000+idx),
      model: rand(models),
      title: rand(titles),
      reason: randReason(),
      before: partCode(),
      after: partCode(),
      issue: issue,
      effective: dt,
      valid: dt,
      status: status,
      dept: rand(departments),
      owner: rand(owners),
      priority: priority,
      history: [
        {ts:`2025-${pad(Math.max(1,m))}-${pad(randomInt(1,28))}`, by: rand(owners), note:"Initial draft created"},
        {ts:`2025-${pad(m+1)}-${pad(Math.max(1, day-2))}`, by: rand(owners), note:"WI reference updated"}
      ]
    };
    // Rank A-D
    let score = 0;
    if(priority==="High") score+=2; else if(priority==="Medium") score+=1;
    if(status==="Pending") score+=2; else if(status==="In progress") score+=1;
    const days = (Date.now() - new Date(issue).getTime())/86400000;
    if(days < 20) score+=2; else if(days<60) score+=1;
    rec.rankL = score>=5 ? "A" : score>=3 ? "B" : score>=2 ? "C" : "D";
    ECN.push(rec);
  }
}

// ----- Dashboard KPIs & charts -----
function dashKPIs(){
  const k={Pending:0,"In progress":0,Completed:0};
  ECN.forEach(r=>k[r.status]++);
  document.getElementById("kPending").textContent=k.Pending;
  document.getElementById("kProgress").textContent=k["In progress"];
  document.getElementById("kEffective").textContent=((window.ECN||[]).filter(r=>r.valid===r.effective).length)||0;
  document.getElementById("kArchived").textContent = (window.ECN||[]).filter(r=>r.status==="Completed").length;
}
function dashCharts(){
  // Yearly bars (per month totals)
  const monthlyTotals = Array(12).fill(0);
  ECN.forEach(r=> monthlyTotals[new Date(r.effective).getMonth()]++);
  const __minV = Math.min(...monthlyTotals), __maxV = Math.max(...monthlyTotals);
const __barColors = monthlyTotals.map(v=> colorScale(v, __minV, __maxV));
new Chart(document.getElementById('yearlyChart'),{
    type:'bar',
    data:{labels:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
      datasets:[{label:'ECN/Month',data:monthlyTotals, backgroundColor: __barColors, borderColor: __barColors, borderWidth:1}]}
  });
  // Current month daily line
  const cm=new Date().getMonth();
  const map={};
  (window.ECN||[]).filter(r=>new Date(r.effective).getMonth()===cm).forEach(r=>{
    const d=new Date(r.effective).getDate();
    map[d]=(map[d]||0)+1;
  });
  const days=Object.keys(map).sort((a,b)=>a-b);
  const vals=days.map(d=>map[d]);
  new Chart(document.getElementById('monthlyChart'),{type:'line',data:{labels:days,datasets:[{label:'ECN/day',data:vals,fill:false}]}});
  // Heatmap
  const grid=document.getElementById('heatmap'); grid.innerHTML="";
  const head=["Dept","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  head.forEach(h=>{ const div=document.createElement('div'); div.textContent=h; div.className="hhead"; grid.appendChild(div); });
  const months=[0,1,2,3,4,5,6,7,8,9,10,11];
  departments.forEach(dep=>{
    const t=document.createElement('div'); t.textContent=dep; t.style.fontWeight="700"; grid.appendChild(t);
    months.forEach(i=>{
      const n=(window.ECN||[]).filter(r=>r.dept===dep && new Date(r.effective).getMonth()===i).length;
      const cell=document.createElement('div'); cell.textContent=n?String(n):"";
      const alpha=Math.min(1,n/Math.max(6, monthPlan[i] / departments.length));
      cell.style.background=`rgba(14,165,233,${0.05+alpha*0.28})`;
      grid.appendChild(cell);
    });
  });
}

// ----- Global search affects ECN Master -----
const state = { q:"", statusSel:"", dept:"", from:"", to:"", page:1, pageSize:10 };
document.getElementById('q').addEventListener('input', e=>{ state.q=e.target.value.trim(); state.page=1; renderECN(); });

// ----- Status & Rank renderers -----
function statusIconOnly(s){
  if(s==="Completed") return '<span class="s-dot s-done" title="Completed"></span>';
  if(s==="In progress") return '<span class="s-dot s-progress" title="In progress"></span>';
  return '<span class="s-dot s-pending" title="Pending"></span>';
}
function rankBadge(letter){
  return `<span class="rank"><span class="rank-badge rank-${letter}">${letter}</span></span>`;
}
function matchECN(r){
  if(state.q){
    const q=state.q.toLowerCase();
    const blob=(r.ecnNo+" "+r.sub+" "+r.model+" "+r.title+" "+r.reason+" "+r.before+" "+r.after+" "+r.dept+" "+r.owner).toLowerCase();
    if(!blob.includes(q)) return false;
  }
  if(state.dept && r.dept!==state.dept) return false;
  if(state.statusSel && r.status!==state.statusSel) return false;
  if(state.from && r.effective<state.from) return false;
  if(state.to && r.effective>state.to) return false;
  return true;
}
function renderECN(){
  const tb=document.getElementById('ecnRows'); tb.innerHTML="";
  const rowsAll=(window.ECN||[]).filter(matchECN);
  const total=rowsAll.length; const pages=Math.max(1,Math.ceil(total/state.pageSize));
  if(state.page>pages) state.page=pages;
  const start=(state.page-1)*state.pageSize; const pageRows=[...rowsAll].sort((a,b)=> (a.rankL||"Z").localeCompare(b.rankL||"Z") ).slice(start, start+state.pageSize);
  pageRows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${rankBadge(r.rankL)}</td><td><strong>${r.ecnNo}</strong></td><td>${r.sub}</td><td>${r.model}</td>
      <td>${r.title}</td><td><code>${r.before}</code></td><td><code>${r.after}</code></td>
      <td>${r.effective}</td><td>${r.valid}</td><td style="text-align:center">${statusIconOnly(r.status)}</td>
      <td><button class="btn secondary btn-view" data-id="${r.ecnNo}">View</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('.btn-view').forEach(b=> b.addEventListener('click',(ev)=>{
    const id=ev.currentTarget.getAttribute('data-id'); const r=(window.ECN||[]).find(x=>x.ecnNo===id); if(r) openDetail(r);
  }));
  document.getElementById('miniInfo').textContent=`Page ${state.page}/${pages} â€” ${total} items`;
  document.getElementById('prevPage').disabled=state.page<=1;
  document.getElementById('nextPage').disabled=state.page>=pages;
}
document.getElementById('prevPage').addEventListener('click',()=>{state.page=Math.max(1,state.page-1);renderECN();});
document.getElementById('nextPage').addEventListener('click',()=>{state.page=state.page+1;renderECN();});
document.getElementById('fDept').addEventListener('change',e=>{state.dept=e.target.value;state.page=1;renderECN();});
document.getElementById('fStatusSel').addEventListener('change',e=>{state.statusSel=e.target.value;state.page=1;renderECN();});
document.getElementById('fDateFrom').addEventListener('change',e=>{state.from=e.target.value;state.page=1;renderECN();});
document.getElementById('fDateTo').addEventListener('change',e=>{state.to=e.target.value;state.page=1;renderECN();});

// ----- Drawer View (styled) -----
const drawer=document.getElementById('drawer');
function openDetail(r){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('.tab[data-t="info"]').classList.add('active');
  document.getElementById('panel-info').classList.remove('hidden');
  document.getElementById('panel-history').classList.add('hidden');
  document.getElementById('panel-feedback').classList.add('hidden');
  document.getElementById('v-issue').textContent=r.issue;
  document.getElementById('v-title').textContent=`${r.title} (${r.model}) â€” ${r.ecnNo}`;
  document.getElementById('v-reason').textContent=r.reason;
  document.getElementById('v-effect').textContent=`Effective: ${r.effective} â€” Valid BOM: ${r.valid}`;
  document.getElementById('v-status').innerHTML = statusIconOnly(r.status);
  const wrap=document.getElementById('v-perdept'); wrap.innerHTML="";
  ["SMT","DIP","FA","FE","PE","QC","COS"].forEach((d,i)=>{
    const dt=new Date(r.effective); dt.setDate(dt.getDate()+i*2);
    const tag=document.createElement('div'); tag.className='badge-mini'; tag.textContent=`${d}: ${dt.toISOString().slice(0,10)}`; wrap.appendChild(tag);
  });
  const last=r.history[r.history.length-1]; document.getElementById('v-last').textContent=`${last.ts} by ${last.by} â€” ${last.note}`;
  const hist=document.getElementById('historyList'); hist.innerHTML="";
  r.history.forEach(h=>{ const row=document.createElement('div'); row.className='kv-tile'; row.innerHTML=`<div class="k">${h.ts} â€¢ ${h.by}</div><div>${h.note}</div>`; hist.appendChild(row); });
  document.getElementById('fbPrio').value="Medium"; document.getElementById('fbMsg').value=""; document.getElementById('fbNote').textContent="";
  drawer.classList.add('open');
}
document.getElementById('closeDrawer').addEventListener('click',()=>drawer.classList.remove('open'));
document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  document.getElementById('panel-info').classList.toggle('hidden', t.dataset.t!=='info');
  document.getElementById('panel-history').classList.toggle('hidden', t.dataset.t!=='history');
  document.getElementById('panel-feedback').classList.toggle('hidden', t.dataset.t!=='feedback');
}));
document.getElementById('fbSend').addEventListener('click',()=>{
  const p=document.getElementById('fbPrio').value; const msg=document.getElementById('fbMsg').value.trim();
  if(!msg){ alert("Nháº­p ná»™i dung feedback"); return; }
  document.getElementById('fbNote').textContent=`Feedback sent to ECN members â€¢ Priority: ${p}`;
});

// ----- Department: base columns + per-dept extra cols after Valid BOM -----
const deptExtras = {
  FE: ["Revise WI","Delivery WI"],
  PE: ["ROM master"],
  SMT:["ROM master","Apply date"],
  FA: ["Apply date"],
  OQC:["Apply date"]
};
function renderDeptHead(dep){
  const base = ["Rank","ECN No.","Sub ECN","Model","Title","Before","After","Effective","Valid BOM","Status","View"];
  const extras = deptExtras[dep] || [];
  const ths = base.concat(extras).map(h=>`<th>${h}</th>`).join("");
  document.getElementById('deptHead').innerHTML = `<tr class="taskbar">${ths}</tr>`;
}
function renderDeptFields(dep){
  const wrap=document.getElementById('deptFields'); wrap.innerHTML="";
  const extras = deptExtras[dep] || [];
  if(extras.length){
    const hint=document.createElement('div'); hint.className="badge"; hint.textContent = `+ Fields: ${extras.join(", ")}`;
    wrap.appendChild(hint);
  }
}
function renderDeptTable(){
  const dep=document.getElementById('dDept').value; const owner=document.getElementById('dOwner').value.trim().toLowerCase(); const pr=document.getElementById('dPrio').value;
  renderDeptHead(dep); renderDeptFields(dep);
  const tb=document.getElementById('deptRows'); tb.innerHTML="";
  (window.ECN||[]).filter(r=>r.dept===dep).filter(r=>owner?String(r.owner).toLowerCase().includes(owner):true).filter(r=>pr==="All"?true:r.priority===pr).forEach(r=>{
    const cells = [
      rankBadge(r.rankL), `<strong>${r.ecnNo}</strong>`, r.sub, r.model, r.title,
      `<code>${r.before}</code>`, `<code>${r.after}</code>`, r.effective, r.valid, statusIconOnly(r.status),
      `<button class="btn secondary">View</button>`
    ];
    const extras = (deptExtras[dep]||[]).map(x=> (x.includes("Apply") ? new Date(r.effective).toISOString().slice(0,10) : (x.includes("ROM") ? ("ROM-"+r.model) : "WI-"+r.model)) );
    const tr=document.createElement('tr'); tr.innerHTML = cells.concat(extras).map(td=>`<td>${td}</td>`).join("");
    tr.querySelector('button').addEventListener('click',()=>openDetail(r));
    tb.appendChild(tr);
  });
}
document.getElementById('dDept').addEventListener('change',()=>{renderDeptTable();});
document.getElementById('dOwner').addEventListener('input',renderDeptTable);
document.getElementById('dPrio').addEventListener('change',renderDeptTable);

// ----- Admin flags + users + AI prompt -----
const FF={chatroom:document.getElementById('ff-chatroom'),convert:document.getElementById('ff-convert'),wi:document.getElementById('ff-wi'),lic:document.getElementById('ff-lic'),lang:document.getElementById('lang')};
(function restoreFF(){try{const s=JSON.parse(localStorage.getItem('ecn_flags')||'{}');FF.chatroom.checked=s.chatroom??true;FF.convert.checked=s.convert??true;FF.wi.checked=s.wi??true;FF.lic.checked=!!s.lic;if(s.lang)FF.lang.value=s.lang;applyFlags();}catch(e){}})();
function saveFF(){const obj={chatroom:FF.chatroom.checked,convert:FF.convert.checked,wi:FF.wi.checked,lic:FF.lic.checked,lang:FF.lang.value};localStorage.setItem('ecn_flags',JSON.stringify(obj));applyFlags();}
function applyFlags(){document.querySelector('[data-nav="chatroom"]').classList.toggle('hidden',!FF.chatroom.checked);document.querySelector('[data-nav="convertBOM"]').classList.toggle('hidden',!FF.convert.checked);document.querySelector('[data-nav="wiVerify"]').classList.toggle('hidden',!FF.wi.checked);}
FF.chatroom.addEventListener('change',saveFF);FF.convert.addEventListener('change',saveFF);FF.wi.addEventListener('change',saveFF);FF.lic.addEventListener('change',saveFF);FF.lang.addEventListener('change',saveFF);

let USERS=JSON.parse(localStorage.getItem('ecn_users')||'[]');
if(!USERS.length){
  USERS = [
    {name:"Minh Nguyen", email:"minh.nguyen@company.com", id:"U001", dept:"SMT", role:"Editor"},
    {name:"Lan Tran", email:"lan.tran@company.com", id:"U002", dept:"PE", role:"Approver"},
    {name:"Quang Le", email:"quang.le@company.com", id:"U003", dept:"FE", role:"Viewer"},
    {name:"Bao Pham", email:"bao.pham@company.com", id:"U004", dept:"QC", role:"Admin"}
  ];
  localStorage.setItem('ecn_users', JSON.stringify(USERS));
}
function saveUsers(){localStorage.setItem('ecn_users',JSON.stringify(USERS));}
function renderUsers(){const tb=document.getElementById('uRows');tb.innerHTML="";USERS.forEach((u,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${u.name}</td><td>${u.email}</td><td>${u.id}</td><td>${u.dept}</td><td>${u.role}</td><td><button class="btn secondary" data-i="${i}">Delete</button></td>`;tr.querySelector('button').addEventListener('click',(ev)=>{const idx=+ev.currentTarget.getAttribute('data-i');USERS.splice(idx,1);saveUsers();renderUsers();});tb.appendChild(tr);});}
renderUsers();
document.getElementById('uAdd').addEventListener('click',()=>{const name=uName.value.trim(),email=uEmail.value.trim(),id=uID.value.trim(),dept=uDept.value,role=uRole.value;if(!name||!email||!id){alert("Nháº­p Ä‘áº§y Ä‘á»§ Há» & TÃªn, Email, ID");return;}USERS.push({name,email,id,dept,role});saveUsers();renderUsers();uName.value="";uEmail.value="";uID.value="";});
const PROMPT_KEY="ecn_ai_prompt"; (function restorePrompt(){const p=localStorage.getItem(PROMPT_KEY)||""; if(document.getElementById('aiPrompt')) document.getElementById('aiPrompt').value=p; })();
if(document.getElementById('savePrompt')) document.getElementById('savePrompt').addEventListener('click',()=>{localStorage.setItem(PROMPT_KEY, document.getElementById('aiPrompt').value||""); alert("Saved.");});

// ----- Chatroom demo -----
function renderChat(){const arr=JSON.parse(localStorage.getItem('ecn_chat')||'[]');const log=document.getElementById('chatLog');log.innerHTML="";
  arr.forEach(m=>{const d=document.createElement('div');d.className='chat-bubble '+(m.me?'me':'other');d.innerHTML=`<div>${m.text}</div><div class="chat-sender">${m.me?'You':'Teammate'}</div>`;log.appendChild(d);});log.scrollTop=log.scrollHeight;}
if(!localStorage.getItem('ecn_chat')){
  localStorage.setItem('ecn_chat', JSON.stringify([
    {me:false, text:"Morning team, ECN-1102 is pending QC sign-off."},
    {me:true, text:"Roger. Iâ€™ll check WI update for FE today."},
    {me:false, text:"PE confirms ROM master for SMT applied on 2025-08-15."}
  ]));
}
renderChat();
document.getElementById('chatSend').addEventListener('click',()=>{const t=chatTxt.value.trim();if(!t)return;const arr=JSON.parse(localStorage.getItem('ecn_chat')||'[]');arr.push({me:true,text:t});localStorage.setItem('ecn_chat',JSON.stringify(arr));chatTxt.value="";renderChat();});

// ----- Convert BOM -----
function parseDelimited(text){const lines=text.trim().split(/\r?\n/);return lines.map(line=>{const parts=line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)|\t/);return parts.map(s=>s.replace(/^"|"$/g,'').trim());});}
function normalizeBOM(rows){const out=[];rows.forEach(r=>{if(!r.length||r.join('').trim()==="")return;const [p,desc,qty,ref]=[r[0]||"",r[1]||"",r[2]||"",r[3]||""];out.push([p,desc,qty,ref]);});return out;}
function renderBOM(rows){const tb=document.querySelector('#bomOut tbody');tb.innerHTML="";rows.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>`;tb.appendChild(tr);});}
let BOM_ROWS=[];document.getElementById('bomParse').addEventListener('click',()=>{const ta=bomPaste.value.trim();if(ta){BOM_ROWS=normalizeBOM(parseDelimited(ta));renderBOM(BOM_ROWS);return;}const f=bomFile.files[0];if(!f){alert("Select a CSV or paste data.");return;}const reader=new FileReader();reader.onload=e=>{BOM_ROWS=normalizeBOM(parseDelimited(e.target.result));renderBOM(BOM_ROWS);};reader.readAsText(f);});document.getElementById('bomDownload').addEventListener('click',()=>{if(!BOM_ROWS.length){alert("No BOM parsed.");return;}const csv=["PartNo,Description,Qty,RefDes"].concat(BOM_ROWS.map(r=>r.map(x=>`\"${String(x).replaceAll('\"','\"\"')}\"`).join(','))).join("\n");const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download="BOM_Normalized.csv";a.click();URL.revokeObjectURL(url);});

// ----- WI Verify -----
let WI_ECN=[],WI_PAGES=[];function readFileToRows(file,cb){const reader=new FileReader();reader.onload=e=>cb(parseDelimited(e.target.result));reader.readAsText(file);}
document.getElementById('wiRun').addEventListener('click',()=>{const ecnF=wiEcn.files[0],wiF=wiPages.files[0];if(!ecnF||!wiF){alert("Select both ECN Master and WI files.");return;}readFileToRows(ecnF,rows=>{WI_ECN=rows;readFileToRows(wiF,rows2=>{WI_PAGES=rows2;compareWI();});});});
function compareWI(){const mapECN={};WI_ECN.forEach(r=>{const key=(r[0]||"").trim();if(!key)return;mapECN[key]={before:r[1]||"",after:r[2]||""};});const tbody=document.querySelector('#wiTable tbody');tbody.innerHTML="";WI_PAGES.forEach((r,i)=>{const part=(r[0]||"").trim();if(!part)return;const wiVal=(r[1]||"").trim();const m=mapECN[part];let status="NG",note="";if(!m){status="NG";note="Part not in ECN";}else if(m.after===wiVal){status="OK";note="Matched";}else if(m.before===wiVal){status="NG";note="WI not updated";}else{status="NG";note="Mismatch";}const tr=document.createElement('tr');tr.innerHTML=`<td>${i+1}</td><td>${part}</td><td>${m?m.after:"-"}</td><td>${wiVal}</td><td>${status}</td><td>${note}</td>`;tr.style.background=status==="OK"?"#ecfdf5":"#fff1f2";tbody.appendChild(tr);});}

// ----- + New ECN staging flow -----
const stagingPanel=document.getElementById('stagingPanel'); let STAGING=[];
btnNew.addEventListener('click',()=>newFile.click());
newFile.addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const reader=new FileReader();reader.onload=ev=>{const rows=parseDelimited(ev.target.result);STAGING=[];rows.slice(1).forEach((r,i)=>{const eff=(r[6]||"").trim()||"2025-08-01";STAGING.push({ecnNo:r[0]||("ECN-NEW-"+(i+1)),sub:r[1]||("SUB-NEW-"+(i+1)),model:r[2]||"MDL-310",title:r[3]||"Update",before:r[4]||"OLD-PART",after:r[5]||"NEW-PART",effective:eff,valid:eff,status:r[7]||"Pending",dept:r[8]||"SMT",owner:r[9]||"Uploader",priority:r[10]||"Medium"});});renderStaging();};reader.readAsText(f);});
function renderStaging(){const tb=document.getElementById('stagingRows');tb.innerHTML="";STAGING.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.ecnNo}</td><td>${r.sub}</td><td>${r.model}</td><td>${r.title}</td><td><code>${r.before}</code></td><td><code>${r.after}</code></td><td>${r.effective}</td><td>${r.valid}</td><td>${r.status}</td>`;tb.appendChild(tr);});stagingPanel.classList.toggle('hidden',!STAGING.length);}
confirmImport.addEventListener('click',()=>{if(!STAGING.length){alert("No data in staging.");return;}const start=(window.ECN||[]).length+1;STAGING.forEach((r,i)=>ECN.push({...r,idx:start+i,reason:"Imported",issue:r.effective,history:[{ts:r.effective,by:r.owner||"Uploader",note:"Imported"}],rankL:"B"}));STAGING=[];stagingPanel.classList.add('hidden');renderECN();dashKPIs();alert("Imported to official dataset.");});

// ----- AI Advisor (local rules) -----
const openAI=document.getElementById('openAI'), aiPanel=document.getElementById('aiPanel'), aiBody=document.getElementById('aiBody'), aiAsk=document.getElementById('aiAsk');
openAI.addEventListener('click',()=>{aiPanel.style.display = aiPanel.style.display==='flex' ? 'none':'flex'; aiPanel.style.display = aiPanel.style.display || 'flex';});
document.getElementById('aiSend').addEventListener('click',()=>{
  const q = aiAsk.value.trim(); if(!q) return;
  const p = localStorage.getItem('ecn_ai_prompt') || "(default ECN advisor prompt)";
  const msg = document.createElement('div'); msg.textContent = "You: "+q; aiBody.appendChild(msg);
  let out = "I need ECN id, e.g., ECN-1010";
  const m = q.match(/ECN-\d+/i);
  if(m){
    const id = m[0].toUpperCase();
    const r = (window.ECN||[]).find(x=>x.ecnNo===id);
    if(r){
      if(/status/i.test(q)) out = `${id} â†’ ${r.status} â€¢ Effective ${r.effective}`;
      else if(/effective/i.test(q)) out = `${id} â†’ Effective ${r.effective} â€¢ Valid BOM ${r.valid}`;
      else if(/latest|change|history/i.test(q)) { const last=r.history[r.history.length-1]; out = `${id} â†’ Latest change ${last.ts} by ${last.by}: ${last.note}`; }
      else out = `${id} â†’ ${r.title} (${r.model}) â€¢ ${r.status}`;
    } else out = `${id} not found.`;
  }
  const bot = document.createElement('div'); bot.innerHTML = `<div style="color:#0b1220"><strong>AI:</strong> ${out}</div><div style="color:#64748b;font-size:11px">Prompt: ${p.slice(0,80)}...</div>`;
  aiBody.appendChild(bot); aiBody.scrollTop = aiBody.scrollHeight; aiAsk.value="";
});


// ----- i18n setup (English, Vietnamese, Japanese) -----
const i18nDict = {
  en: {
    "Dashboard":"Dashboard","ECN Master":"ECN Master","Department":"Department","Admin":"Admin",
    "Chatroom":"Chatroom","Convert BOM":"Convert BOM","WI Verify":"WI Verify","KPIs":"KPIs",
    "Pending":"Pending","In progress":"In progress","Effective":"Effective","Completed":"Completed",
    "Trends":"Trends","Department Ã— Month Heatmap":"Department Ã— Month Heatmap",
    "Rank":"Rank","ECN No.":"ECN No.","Sub ECN":"Sub ECN","Model":"Model","Title":"Title","Before":"Before","After":"After",
    "Status":"Status","View":"View","Owner":"Owner","Priority":"Priority","High":"High","Medium":"Medium","Low":"Low",
    "Feature Flags & Preferences":"Feature Flags & Preferences","User Management":"User Management",
    "Há» vÃ  TÃªn":"Full Name","Email":"Email","ID":"ID","Role":"Role","Delete":"Delete","Add":"Add",
    "Team Chat":"Team Chat","Convert BOM (CSV)":"Convert BOM (CSV)","Or paste CSV below:":"Or paste CSV below:",
    "WI Verify vs ECN Master":"WI Verify vs ECN Master","ECN Detail":"ECN Detail","Info":"Info","History":"History","Feedback":"Feedback",
    "NgÃ y issue":"Issue Date","TiÃªu Ä‘á»":"Title","Reason":"Reason","Hiá»‡u lá»±c":"Effective","Tráº¡ng thÃ¡i":"Status",
    "Latest change":"Latest change","Send":"Send","Save Prompt":"Save Prompt"
  },
  vi: {
    "Dashboard":"Báº£ng tin","ECN Master":"ECN Gá»‘c","Department":"PhÃ²ng ban","Admin":"Quáº£n trá»‹",
    "Chatroom":"TrÃ² chuyá»‡n","Convert BOM":"Chuyá»ƒn BOM","WI Verify":"Äá»‘i chiáº¿u WI","KPIs":"Chá»‰ sá»‘ KPI",
    "Pending":"Äang chá»","In progress":"Äang xá»­ lÃ½","Effective":"Hiá»‡u lá»±c","Completed":"HoÃ n táº¥t",
    "Trends":"Xu hÆ°á»›ng","Department Ã— Month Heatmap":"Báº£n Ä‘á»“ Nhiá»‡t PhÃ²ng Ã— ThÃ¡ng",
    "Rank":"Háº¡ng","ECN No.":"Sá»‘ ECN","Sub ECN":"ECN phá»¥","Model":"Model","Title":"TiÃªu Ä‘á»","Before":"TrÆ°á»›c","After":"Sau",
    "Status":"Tráº¡ng thÃ¡i","View":"Xem","Owner":"NgÆ°á»i phá»¥ trÃ¡ch","Priority":"Æ¯u tiÃªn","High":"Cao","Medium":"Trung bÃ¬nh","Low":"Tháº¥p",
    "Feature Flags & Preferences":"TÃ¹y chá»n & Cá» chá»©c nÄƒng","User Management":"Quáº£n lÃ½ ngÆ°á»i dÃ¹ng",
    "Há» vÃ  TÃªn":"Há» vÃ  TÃªn","Email":"Email","ID":"MÃ£","Role":"Vai trÃ²","Delete":"XÃ³a","Add":"ThÃªm",
    "Team Chat":"TrÃ² chuyá»‡n nhÃ³m","Convert BOM (CSV)":"Chuyá»ƒn BOM (CSV)","Or paste CSV below:":"Hoáº·c dÃ¡n CSV dÆ°á»›i Ä‘Ã¢y:",
    "WI Verify vs ECN Master":"Äá»‘i chiáº¿u WI vá»›i ECN Gá»‘c","ECN Detail":"Chi tiáº¿t ECN","Info":"ThÃ´ng tin","History":"Lá»‹ch sá»­","Feedback":"Pháº£n há»“i",
    "NgÃ y issue":"NgÃ y phÃ¡t hÃ nh","TiÃªu Ä‘á»":"TiÃªu Ä‘á»","Reason":"LÃ½ do","Hiá»‡u lá»±c":"Hiá»‡u lá»±c","Tráº¡ng thÃ¡i":"Tráº¡ng thÃ¡i",
    "Latest change":"Thay Ä‘á»•i má»›i nháº¥t","Send":"Gá»­i","Save Prompt":"LÆ°u Prompt"
  },
  ja: {
    "Dashboard":"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰","ECN Master":"ECNãƒžã‚¹ã‚¿ãƒ¼","Department":"éƒ¨é–€","Admin":"ç®¡ç†",
    "Chatroom":"ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ","Convert BOM":"BOMå¤‰æ›","WI Verify":"WIæ¤œè¨¼","KPIs":"KPI",
    "Pending":"ä¿ç•™","In progress":"é€²è¡Œä¸­","Effective":"æœ‰åŠ¹","Completed":"å®Œäº†",
    "Trends":"ãƒˆãƒ¬ãƒ³ãƒ‰","Department Ã— Month Heatmap":"éƒ¨é–€Ã—æœˆ ãƒ’ãƒ¼ãƒˆãƒžãƒƒãƒ—",
    "Rank":"ãƒ©ãƒ³ã‚¯","ECN No.":"ECNç•ªå·","Sub ECN":"ã‚µãƒ–ECN","Model":"ãƒ¢ãƒ‡ãƒ«","Title":"ã‚¿ã‚¤ãƒˆãƒ«","Before":"å¤‰æ›´å‰","After":"å¤‰æ›´å¾Œ",
    "Status":"çŠ¶æ…‹","View":"è¡¨ç¤º","Owner":"æ‹…å½“è€…","Priority":"å„ªå…ˆåº¦","High":"é«˜","Medium":"ä¸­","Low":"ä½Ž",
    "Feature Flags & Preferences":"æ©Ÿèƒ½ãƒ•ãƒ©ã‚°ã¨è¨­å®š","User Management":"ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†",
    "Há» vÃ  TÃªn":"æ°å","Email":"ãƒ¡ãƒ¼ãƒ«","ID":"ID","Role":"å½¹å‰²","Delete":"å‰Šé™¤","Add":"è¿½åŠ ",
    "Team Chat":"ãƒãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆ","Convert BOM (CSV)":"BOMå¤‰æ› (CSV)","Or paste CSV below:":"ã¾ãŸã¯CSVã‚’è²¼ã‚Šä»˜ã‘:",
    "WI Verify vs ECN Master":"WI vs ECNãƒžã‚¹ã‚¿ãƒ¼ã®æ¤œè¨¼","ECN Detail":"ECNè©³ç´°","Info":"æƒ…å ±","History":"å±¥æ­´","Feedback":"ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯",
    "NgÃ y issue":"ç™ºè¡Œæ—¥","TiÃªu Ä‘á»":"ã‚¿ã‚¤ãƒˆãƒ«","Reason":"ç†ç”±","Hiá»‡u lá»±c":"æœ‰åŠ¹æ—¥","Tráº¡ng thÃ¡i":"çŠ¶æ…‹",
    "Latest change":"æœ€æ–°ã®å¤‰æ›´","Send":"é€ä¿¡","Save Prompt":"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜"
  }
};
function applyLang(lang){
  document.querySelectorAll('body *').forEach(el=>{
    if(el.childNodes.length===1 && el.childNodes[0].nodeType===3){
      const txt=el.textContent.trim();
      if(i18nDict[lang][txt]) el.textContent=i18nDict[lang][txt];
    }
    if(el.placeholder && i18nDict[lang][el.placeholder]) el.placeholder=i18nDict[lang][el.placeholder];
    if(el.value && i18nDict[lang][el.value]) el.value=i18nDict[lang][el.value];
  });
}
function setLang(lang){
  localStorage.setItem('ecn_lang', lang);
  applyLang(lang);
  document.getElementById('langTop').value=lang;
  document.getElementById('lang').value=lang;
}
document.getElementById('langTop').addEventListener('change', e=>setLang(e.target.value));
document.getElementById('lang').addEventListener('change', e=>setLang(e.target.value));
(function(){const L=localStorage.getItem('ecn_lang')||'en';setLang(L);})();

// ===== I18N Runtime Fix (3 languages only + reversible switching) =====
(function(){
  const LANG_KEY = 'ecn_lang';
  const OPTIONS_HTML = '<option value="en">English</option><option value="vi">Tiáº¿ng Viá»‡t</option><option value="ja">æ—¥æœ¬èªž</option>';

  // Dictionaries: source keys are the ORIGINAL English strings taken from the DOM on first load.
  const I18N = {
    en: {}, // english returns original
    vi: {
      "Dashboard":"Báº£ng tin","ECN Master":"ECN Gá»‘c","Department":"PhÃ²ng ban","Admin":"Quáº£n trá»‹",
      "Chatroom":"TrÃ² chuyá»‡n","Convert BOM":"Chuyá»ƒn BOM","WI Verify":"Äá»‘i chiáº¿u WI","KPIs":"Chá»‰ sá»‘ KPI",
      "Pending":"Äang chá»","In progress":"Äang xá»­ lÃ½","Effective":"Hiá»‡u lá»±c","Completed":"HoÃ n táº¥t",
      "Trends":"Xu hÆ°á»›ng","Department Ã— Month Heatmap":"Báº£n Ä‘á»“ Nhiá»‡t PhÃ²ng Ã— ThÃ¡ng",
      "Rank":"Háº¡ng","ECN No.":"Sá»‘ ECN","Sub ECN":"ECN phá»¥","Model":"Model","Title":"TiÃªu Ä‘á»","Before":"TrÆ°á»›c","After":"Sau",
      "Status":"Tráº¡ng thÃ¡i","View":"Xem","Owner":"NgÆ°á»i phá»¥ trÃ¡ch","Priority":"Æ¯u tiÃªn","High":"Cao","Medium":"Trung bÃ¬nh","Low":"Tháº¥p",
      "Feature Flags & Preferences":"TÃ¹y chá»n & Cá» chá»©c nÄƒng","User Management":"Quáº£n lÃ½ ngÆ°á»i dÃ¹ng",
      "Full Name":"Há» vÃ  TÃªn","Email":"Email","ID":"MÃ£","Role":"Vai trÃ²","Delete":"XÃ³a","Add":"ThÃªm",
      "Team Chat":"TrÃ² chuyá»‡n nhÃ³m","Convert BOM (CSV)":"Chuyá»ƒn BOM (CSV)","Or paste CSV below:":"Hoáº·c dÃ¡n CSV dÆ°á»›i Ä‘Ã¢y:",
      "WI Verify vs ECN Master":"Äá»‘i chiáº¿u WI vá»›i ECN Gá»‘c","ECN Detail":"Chi tiáº¿t ECN","Info":"ThÃ´ng tin","History":"Lá»‹ch sá»­","Feedback":"Pháº£n há»“i",
      "Issue Date":"NgÃ y phÃ¡t hÃ nh","Reason":"LÃ½ do","Latest change":"Thay Ä‘á»•i má»›i nháº¥t","Save Prompt":"LÆ°u Prompt","Send":"Gá»­i"
    },
    ja: {
      "Dashboard":"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰","ECN Master":"ECNãƒžã‚¹ã‚¿ãƒ¼","Department":"éƒ¨é–€","Admin":"ç®¡ç†",
      "Chatroom":"ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ","Convert BOM":"BOMå¤‰æ›","WI Verify":"WIæ¤œè¨¼","KPIs":"KPI",
      "Pending":"ä¿ç•™","In progress":"é€²è¡Œä¸­","Effective":"æœ‰åŠ¹","Completed":"å®Œäº†",
      "Trends":"ãƒˆãƒ¬ãƒ³ãƒ‰","Department Ã— Month Heatmap":"éƒ¨é–€Ã—æœˆ ãƒ’ãƒ¼ãƒˆãƒžãƒƒãƒ—",
      "Rank":"ãƒ©ãƒ³ã‚¯","ECN No.":"ECNç•ªå·","Sub ECN":"ã‚µãƒ–ECN","Model":"ãƒ¢ãƒ‡ãƒ«","Title":"ã‚¿ã‚¤ãƒˆãƒ«","Before":"å¤‰æ›´å‰","After":"å¤‰æ›´å¾Œ",
      "Status":"çŠ¶æ…‹","View":"è¡¨ç¤º","Owner":"æ‹…å½“è€…","Priority":"å„ªå…ˆåº¦","High":"é«˜","Medium":"ä¸­","Low":"ä½Ž",
      "Feature Flags & Preferences":"æ©Ÿèƒ½ãƒ•ãƒ©ã‚°ã¨è¨­å®š","User Management":"ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†",
      "Full Name":"æ°å","Email":"ãƒ¡ãƒ¼ãƒ«","ID":"ID","Role":"å½¹å‰²","Delete":"å‰Šé™¤","Add":"è¿½åŠ ",
      "Team Chat":"ãƒãƒ¼ãƒ ãƒãƒ£ãƒƒãƒˆ","Convert BOM (CSV)":"BOMå¤‰æ› (CSV)","Or paste CSV below:":"ã¾ãŸã¯CSVã‚’è²¼ã‚Šä»˜ã‘:",
      "WI Verify vs ECN Master":"WI vs ECNãƒžã‚¹ã‚¿ãƒ¼ã®æ¤œè¨¼","ECN Detail":"ECNè©³ç´°","Info":"æƒ…å ±","History":"å±¥æ­´","Feedback":"ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯",
      "Issue Date":"ç™ºè¡Œæ—¥","Reason":"ç†ç”±","Latest change":"æœ€æ–°ã®å¤‰æ›´","Save Prompt":"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜","Send":"é€ä¿¡"
    }
  };

  function sanitizeLanguageSelects(){
    const a = document.getElementById('langTop');
    const b = document.getElementById('lang');
    if(a){ a.innerHTML = OPTIONS_HTML; }
    if(b){ b.innerHTML = OPTIONS_HTML; }
  }

  // Cache original (English) text/placeholder/value once
  let cached = false;
  function cacheOriginalStrings(){
    if(cached) return;
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
    while(walker.nextNode()){
      const el = walker.currentNode;
      // textContent (simple leaf text nodes)
      if(!el.children.length && el.childNodes.length===1 && el.childNodes[0].nodeType===3){
        const txt = el.textContent.trim();
        if(el.classList && el.classList.contains('v')) { /* skip KPI value cells */ }
        else if(/^[0-9.,]+$/.test(txt)) { /* skip pure numbers */ }
        else if(!el.dataset.i18nEn && txt){ el.dataset.i18nEn = el.textContent; }
      }
      // placeholder
      if(el.placeholder && !el.dataset.i18nPhEn){
        el.dataset.i18nPhEn = el.placeholder;
      }
      // value (for buttons)
      if((el.tagName==='INPUT' || el.tagName==='BUTTON') && el.value && !el.dataset.i18nValEn && el.id!=='q'){
        el.dataset.i18nValEn = el.value;
      }
    }
    cached = true;
  }

  function applyLang(lang){
    cacheOriginalStrings();
    const dict = I18N[lang] || {};
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT);
    while(walker.nextNode()){
      const el = walker.currentNode;
      // text node
      if(el.dataset && el.dataset.i18nEn){
        const base = el.dataset.i18nEn.trim();
        el.textContent = (lang==='en') ? base : (dict[base] || base);
      }
      // placeholder
      if(el.dataset && el.dataset.i18nPhEn){
        const basePh = el.dataset.i18nPhEn;
        el.placeholder = (lang==='en') ? basePh : (dict[basePh] || basePh);
      }
      // value (buttons/inputs)
      if(el.dataset && el.dataset.i18nValEn){
        const baseVal = el.dataset.i18nValEn;
        el.value = (lang==='en') ? baseVal : (dict[baseVal] || baseVal);
      }
    }
    localStorage.setItem(LANG_KEY, lang);
    const a = document.getElementById('langTop'); if(a) a.value = lang;
    const b = document.getElementById('lang'); if(b) b.value = lang;
  }

  function getLang(){ return localStorage.getItem(LANG_KEY) || 'en'; }
  function onLangChange(ev){ applyLang(ev.target.value); if(typeof dashKPIs==='function') try{ dashKPIs(); }catch(e){} window.dispatchEvent(new Event('ecn_lang_changed')); }

  document.addEventListener('DOMContentLoaded', function(){
    sanitizeLanguageSelects();
    const a = document.getElementById('langTop'); const b = document.getElementById('lang');
    if(a){ a.addEventListener('change', onLangChange); }
    if(b){ b.addEventListener('change', onLangChange); }
    applyLang(getLang());
    if(typeof dashKPIs==='function') try{ dashKPIs(); }catch(e){}
    window.dispatchEvent(new Event('ecn_lang_changed'));
  });
})();

// --- KPI runtime adjust: compute Total and order 4 cards without touching HTML structure
(function(){
  const oldDashKPIs = typeof dashKPIs==='function' ? dashKPIs : null;
  window.dashKPIs = function(){
    if(oldDashKPIs) oldDashKPIs();
    // Compute totals
    const k = {Pending:0,"In progress":0,Completed:0};
    if(Array.isArray(window.ECN)){
      window.ECN.forEach(r=>{ if(k[r.status]!==undefined) k[r.status]++; });
    }
    const total = k.Pending + k["In progress"] + k.Completed;
    const $ = id => document.getElementById(id);
    if($('kArchived')) $('kArchived').textContent = k.Completed;
    if($('kPending')) $('kPending').textContent = k.Pending;
    if($('kProgress')) $('kProgress').textContent = k["In progress"];
    // Ensure Total KPI exists (create once)
    if(!$('kTotal')){
      const grid = document.querySelector('.kpi-grid');
      if(grid){
        const card = document.createElement('div');
        card.className = 'kpi';
        card.innerHTML = '<div class="k">Total ECN</div><div class="v" id="kTotal">0</div>';
        grid.insertBefore(card, grid.firstChild);
      }
    }
    if($('kTotal')) $('kTotal').textContent = total;
    // Reorder: Total, Pending, In progress, Completed
    const grid = document.querySelector('.kpi-grid');
    if(grid){
      const order = ['kTotal','kPending','kProgress','kArchived'];
      order.forEach(id=>{ const v = $(id); if(v && v.parentElement && v.parentElement.parentElement===grid){ grid.appendChild(v.parentElement); } });
    }
  };
  // Run once after page init (in case charts/app already loaded)
  try{ window.dashKPIs(); }catch(e){}
})();

// ---- KPI unify counts with monthly data ----
(function(){
  const _dashKPIs = (typeof window.dashKPIs==='function') ? window.dashKPIs : null;
  window.dashKPIs = function(){
    if(_dashKPIs) _dashKPIs();
    const k={Pending:0,"In progress":0,Completed:0};
    const list = Array.isArray(window.ECN) ? window.ECN : [];
    for(const r of list){ if(k[r.status]!==undefined) k[r.status]++; }
    const total = list.length; // must equal sum of bar chart monthly totals
    const $ = id => document.getElementById(id);
    if($('kPending')) $('kPending').textContent = k.Pending;
    if($('kProgress')) $('kProgress').textContent = k["In progress"];
    if($('kArchived')) $('kArchived').textContent = k.Completed;
    if($('kTotal')) $('kTotal').textContent = total;
  };
  try{ window.dashKPIs(); }catch(e){}
})();

// ---- Department page: i18n label fix + column reorder ----
(function(){
  const LABELS = {
    en:{ dept:"Department", owner:"Owner", ownerPh:"Owner name", prio:"Priority", all:"All", rm:"ROM master", ad:"Apply date", status:"Status", view:"View", valid:"Valid BOM" },
    vi:{ dept:"PhÃ²ng ban", owner:"Owner", ownerPh:"TÃªn phá»¥ trÃ¡ch", prio:"Æ¯u tiÃªn", all:"Táº¥t cáº£", rm:"ROM master", ad:"NgÃ y Ã¡p dá»¥ng", status:"Tráº¡ng thÃ¡i", view:"Xem", valid:"Valid BOM" },
    ja:{ dept:"éƒ¨é–€", owner:"æ‹…å½“è€…", ownerPh:"æ‹…å½“è€…å", prio:"å„ªå…ˆåº¦", all:"ã™ã¹ã¦", rm:"ROMãƒžã‚¹ã‚¿ãƒ¼", ad:"é©ç”¨æ—¥", status:"çŠ¶æ…‹", view:"è¡¨ç¤º", valid:"Valid BOM" }
  };
  function lang(){ return localStorage.getItem('ecn_lang')||'en'; }

  function applyDeptLabels(){
    const L = LABELS[lang()];
    // Filter labels
    const w = document.querySelector('#page-department .filters');
    if(!w) return;
    const f = w.querySelectorAll('.filter');
    if(f[0]){ const lab=f[0].querySelector('label,span'); if(lab) lab.textContent = L.dept; }
    if(f[1]){ const lab=f[1].querySelector('label'); if(lab) lab.textContent = L.owner; const inp=f[1].querySelector('input'); if(inp) inp.placeholder=L.ownerPh; }
    if(f[2]){ const lab=f[2].querySelector('label'); if(lab) lab.textContent = L.prio; const sel=f[2].querySelector('select'); if(sel){ const o=sel.querySelectorAll('option'); if(o[0]) o[0].textContent=L.all; } }
  }

  function reorderDeptColumns(){
    const page = document.getElementById('page-department'); if(!page) return;
    const table = page.querySelector('table'); if(!table) return;
    const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody'); if(!thead||!tbody) return;
    const headCells = Array.from(thead.querySelectorAll('tr.taskbar th'));
    if(!headCells.length) return;

    // Map header text (trimmed) to index
    const idx = {};
    headCells.forEach((th,i)=> idx[th.textContent.trim()] = i);

    // Resolve indices by trying labels in all languages
    const L = LABELS[lang()];
    const getIdx = (names)=>{
      for(const n of names){ if(n in idx) return idx[n]; }
      return -1;
    };
    const iValid = getIdx([L.valid,"Valid BOM"]);
    const iRM = getIdx([L.rm,"ROM master","ROMãƒžã‚¹ã‚¿ãƒ¼"]);
    const iAD = getIdx([L.ad,"Apply date","é©ç”¨æ—¥"]);
    const iStatus = getIdx([L.status,"Tráº¡ng thÃ¡i","çŠ¶æ…‹","Status"]);
    const iView = getIdx([L.view,"Xem","è¡¨ç¤º","View"]);
    if(iValid<0 || iRM<0 || iAD<0 || iStatus<0 || iView<0) return; // columns not present

    // Desired new order parts:
    // ... [up to iValid] then ROM master, Apply date, then other mid columns (excluding Status/View), finally Status, View
    const order = [];
    const n = headCells.length;
    // Collect base columns before Valid BOM (inclusive)
    for(let c=0;c<=iValid;c++) order.push(c);
    // Then ROM master & Apply date (if not already right position)
    if(!order.includes(iRM)) order.push(iRM);
    if(!order.includes(iAD)) order.push(iAD);
    // Then remaining columns except Status/View and ones already added
    for(let c=iValid+1;c<n;c++){ if(![iRM,iAD,iStatus,iView].includes(c) && !order.includes(c)) order.push(c); }
    // Finally Status then View
    if(!order.includes(iStatus)) order.push(iStatus);
    if(!order.includes(iView)) order.push(iView);

    // Apply header reorder
    const trHead = thead.querySelector('tr.taskbar');
    const headClones = Array.from(headCells);
    trHead.innerHTML = "";
    order.forEach(i=> trHead.appendChild(headClones[i]));

    // Apply each row reorder
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const cells = Array.from(tr.children);
      const frag = document.createDocumentFragment();
      order.forEach(i=> frag.appendChild(cells[i]));
      tr.innerHTML = "";
      tr.appendChild(frag);
    });
  }

  // Run when department page is visible
  function runDeptFix(){
    applyDeptLabels();
    reorderDeptColumns();
  }

  // Observe navigation and rerun when page changes language or tab
  document.addEventListener('click', function(ev){
    if(ev.target.closest('.nav-item')) setTimeout(runDeptFix, 80);
  });
  document.addEventListener('DOMContentLoaded', runDeptFix);
  window.addEventListener('ecn_lang_changed', runDeptFix);
})();

// ---- Show "+ New ECN" only on ECN Master ----
(function(){
  const btn = document.getElementById('btnNew');
  if(!btn) return;
  function update(){
    const master = document.getElementById('page-ecnMaster');
    const visible = master && (master.style.display!== 'none') && master.offsetParent !== null;
    btn.style.display = visible ? '' : 'none';
  }
  document.addEventListener('click', function(ev){
    if(ev.target.closest('.nav-item')) setTimeout(update, 100);
  });
  document.addEventListener('DOMContentLoaded', update);
})();

// Ensure Department columns are reordered on first load as soon as rows appear
(function(){
  const targetPage = document.getElementById('page-department');
  if(!targetPage) return;
  const table = targetPage.querySelector('table');
  if(!table) return;
  const tbody = table.querySelector('tbody');
  if(!tbody) return;
  let appliedOnce = false;
  const observer = new MutationObserver(()=>{
    if(appliedOnce) return;
    if(tbody.children.length>0){
      try{ (window.__runDeptFix||function(){})(); appliedOnce = true; }catch(e){}
    }
  });
  observer.observe(tbody,{childList:true});
  // expose runner so other code can call
  window.__runDeptFix = function(){ try{ runDeptFix(); }catch(e){} };
  // also attempt once in case rows already there
  setTimeout(()=>{ if(tbody.children.length>0){ window.__runDeptFix(); appliedOnce=true; } }, 120);
})();

// Stable KPI: order + values (run at load, on tab show, after charts, and on language change)
(function(){
  function computeCounts(){
    const counts={Pending:0,"In progress":0,Completed:0};
    const list = Array.isArray(window.ECN)? window.ECN : [];
    for(const r of list){ if(counts[r.status]!==undefined) counts[r.status]++; }
    let total = 0;
    if(Array.isArray(window.monthlyTotals) && window.monthlyTotals.length){
      total = window.monthlyTotals.reduce((a,b)=>a+(+b||0),0);
    }else{
      total = list.length;
    }
    return {counts,total};
  }
  function ensureTilesAndOrder(){
    const grid = document.querySelector('#page-dashboard .kpi-grid');
    if(!grid) return;
    const get = id=>document.getElementById(id);
    // Create Total tile if missing
    if(!get('kTotal')){
      const card=document.createElement('div');
      card.className='kpi';
      card.innerHTML='<div class="k">Total ECN</div><div class="v" id="kTotal">0</div>';
      grid.insertBefore(card, grid.firstChild);
    }
    // Reorder in desired order
    const order=['kTotal','kPending','kProgress','kArchived'];
    order.forEach(id=>{
      const v=get(id);
      if(v && v.parentElement && v.parentElement.parentElement===grid) grid.appendChild(v.parentElement);
    });
  }
  function render(){
    ensureTilesAndOrder();
    const {counts,total}=computeCounts();
    const set=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=String(val); };
    set('kTotal', total);
    set('kPending', counts.Pending);
    set('kProgress', counts["In progress"]);
    set('kArchived', counts.Completed);
  }
  // Hook into existing functions if present
  const oldDashCharts = (typeof window.dashCharts==='function')? window.dashCharts : null;
  if(oldDashCharts){
    window.dashCharts = function(){ oldDashCharts(); try{ render(); }catch(e){} };
  }
  const oldDashKPIs = (typeof window.dashKPIs==='function')? window.dashKPIs : null;
  window.dashKPIs = function(){ if(oldDashKPIs) oldDashKPIs(); try{ render(); }catch(e){} };
  // Run on load and when switching to dashboard tab
  document.addEventListener('DOMContentLoaded', function(){ setTimeout(render, 100); });
  document.addEventListener('click', function(ev){
    if(ev.target.closest('.nav-item[data-nav="dashboard"]')) setTimeout(render, 120);
  });
  // Re-render after language change
  window.addEventListener('ecn_lang_changed', function(){ setTimeout(render, 60); });
})();

// === Department page enhancements applied ===
// ----- Init -----
function initAll(){
  dashKPIs(); dashCharts();
  renderECN();
  renderDeptTable();
}
if(document.readyState==="complete") initAll(); else window.addEventListener('load', initAll);
</script>

<!-- SAFE7 minimal Department search + reorder -->
<script>
(function(){
  // Utils
  function isDeptActive(){
    const page = document.getElementById('page-department');
    return page && page.style.display !== 'none';
  }
  function norm(t){ return String(t||'').replace(/\s+/g,' ').trim(); }

  // Reorder Department columns: ROM master + Apply date immediately after Valid BOM; Status & View at the end
  function reorderDeptCols(){
    const page = document.getElementById('page-department'); if(!page) return;
    const table = page.querySelector('table'); if(!table) return;
    const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody');
    if(!thead || !tbody) return;
    const trHead = thead.querySelector('tr.taskbar'); if(!trHead) return;
    const ths = Array.from(trHead.children);
    if(!ths.length) return;

    // Recognize labels in EN/VI/JA
    const labels = {
      valid: ["Valid BOM","ValidÂ BOM","ValidÂ BOM"], // keep variants
      rom: ["ROM master","ROMãƒžã‚¹ã‚¿ãƒ¼","ROM master"],
      apply: ["Apply date","NgÃ y Ã¡p dá»¥ng","é©ç”¨æ—¥"],
      status: ["Status","Tráº¡ng thÃ¡i","çŠ¶æ…‹"],
      view: ["View","Xem","è¡¨ç¤º"]
    };
    const findIdx = (names)=>{
      let idx=-1;
      ths.forEach((th,i)=>{
        const txt = norm(th.textContent);
        names.forEach(n=>{ if(idx<0 && norm(n)===txt) idx=i; });
      });
      return idx;
    };
    const iValid = findIdx(labels.valid);
    const iROM = findIdx(labels.rom);
    const iApply = findIdx(labels.apply);
    const iStatus = findIdx(labels.status);
    const iView = findIdx(labels.view);
    if(iValid<0 || iStatus<0 || iView<0) return; // nothing to do

    // Build order
    const N = ths.length;
    const order = [];
    for(let i=0;i<=iValid;i++) order.push(i);                // up to Valid BOM
    if(iROM>=0 && !order.includes(iROM)) order.push(iROM);   // ROM master
    if(iApply>=0 && !order.includes(iApply)) order.push(iApply); // Apply date
    for(let i=iValid+1;i<N;i++){                             // rest except Status/View and already added
      if([iROM,iApply,iStatus,iView].includes(i)) continue;
      if(!order.includes(i)) order.push(i);
    }
    if(!order.includes(iStatus)) order.push(iStatus);        // Status
    if(!order.includes(iView)) order.push(iView);            // View

    // Apply to header
    const headCells = Array.from(trHead.children);
    trHead.innerHTML = "";
    order.forEach(i=> trHead.appendChild(headCells[i]));

    // Apply to rows
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const tds = Array.from(tr.children);
      const frag = document.createDocumentFragment();
      order.forEach(i=> frag.appendChild(tds[i]));
      tr.innerHTML = "";
      tr.appendChild(frag);
    });

    // Center Status column
    const newIdxStatus = order.indexOf(iStatus);
    if(newIdxStatus>=0){
      Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
        const td = tr.children[newIdxStatus]; if(td) td.style.textAlign = 'center';
      });
    }
  }

  // Department search by top input #q
  function attachDeptSearch(){
    const q = document.getElementById('q'); if(!q || q.__deptBound) return;
    q.__deptBound = true;
    q.addEventListener('input', function(){
      if(!isDeptActive()) return; // only when Department tab visible
      const val = this.value.trim().toLowerCase();
      const page = document.getElementById('page-department');
      const tbody = page ? page.querySelector('tbody') : null;
      if(!tbody) return;
      Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
        const txt = tr.textContent.toLowerCase();
        tr.style.display = val ? (txt.includes(val) ? '' : 'none') : '';
      });
    });
  }

  // Run on first Department render (rows arrive async)
  function watchDeptFirstRender(){
    const page = document.getElementById('page-department'); if(!page) return;
    const tbody = page.querySelector('tbody'); if(!tbody) return;
    let done = false;
    const obs = new MutationObserver(()=>{
      if(done) return;
      if(tbody.children.length>0){
        try{ reorderDeptCols(); }catch(e){}
        done = true;
      }
    });
    obs.observe(tbody,{childList:true});
  }

  // Hooks
  document.addEventListener('DOMContentLoaded', function(){
    attachDeptSearch();
    watchDeptFirstRender();
  });
  // When switching tabs or language, try again
  document.addEventListener('click', function(ev){
    const nav = ev.target.closest('.nav-item');
    if(nav && nav.dataset.nav==='department'){
      setTimeout(function(){
        attachDeptSearch();
        reorderDeptCols();
      }, 80);
    }
  });
  window.addEventListener('ecn_lang_changed', function(){
    setTimeout(function(){ reorderDeptCols(); }, 60);
  });
})();
</script>


<!-- SAFE8 fix: Department i18n + refresh data render -->
<script>
(function(){
  const LABELS = {
    en:{ rank:"Rank", ecn:"ECN No.", sub:"Sub ECN", model:"Model", title:"Title",
         before:"Before", after:"After", eff:"Effective", valid:"Valid BOM",
         rom:"ROM master", apply:"Apply date", status:"Status", view:"View" },
    vi:{ rank:"Háº¡ng", ecn:"Sá»‘ ECN", sub:"ECN phá»¥", model:"Model", title:"TiÃªu Ä‘á»",
         before:"TrÆ°á»›c", after:"Sau", eff:"Hiá»‡u lá»±c", valid:"Valid BOM",
         rom:"ROM master", apply:"NgÃ y Ã¡p dá»¥ng", status:"Tráº¡ng thÃ¡i", view:"Xem" },
    ja:{ rank:"ãƒ©ãƒ³ã‚¯", ecn:"ECNç•ªå·", sub:"ã‚µãƒ–ECN", model:"ãƒ¢ãƒ‡ãƒ«", title:"ã‚¿ã‚¤ãƒˆãƒ«",
         before:"å¤‰æ›´å‰", after:"å¤‰æ›´å¾Œ", eff:"æœ‰åŠ¹æ—¥", valid:"Valid BOM",
         rom:"ROMãƒžã‚¹ã‚¿ãƒ¼", apply:"é©ç”¨æ—¥", status:"çŠ¶æ…‹", view:"è¡¨ç¤º" }
  };
  const VARIANTS = {
    rank:["Rank","Háº¡ng","ãƒ©ãƒ³ã‚¯"],
    ecn:["ECN No.","Sá»‘ ECN","ECNç•ªå·"],
    sub:["Sub ECN","ECN phá»¥","ã‚µãƒ–ECN"],
    model:["Model","Model","ãƒ¢ãƒ‡ãƒ«"],
    title:["Title","TiÃªu Ä‘á»","ã‚¿ã‚¤ãƒˆãƒ«"],
    before:["Before","TrÆ°á»›c","å¤‰æ›´å‰"],
    after:["After","Sau","å¤‰æ›´å¾Œ"],
    eff:["Effective","Hiá»‡u lá»±c","æœ‰åŠ¹æ—¥"],
    valid:["Valid BOM","ValidÂ BOM","ValidÂ BOM"],
    rom:["ROM master","ROMãƒžã‚¹ã‚¿ãƒ¼","ROM master"],
    apply:["Apply date","NgÃ y Ã¡p dá»¥ng","é©ç”¨æ—¥"],
    status:["Status","Tráº¡ng thÃ¡i","çŠ¶æ…‹"],
    view:["View","Xem","è¡¨ç¤º"]
  };
  function curLang(){ return localStorage.getItem('ecn_lang') || 'en'; }
  function norm(s){ return String(s||'').replace(/\s+/g,' ').trim(); }
  function localizeDeptHead(){
    const page = document.getElementById('page-department'); if(!page) return;
    const ths = page.querySelectorAll('thead tr.taskbar th'); if(!ths.length) return;
    const L = LABELS[curLang()] || LABELS.en;
    ths.forEach(th=>{
      const txt = norm(th.textContent);
      let key=null;
      for(const k in VARIANTS){
        if(VARIANTS[k].some(v=> norm(v)===txt )){ key=k; break; }
      }
      if(key && L[key]) th.textContent = L[key];
    });
  }
  function hookLanguageEvents(){
    const ids=['langTop','lang'];
    ids.forEach(id=>{
      const sel = document.getElementById(id);
      if(sel && !sel.__safe8Hook){
        sel.__safe8Hook = true;
        sel.addEventListener('change', ()=>{
          setTimeout(()=>{
            try{ localizeDeptHead(); }catch(e){}
            try{ window.dispatchEvent(new Event('ecn_lang_changed')); }catch(e){}
          }, 10);
        });
      }
    });
  }
  function ensureDeptData(){
    const sel = document.getElementById('dDept');
    if(sel && !sel.value && sel.options && sel.options.length){
      sel.value = sel.options[0].value;
    }
    if(typeof window.renderDeptTable === 'function'){
      try{ window.renderDeptTable(); }catch(e){}
    }
  }
  function watchDeptFirstRender(){
    const page = document.getElementById('page-department'); if(!page) return;
    const tbody = page.querySelector('tbody'); if(!tbody) return;
    let done=false;
    const obs = new MutationObserver(()=>{
      if(done) return;
      if(tbody.children.length>0){
        try{ localizeDeptHead(); }catch(e){}
        done=true;
      }
    });
    obs.observe(tbody,{childList:true});
  }
  document.addEventListener('DOMContentLoaded', function(){
    hookLanguageEvents();
    setTimeout(ensureDeptData, 120);
    setTimeout(localizeDeptHead, 150);
    watchDeptFirstRender();
  });
  document.addEventListener('click', function(ev){
    const nav = ev.target.closest('.nav-item');
    if(nav && nav.dataset.nav==='department'){
      setTimeout(()=>{ ensureDeptData(); localizeDeptHead(); }, 80);
    }
  });
  window.addEventListener('ecn_lang_changed', function(){
    setTimeout(localizeDeptHead, 60);
  });
})();
</script>


<!-- SAFE8.orderfix: lock Department column order & status/view at end -->
<script>
(function(){
  function norm(t){ return String(t||'').replace(/\s+/g,' ').trim(); }
  function fixDeptOrder(){
    const page = document.getElementById('page-department'); if(!page) return;
    const table = page.querySelector('table'); if(!table) return;
    const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody');
    if(!thead || !tbody) return;
    const trHead = thead.querySelector('tr.taskbar'); if(!trHead) return;
    const ths = Array.from(trHead.children); if(!ths.length) return;

    const labels = {
      valid: ["Valid BOM","ValidÂ BOM","ValidÂ BOM"],
      rom: ["ROM master","ROMãƒžã‚¹ã‚¿ãƒ¼","ROM master","ROM ãƒžã‚¹ã‚¿ãƒ¼"],
      apply: ["Apply date","NgÃ y Ã¡p dá»¥ng","é©ç”¨æ—¥"],
      status: ["Status","Tráº¡ng thÃ¡i","çŠ¶æ…‹"],
      view: ["View","Xem","è¡¨ç¤º"]
    };
    const findIdx = (names)=>{
      let idx=-1;
      ths.forEach((th,i)=>{ const txt=norm(th.textContent); names.forEach(n=>{ if(idx<0 && norm(n)===txt) idx=i; }); });
      return idx;
    };
    const iValid = findIdx(labels.valid);
    const iROM   = findIdx(labels.rom);
    const iApply = findIdx(labels.apply);
    const iStatus= findIdx(labels.status);
    const iView  = findIdx(labels.view);
    if(iValid<0 || iStatus<0 || iView<0) return;

    const N = ths.length;
    const order = [];
    for(let i=0;i<=iValid;i++) order.push(i);               // up to Valid BOM
    if(iROM>=0 && !order.includes(iROM)) order.push(iROM);  // ROM master
    if(iApply>=0 && !order.includes(iApply)) order.push(iApply); // Apply date
    for(let i=iValid+1;i<N;i++){                             // others, skip status/view if later
      if([iROM,iApply,iStatus,iView].includes(i)) continue;
      if(!order.includes(i)) order.push(i);
    }
    if(!order.includes(iStatus)) order.push(iStatus);        // Status
    if(!order.includes(iView)) order.push(iView);            // View

    // apply header
    const headCells = Array.from(trHead.children);
    const fragH = document.createDocumentFragment();
    order.forEach(i=> fragH.appendChild(headCells[i]));
    trHead.innerHTML=""; trHead.appendChild(fragH);

    // apply rows
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const tds = Array.from(tr.children);
      const frag = document.createDocumentFragment();
      order.forEach(i=> frag.appendChild(tds[i]));
      tr.innerHTML=""; tr.appendChild(frag);
    });

    // center the Status column
    const newIdxStatus = order.indexOf(iStatus);
    if(newIdxStatus>=0){
      Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
        const td = tr.children[newIdxStatus]; if(td) td.style.textAlign='center';
      });
    }
  }

  // Run once rows appear & rerun on mutations (lock order even after re-render)
  function lockDeptOrder(){
    const page = document.getElementById('page-department'); if(!page) return;
    const tbody = page.querySelector('#deptRows'); if(!tbody) return;
    fixDeptOrder();
    if(tbody.__orderLocked) return;
    tbody.__orderLocked = true;
    const obs = new MutationObserver(()=> fixDeptOrder());
    obs.observe(tbody,{childList:true});
  }

  document.addEventListener('DOMContentLoaded', ()=>{ setTimeout(lockDeptOrder, 120); });
  document.addEventListener('click', (ev)=>{
    const nav = ev.target.closest('.nav-item');
    if(nav && nav.dataset.nav==='department'){ setTimeout(lockDeptOrder, 60); }
  });
  window.addEventListener('ecn_lang_changed', ()=>{ setTimeout(lockDeptOrder, 60); });
})();
</script>


<!-- SAFE8.orderfix2: keep Department data when switching language -->
<script>
(function(){
  function ensureDeptData(){
    const sel = document.getElementById('dDept');
    if(sel && !sel.value && sel.options && sel.options.length){
      sel.value = sel.options[0].value;
    }
    if(typeof window.renderDeptTable === 'function'){
      try{ window.renderDeptTable(); }catch(e){}
    }
  }
  // When language changes, re-render department rows (data sometimes cleared by other i18n updates)
  window.addEventListener('ecn_lang_changed', function(){
    // Wait a tick for labels to swap, then render and lock order again
    setTimeout(function(){
      try{ ensureDeptData(); }catch(e){}
      // if table still empty, one more attempt shortly after
      setTimeout(function(){
        const tbody = document.querySelector('#page-department #deptRows');
        if(tbody && tbody.children.length===0){ try{ ensureDeptData(); }catch(e){} }
      }, 120);
    }, 60);
  });
})();
</script>


<!-- SAFE8_compact: Department search + i18n header + order lock + data render on lang/tab -->
<script>
(function(){
  function norm(t){ return String(t||'').replace(/\s+/g,' ').trim(); }
  function isDeptActive(){ const p=document.getElementById('page-department'); return p && p.style.display!=='none'; }

  // ===== i18n for Department header (EN/VI/JA) =====
  const LABELS = {
    en:{ rank:"Rank", ecn:"ECN No.", sub:"Sub ECN", model:"Model", title:"Title",
         before:"Before", after:"After", eff:"Effective", valid:"Valid BOM",
         rom:"ROM master", apply:"Apply date", status:"Status", view:"View" },
    vi:{ rank:"Háº¡ng", ecn:"Sá»‘ ECN", sub:"ECN phá»¥", model:"Model", title:"TiÃªu Ä‘á»",
         before:"TrÆ°á»›c", after:"Sau", eff:"Hiá»‡u lá»±c", valid:"Valid BOM",
         rom:"ROM master", apply:"NgÃ y Ã¡p dá»¥ng", status:"Tráº¡ng thÃ¡i", view:"Xem" },
    ja:{ rank:"ãƒ©ãƒ³ã‚¯", ecn:"ECNç•ªå·", sub:"ã‚µãƒ–ECN", model:"ãƒ¢ãƒ‡ãƒ«", title:"ã‚¿ã‚¤ãƒˆãƒ«",
         before:"å¤‰æ›´å‰", after:"å¤‰æ›´å¾Œ", eff:"æœ‰åŠ¹æ—¥", valid:"Valid BOM",
         rom:"ROMãƒžã‚¹ã‚¿ãƒ¼", apply:"é©ç”¨æ—¥", status:"çŠ¶æ…‹", view:"è¡¨ç¤º" }
  };
  const VARS = {
    rank:["Rank","Háº¡ng","ãƒ©ãƒ³ã‚¯"], ecn:["ECN No.","Sá»‘ ECN","ECNç•ªå·"], sub:["Sub ECN","ECN phá»¥","ã‚µãƒ–ECN"],
    model:["Model","Model","ãƒ¢ãƒ‡ãƒ«"], title:["Title","TiÃªu Ä‘á»","ã‚¿ã‚¤ãƒˆãƒ«"], before:["Before","TrÆ°á»›c","å¤‰æ›´å‰"],
    after:["After","Sau","å¤‰æ›´å¾Œ"], eff:["Effective","Hiá»‡u lá»±c","æœ‰åŠ¹æ—¥"], valid:["Valid BOM","ValidÂ BOM","ValidÂ BOM"],
    rom:["ROM master","ROMãƒžã‚¹ã‚¿ãƒ¼","ROM master","ROM ãƒžã‚¹ã‚¿ãƒ¼"], apply:["Apply date","NgÃ y Ã¡p dá»¥ng","é©ç”¨æ—¥"],
    status:["Status","Tráº¡ng thÃ¡i","çŠ¶æ…‹"], view:["View","Xem","è¡¨ç¤º"]
  };
  function curLang(){ return localStorage.getItem('ecn_lang') || 'en'; }
  function localizeDeptHead(){
    const page=document.getElementById('page-department'); if(!page) return;
    const ths=page.querySelectorAll('thead tr.taskbar th'); if(!ths.length) return;
    const L=LABELS[curLang()]||LABELS.en;
    ths.forEach(th=>{
      const txt=norm(th.textContent); let key=null;
      for(const k in VARS){ if(VARS[k].some(v=>norm(v)===txt)){ key=k; break; } }
      if(key && L[key]) th.textContent=L[key];
    });
  }

  // ===== Lock column order (ROM master & Apply date right after Valid BOM; Status & View at end) =====
  function fixDeptOrder(){
    const page=document.getElementById('page-department'); if(!page) return;
    const table=page.querySelector('table'); if(!table) return;
    const thead=table.querySelector('thead'), tbody=table.querySelector('tbody');
    if(!thead||!tbody) return;
    const trHead=thead.querySelector('tr.taskbar'); if(!trHead) return;
    const ths=Array.from(trHead.children); if(!ths.length) return;

    const find=(names)=>{ let idx=-1; ths.forEach((th,i)=>{ const t=norm(th.textContent); names.forEach(n=>{ if(idx<0 && norm(n)===t) idx=i; }); }); return idx; };
    const iValid=find(VARS.valid), iROM=find(VARS.rom), iApply=find(VARS.apply), iStatus=find(VARS.status), iView=find(VARS.view);
    if(iValid<0 || iStatus<0 || iView<0) return;

    const N=ths.length, order=[];
    for(let i=0;i<=iValid;i++) order.push(i);
    if(iROM>=0 && !order.includes(iROM)) order.push(iROM);
    if(iApply>=0 && !order.includes(iApply)) order.push(iApply);
    for(let i=iValid+1;i<N;i++){ if([iROM,iApply,iStatus,iView].includes(i)) continue; if(!order.includes(i)) order.push(i); }
    if(!order.includes(iStatus)) order.push(iStatus);
    if(!order.includes(iView)) order.push(iView);

    const headCells=Array.from(trHead.children), fragH=document.createDocumentFragment(); trHead.innerHTML="";
    order.forEach(i=> fragH.appendChild(headCells[i])); trHead.appendChild(fragH);
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const tds=Array.from(tr.children), frag=document.createDocumentFragment();
      order.forEach(i=> frag.appendChild(tds[i])); tr.innerHTML=""; tr.appendChild(frag);
    });
    const idxS=order.indexOf(iStatus);
    if(idxS>=0){ Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{ const td=tr.children[idxS]; if(td) td.style.textAlign='center'; }); }
  }
  function lockDeptOrder(){
    const tbody=document.querySelector('#page-department #deptRows'); if(!tbody) return;
    fixDeptOrder();
    if(tbody.__lockObs) return;
    const obs=new MutationObserver(()=>fixDeptOrder()); obs.observe(tbody,{childList:true}); tbody.__lockObs=obs;
  }

  // ===== Department search using top #q when Department is visible =====
  function attachDeptSearch(){
    const q=document.getElementById('q'); if(!q || q.__deptBound) return;
    q.__deptBound=true;
    q.addEventListener('input', function(){
      if(!isDeptActive()) return;
      const val=this.value.trim().toLowerCase();
      const tb=document.querySelector('#page-department tbody'); if(!tb) return;
      Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
        const txt=tr.textContent.toLowerCase();
        tr.style.display = val ? (txt.includes(val)?'':'none') : '';
      });
    });
  }

  // ===== Ensure data exists on refresh / language change =====
  function ensureDeptData(){
    const sel=document.getElementById('dDept'); if(sel && !sel.value && sel.options && sel.options.length) sel.value=sel.options[0].value;
    if(typeof window.renderDeptTable==='function'){ try{ window.renderDeptTable(); }catch(e){} }
  }

  // Hooks
  document.addEventListener('DOMContentLoaded', ()=>{
    attachDeptSearch();
    setTimeout(()=>{ ensureDeptData(); localizeDeptHead(); lockDeptOrder(); }, 120);
  });
  document.addEventListener('click', (ev)=>{
    const nav=ev.target.closest('.nav-item');
    if(nav && nav.dataset.nav==='department'){ setTimeout(()=>{ attachDeptSearch(); ensureDeptData(); localizeDeptHead(); lockDeptOrder(); }, 80); }
  });
  window.addEventListener('ecn_lang_changed', ()=>{ setTimeout(()=>{ ensureDeptData(); localizeDeptHead(); lockDeptOrder(); }, 80); });
})();
</script>



<!-- FIX_ULTRA_CLEAN2: normalize Priority filter values (avoid empty Department in VI/JA) -->
<script>
(function(){
  function norm(s){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); }

  function normalizeDeptPriorityValues(){
    var sel = document.getElementById('dPrio');
    if(!sel) return;
    var map = {
      // All
      "all": "All", "táº¥t cáº£": "All", "tat ca": "All", "ã™ã¹ã¦": "All",
      // High
      "high": "High", "cao": "High", "é«˜": "High",
      // Medium
      "medium": "Medium", "vá»«a": "Medium", "vua": "Medium", "ä¸­": "Medium",
      // Low
      "low": "Low", "tháº¥p": "Low", "thap": "Low", "ä½Ž": "Low"
    };
    Array.prototype.forEach.call(sel.options, function(opt){
      var t = norm(opt.textContent || opt.label || opt.value);
      if(map[t]) opt.value = map[t];
    });
    if(["All","High","Medium","Low"].indexOf(sel.value) === -1){
      // default to All
      var optAll = Array.prototype.find.call(sel.options, function(o){
        var t = norm(o.textContent || o.label || o.value);
        return ["all","táº¥t cáº£","tat ca","ã™ã¹ã¦"].indexOf(t) !== -1 || o.value==="All";
      });
      if(optAll) sel.value = optAll.value || "All";
      else sel.value = "All";
    }
  }

  function ensureDeptNotEmpty(){
    var tbody = document.querySelector('#page-department #deptRows');
    if(tbody && tbody.children.length===0 && typeof window.renderDeptTable==='function'){
      try{ window.renderDeptTable(); }catch(e){}
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(function(){
      normalizeDeptPriorityValues();
      ensureDeptNotEmpty();
    }, 50);
  });

  window.addEventListener('ecn_lang_changed', function(){
    setTimeout(function(){
      normalizeDeptPriorityValues();
      ensureDeptNotEmpty();
    }, 60);
  });
})();
</script>


<!-- AI Advisor Modal (integrated via srcdoc) -->
<div id="aiModal" style="position:fixed;inset:0;background:rgba(2,6,23,.72);backdrop-filter:blur(2px);display:none;z-index:9999">
  <div style="position:absolute;top:20px;left:20px;right:20px;bottom:20px;background:#fff;border-radius:14px;box-shadow:0 20px 60px rgba(2,6,23,.35);overflow:hidden;display:flex;flex-direction:column">
    <div style="padding:10px;border-bottom:1px solid #e5e7eb;display:flex;gap:8px;align-items:center">
      <strong>ECN AI Advisor</strong>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="aiOpenNew" class="btn secondary" style="border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;background:#fff;cursor:pointer">Open in new tab</button>
        <button id="aiClose" class="btn" style="border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;background:#0ea5e9;color:#fff;cursor:pointer">Close</button>
      </div>
    </div>
    <div style="flex:1 1 auto">
      <iframe id="aiFrame" title="ECN AI Advisor" style="width:100%;height:100%;border:0" srcdoc="


<meta charset=&quot;utf-8&quot; />
<meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot; />
<title>ECN AI Advisor â€” Light UI (Chat â€¢ Trace â€¢ Admin)</title>
<link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;>
<link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot; crossorigin>
<link href=&quot;https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap&quot; rel=&quot;stylesheet&quot;>
<style>
  :root{
    --bg:#f6f7fb;
    --panel:#ffffff;
    --muted:#eef2f7;
    --text:#0f172a;
    --text-dim:#4b5563;
    --primary:#2563eb;
    --accent:#0ea5e9;
    --good:#16a34a;
    --warn:#d97706;
    --danger:#dc2626;
    --border:#e5e7eb;
    --radius:14px;
    --shadow:0 6px 20px rgba(15, 23, 42, 0.08);
    --code:#0b1220;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text)}
  .container{max-width:1200px;margin:18px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .title{font-weight:800;letter-spacing:.2px;font-size:20px}
  .badges{display:flex;gap:8px;flex-wrap:wrap}
  .badge{background:var(--muted);color:var(--text-dim);padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:600;color:#334155}
  .tab.active{background:linear-gradient(180deg,#eff6ff,#ffffff);border-color:#c7d2fe;color:#1e3a8a}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:16px}
  .section{padding:16px}
  input,textarea,select,button{
    background:#fff;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 12px;
    font-family:inherit;font-size:14px
  }
  input:focus,textarea:focus,select:focus{outline:3px solid #dbeafe;border-color:transparent}
  button{background:linear-gradient(180deg,#3b82f6,#1d4ed8);color:white;border:none;cursor:pointer}
  button.secondary{background:#fff;color:#1f2937;border:1px solid var(--border)}
  button.ghost{background:transparent;border:1px dashed var(--border);color:#475569}
  button.good{background:linear-gradient(180deg,#22c55e,#15803d)}
  button.warn{background:linear-gradient(180deg,#f59e0b,#b45309)}
  .flex{display:flex;gap:10px}
  .grow{flex:1 1 auto}
  .chat-wrap{padding:0}
  .chat-toolbar{padding:16px;border-bottom:1px solid var(--border);display:flex;gap:10px;flex-wrap:wrap}
  .chat{height:520px;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:14px}
  .msg{display:flex;gap:10px;align-items:flex-start}
  .msg .avatar{width:28px;height:28px;border-radius:50%;background:#dbeafe;border:1px solid #bfdbfe;display:flex;align-items:center;justify-content:center;font-weight:700;color:#1d4ed8}
  .msg.me .avatar{background:#dcfce7;border-color:#bbf7d0;color:#15803d}
  .msg .bubble{
    padding:12px 14px;background:#ffffff;border:1px solid var(--border);border-radius:14px;max-width:100%;box-shadow:var(--shadow)
  }
  .msg.me{justify-content:flex-end}
  .msg.me .bubble{background:#eef2ff;border-color:#c7d2fe}
  .answer{line-height:1.55}
  .answer h4{margin:0 0 8px 0}
  .answer ul{margin:8px 0 0 18px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .hl{color:#1d4ed8;font-weight:700}
  .footer-note{padding:0 16px 16px;color:#64748b;font-size:12px}
  .grid-2{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi .box{background:#fff;border:1px solid var(--border);padding:12px;border-radius:12px;box-shadow:var(--shadow)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;font-size:13px}
  th{text-align:left;color:#334155}
  .pill{display:inline-block;padding:4px 9px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
  .pill.a1{background:#fee2e2;color:#991b1b;border-color:#fecaca}
  .pill.a2{background:#ffedd5;color:#9a3412;border-color:#fed7aa}
  .pill.b{background:#dcfce7;color:#065f46;border-color:#bbf7d0}
  .mermaid{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;overflow:auto}
  .muted{color:#6b7280}
  .right{text-align:right}
  @media (max-width: 960px){
    .grid-2{grid-template-columns:1fr}
    .kpi{grid-template-columns:repeat(2,1fr)}
  }
</style>


<div class=&quot;container&quot;>
  
    <div class=&quot;title&quot;>ECN AI Advisor â€” Light UI (Full-Width Chat)</div>
    <div class=&quot;badges&quot;>
      <span class=&quot;badge&quot;>Light Theme</span>
      <span class=&quot;badge&quot;>Full-width Chat</span>
      <span class=&quot;badge&quot;>Tabbed Layout</span>
    </div>
  

  <!-- Tabs -->
  <div class=&quot;tabs&quot;>
    <button class=&quot;tab active&quot; data-tab=&quot;chatTab&quot;>ðŸ’¬ Chat & Trainer</button>
    <button class=&quot;tab&quot; data-tab=&quot;traceTab&quot;>ðŸ§­ Trace & Lá»‹ch sá»­</button>
    <button class=&quot;tab&quot; data-tab=&quot;adminTab&quot;>ðŸ” Admin Training</button>
  </div>

  <!-- Chat Tab -->
  <div id=&quot;chatTab&quot; class=&quot;card&quot;>
    <div class=&quot;chat-toolbar&quot;>
      <input id=&quot;q&quot; class=&quot;grow&quot; placeholder=&quot;Há»i vá» ECN/Quy trÃ¬nh PSNV/Traceâ€¦ â€¢ vÃ­ dá»¥: ECN viáº¿t táº¯t lÃ  gÃ¬? | Liá»‡t kÃª ECN liÃªn quan mÃ£ A | So sÃ¡nh ECN-2024-118 vÃ  ECN-2025-045&quot;>
      <button id=&quot;ask&quot;>Há»i</button>
      <button id=&quot;clear&quot; class=&quot;secondary&quot;>XoÃ¡</button>
      <button id=&quot;insertExamples&quot; class=&quot;ghost&quot;>Gá»£i Ã½ cÃ¢u há»i</button>
    </div>
    <div id=&quot;chat&quot; class=&quot;chat&quot;></div>
    <div class=&quot;footer-note&quot;>Máº¹o: GÃµ â€œQuy trÃ¬nh ECN táº¡i PSNV?â€, â€œXem chuá»—i thay Ä‘á»•i DC-S9HP9-Kâ€, â€œSo sÃ¡nh ECN-2024-118 vÃ  ECN-2025-045â€.</div>
  </div>

  <div style=&quot;height:16px&quot;></div>

  <!-- Trace Tab -->
  <div id=&quot;traceTab&quot; class=&quot;card&quot; style=&quot;display:none&quot;>
    <h2>Truy váº¿t & Lá»‹ch sá»­ ECN (Demo data)</h2>
    <div class=&quot;section&quot;>
      <div class=&quot;flex&quot;>
        <input id=&quot;traceCode&quot; class=&quot;grow mono&quot; placeholder=&quot;Nháº­p mÃ£ linh kiá»‡n / model â€” vÃ­ dá»¥: A, PNLPV570L1YB-A, DC-S9HP9-K&quot;>
        <button id=&quot;traceBtn&quot;>Truy váº¿t</button>
        <button id=&quot;exportCSV&quot; class=&quot;secondary&quot;>Xuáº¥t CSV</button>
      </div>
    </div>
    <div class=&quot;section&quot;>
      <div class=&quot;kpi&quot;>
        <div class=&quot;box&quot;><div class=&quot;muted&quot;>Tá»•ng ECN</div><div id=&quot;k_total&quot; style=&quot;font-weight:700;font-size:18px&quot;>â€”</div></div>
        <div class=&quot;box&quot;><div class=&quot;muted&quot;>ECN Æ°u tiÃªn A1</div><div id=&quot;k_a1&quot; style=&quot;font-weight:700;font-size:18px&quot;>â€”</div></div>
        <div class=&quot;box&quot;><div class=&quot;muted&quot;>ECN hiá»‡u lá»±c sáº¯p tá»›i</div><div id=&quot;k_due&quot; style=&quot;font-weight:700;font-size:18px&quot;>â€”</div></div>
        <div class=&quot;box&quot;><div class=&quot;muted&quot;>Bá»™ pháº­n liÃªn quan</div><div id=&quot;k_dept&quot; style=&quot;font-weight:700;font-size:18px&quot;>â€”</div></div>
      </div>
    </div>
    <div class=&quot;section&quot;>
      <table id=&quot;tbl&quot;>
        <thead>
          <tr>
            <th>ECN No</th>
            <th>Tráº¡ng thÃ¡i</th>
            <th>Æ¯u tiÃªn</th>
            <th>Valid From</th>
            <th>Part/Model</th>
            <th>Change</th>
            <th>Dept</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class=&quot;section&quot;>
      <div class=&quot;muted&quot;>SÆ¡ Ä‘á»“ quy trÃ¬nh (Mermaid)</div>
      <div class=&quot;flex&quot;>
        <textarea id=&quot;mermaidSrc&quot; class=&quot;grow&quot; rows=&quot;6&quot; placeholder=&quot;Mermaid â€” vÃ­ dá»¥:
flowchart TD
A([Submit ECN]) --> B[AI Parse (OCR)]
B --> C{Validate}
C -->|OK| D[Assign Dept]
C -->|Fail| A
D --> E[Schedule & Notify]
E --> F[Implement @ Line]
F --> G[Approve & eSign]
G --> H[Effective: Lock WI / Release new WI]&quot;></textarea>
        <button id=&quot;renderMermaid&quot; class=&quot;secondary&quot;>Render</button>
      </div>
      <div id=&quot;mermaid&quot; class=&quot;mermaid&quot; style=&quot;margin-top:10px&quot;></div>
    </div>
  </div>

  <!-- Admin Tab -->
  <div id=&quot;adminTab&quot; class=&quot;card&quot; style=&quot;display:none&quot;>
    <h2>ðŸ” Admin Training Â· ThÃªm tri thá»©c (lÆ°u táº¡i trÃ¬nh duyá»‡t)</h2>
    <div class=&quot;section&quot;>
      <div class=&quot;flex&quot;>
        <input id=&quot;adminKey&quot; placeholder=&quot;Nháº­p mÃ£ admin Ä‘á»ƒ má»Ÿ khoÃ¡ tab nÃ y&quot;>
        <button id=&quot;unlock&quot; class=&quot;good&quot;>Má»Ÿ khoÃ¡</button>
        <button id=&quot;lock&quot; class=&quot;secondary&quot;>KhoÃ¡ láº¡i</button>
      </div>
      <p class=&quot;muted&quot; id=&quot;lockHint&quot;>*Máº·c Ä‘á»‹nh bá»‹ khoÃ¡. Sau khi má»Ÿ khoÃ¡, admin cÃ³ thá»ƒ thÃªm/sá»­a tri thá»©c.*</p>
    </div>
    <div id=&quot;adminPanel&quot; class=&quot;section&quot; style=&quot;display:none&quot;>
      <div class=&quot;grid-2&quot;>
        <div>
          <div class=&quot;muted&quot;>Táº¡o cáº·p Há»i/ÄÃ¡p (regex/keywords + markdown ngáº¯n):</div>
          <input id=&quot;adminQ&quot; placeholder=&quot;CÃ¢u há»i (regex/keywords)&quot;>
          <textarea id=&quot;adminA&quot; rows=&quot;6&quot; placeholder=&quot;CÃ¢u tráº£ lá»iâ€¦ (cho phÃ©p xuá»‘ng dÃ²ng)&quot;></textarea>
          <div style=&quot;height:8px&quot;></div>
          <button id=&quot;addQA&quot;>ThÃªm vÃ o KB</button>
          <button id=&quot;exportKB&quot; class=&quot;secondary&quot;>Xuáº¥t KB (.json)</button>
        </div>
        <div>
          <div class=&quot;muted&quot;>Nháº­p KB (.json):</div>
          <input id=&quot;importFile&quot; type=&quot;file&quot; accept=&quot;application/json&quot;>
          <div style=&quot;height:10px&quot;></div>
          <div class=&quot;muted&quot;>Gá»£i Ã½: nÃªn export/backup KB Ä‘á»‹nh ká»³ khi Ä‘Ã£ train xong.</div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Mermaid CDN -->
<script src=&quot;https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js&quot;></script>
<script>
  mermaid.initialize({ startOnLoad: false, theme: 'default' });

  // Simple markdown to HTML (very small subset: **bold**, *italic*, bullets, code ticks)
  function md(s){
    return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>')
      .replace(/`(.+?)`/g,'<span class=&quot;mono&quot;>$1</span>')
      .replace(/\n- (.+)/g,'<br>â€¢ $1')
      .replace(/\n/g,'<br>');
  }

  // Tabs
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('#chatTab,#traceTab,#adminTab').forEach(x=>x.style.display='none');
    document.getElementById(t.dataset.tab).style.display='block';
  }));

  // --- Sample KB and Data ---
  const BASE_KB = [
    {q:/\bECN\b.*(lÃ |viáº¿t táº¯t|Ä‘á»‹nh nghÄ©a)/i, a:`**ECN** = **Engineering Change Notice** (ThÃ´ng bÃ¡o thay Ä‘á»•i ká»¹ thuáº­t).
â€¢ DÃ¹ng Ä‘á»ƒ ghi nháº­nâ€“phÃª duyá»‡tâ€“triá»ƒn khai thay Ä‘á»•i thiáº¿t káº¿/quy trÃ¬nh.
â€¢ Lá»£i Ã­ch: minh báº¡ch, Ä‘á»“ng bá»™, giáº£m lá»—i, cÃ³ hiá»‡u lá»±c & nháº­t kÃ½.`},
    {q:/\bquy trÃ¬nh\b.*psnv|\bpsnv\b.*quy trÃ¬nh/i, a:`**Quy trÃ¬nh ECN táº¡i PSNV â€” 10 bÆ°á»›c:**
1) Ná»™p ECN (PDF/Excel/áº¢nh) â†’ 2) AI trÃ­ch trÆ°á»ng
â†’ 3) Kiá»ƒm tra há»£p lá»‡ â†’ 4) GÃ¡n viá»‡c liÃªn phÃ²ng ban
â†’ 5) LÆ°u & Ä‘á»“ng bá»™ â†’ 6) ThÃ´ng bÃ¡o & dashboard
â†’ 7) Triá»ƒn khai táº¡i xÆ°á»Ÿng â†’ 8) Duyá»‡t & kÃ½ sá»‘
â†’ 9) Tá»›i hiá»‡u lá»±c: lock WI cÅ©, phÃ¡t hÃ nh WI má»›i â†’ 10) Audit & KPI.`},
    {q:/\bkiáº¿n trÃºc\b|\bcáº¥u trÃºc há»‡ thá»‘ng\b|\bhybrid\b/i, a:`**Hybrid Web + Windows:**
â€¢ Web (React) quáº£n lÃ½ & bÃ¡o cÃ¡o; Windows (Tauri/.NET) cho xÆ°á»Ÿng offline.
â€¢ Backend FastAPI + OCR/Parser/RAG + PostgreSQL + File Store.
â€¢ Sync 2 chiá»u Edgeâ†”Server, RBAC, audit, alert hiá»‡u lá»±c.`}
  ];
  const ECN_DATA = [
    {ecn_no:'ECN-2024-118', status:'Approved', priority:'A1', valid_from:'2024-12-20', parts:['A','PNLPV570L1YB-A'], models:['DC-S9HP9-K'], change:'Replace resistor spec', depts:['SMT','QC']},
    {ecn_no:'ECN-2025-045', status:'Assigned', priority:'A2', valid_from:'2025-09-15', parts:['PNLPV570L1WA-A'], models:['DC-S9HP9-K'], change:'Rev WI page 12', depts:['COS','PMS','QC']},
    {ecn_no:'ECN-2025-046', status:'Draft', priority:'B', valid_from:'2025-10-01', parts:['B'], models:['MD-100'], change:'Add DIP step', depts:['DIP','FA']},
    {ecn_no:'ECN-2025-047', status:'Effective', priority:'A1', valid_from:'2025-08-01', parts:['A-REV1'], models:['MD-200'], change:'BoM alt part', depts:['PE','SMT']},
  ];
  const ALIAS = [
    {from:'A', to:'A'}, {from:'A-REV1', to:'A'},
    {from:'PNLPV570L1YB-A', to:'PNLPV570L1YB-A'},
    {from:'PNLPV570L1WA-A', to:'PNLPV570L1WA-A'}
  ];
  const LS_KEY = 'ecn_kb_user';

  function loadUserKB(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch(e){return[]} }
  function saveUserKB(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)) }

  // Chat
  const chat = document.getElementById('chat');
  function appendMsg(who, html){
    const row = document.createElement('div');
    row.className = 'msg ' + (who==='me'?'me':'');
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = (who==='me')?'Y':'AI';
    const bubble = document.createElement('div');
    bubble.className = 'bubble answer';
    bubble.innerHTML = html;
    if(who==='me'){ row.appendChild(bubble); row.appendChild(avatar); } else { row.appendChild(avatar); row.appendChild(bubble); }
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function norm(s){ return (s||'').toString().trim().toLowerCase().replace(/[\s#_-]+/g,'') }
  function aliasMap(code){
    const n = norm(code);
    const found = ALIAS.filter(a => norm(a.from)===n).map(a=>a.to);
    return found.length? found : [code];
  }
  function fuzzyIncludes(hay, needle){
    const nHay = norm(hay), nNd = norm(needle);
    return nHay.includes(nNd) || nNd.includes(nHay);
  }

  function renderTraceMarkdown(code){
    const targets = aliasMap(code);
    const rows = ECN_DATA.filter(e =>
      e.parts.some(p => targets.some(t => fuzzyIncludes(p,t))) ||
      e.models.some(m => targets.some(t => fuzzyIncludes(m,t)))
    ).sort((a,b)=> (a.valid_from<b.valid_from?1:-1));
    if(!rows.length) return md(`KhÃ´ng tÃ¬m tháº¥y ECN liÃªn quan tá»›i **${code}** trong dá»¯ liá»‡u demo.`);
    const items = rows.map(r => `â€¢ **${r.ecn_no}** â€” ${r.status}, Æ°u tiÃªn: ${r.priority}, hiá»‡u lá»±c: ${r.valid_from}
  - Parts/Models: ${[...r.parts, ...r.models].join(', ')}
  - Change: ${r.change}
  - Dept: ${r.depts.join(', ')}`).join('\n');
    return md(`**Káº¿t quáº£ truy váº¿t cho:** \`${code}\`\n${items}\n\n*Gá»£i Ã½:* gÃµ â€œSo sÃ¡nh ECN-2024-118 vÃ  ECN-2025-045â€.`);
  }

  function renderCompareMarkdown(a,b){
    const A = ECN_DATA.find(x=>x.ecn_no===a);
    const B = ECN_DATA.find(x=>x.ecn_no===b);
    if(!A || !B) return md(`KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u demo cho ${a} hoáº·c ${b}.`);
    function setDiff(arr1, arr2){
      const s1 = new Set(arr1), s2 = new Set(arr2);
      const only1 = [...s1].filter(x=>!s2.has(x));
      const only2 = [...s2].filter(x=>!s1.has(x));
      return {only1, only2};
    }
    const pd = setDiff(A.parts, B.parts);
    const mdiff = setDiff(A.models, B.models);
    return md(`**So sÃ¡nh ${a} â†” ${b}**
- Tráº¡ng thÃ¡i: ${A.status} â†” ${B.status}
- Æ¯u tiÃªn: ${A.priority} â†” ${B.priority}
- Hiá»‡u lá»±c: ${A.valid_from} â†” ${B.valid_from}
- Parts chá»‰ á»Ÿ ${a}: ${pd.only1.join(', ') || '(none)'}
- Parts chá»‰ á»Ÿ ${b}: ${pd.only2.join(', ') || '(none)'}
- Models chá»‰ á»Ÿ ${a}: ${mdiff.only1.join(', ') || '(none)'}
- Models chá»‰ á»Ÿ ${b}: ${mdiff.only2.join(', ') || '(none)'}
- Thay Ä‘á»•i: ${A.change} | ${B.change}
- Dept: ${A.depts.join(', ')} | ${B.depts.join(', ')}`);
  }

  function answer(q){
    // user KB first
    for(const item of loadUserKB()){
      try{
        const re = new RegExp(item.q,'i');
        if(re.test(q)) return md(item.a);
      }catch(e){/* ignore */}
    }
    // base KB
    for(const item of BASE_KB){
      if(item.q.test(q)) return md(item.a);
    }
    // intents
    if(/\b(ecn|mÃ£|part|model).*(liÃªn quan|trace|truy|liá»‡t kÃª)/i.test(q) || /\bchuá»—i thay Ä‘á»•i\b/i.test(q)){
      const m = q.match(/(?:mÃ£|part|model)\s+([A-Za-z0-9#\-\_]+)/i);
      const key = m? m[1] : 'A';
      return renderTraceMarkdown(key);
    }
    const mc = q.match(/ECN[-\s]?(\d{4})[-\s]?(\d+).+ECN[-\s]?(\d{4})[-\s]?(\d+)/i);
    if(mc){
      const idA = `ECN-${mc[1]}-${mc[2]}`;
      const idB = `ECN-${mc[3]}-${mc[4]}`;
      return renderCompareMarkdown(idA, idB);
    }
    return md(&quot;MÃ¬nh chÆ°a cÃ³ cÃ¢u tráº£ lá»i. VÃ o tab **Admin Training** Ä‘á»ƒ thÃªm Q/A (regex) â€” hoáº·c thá»­: *ECN viáº¿t táº¯t lÃ  gÃ¬?*&quot;);
  }

  // wire chat
  const qInput = document.getElementById('q');
  document.getElementById('ask').onclick = () => {
    const q = qInput.value.trim(); if(!q) return;
    appendMsg('me', md(q));
    qInput.value='';
    setTimeout(()=> appendMsg('ai', answer(q)), 200);
  };
  document.getElementById('clear').onclick = () => chat.innerHTML='';
  document.getElementById('insertExamples').onclick = () => {
    qInput.value = &quot;Quy trÃ¬nh ECN táº¡i PSNV?&quot;;
    qInput.focus();
  };
  qInput.addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('ask').click(); });

  // Trace table
  const tbody = document.querySelector('#tbl tbody');
  function refreshTable(rows){
    tbody.innerHTML='';
    let deptSet=new Set(), a1=0, due=0;
    const now = new Date();
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class=&quot;mono&quot;>${r.ecn_no}</td>
        <td>${r.status}</td>
        <td><span class=&quot;pill ${r.priority.toLowerCase()}&quot;>${r.priority}</span></td>
        <td class=&quot;mono&quot;>${r.valid_from}</td>
        <td class=&quot;mono&quot;>${[...r.parts, ...r.models].join(', ')}</td>
        <td>${r.change}</td>
        <td>${r.depts.join(', ')}</td>`;
      tbody.appendChild(tr);
      r.depts.forEach(d=>deptSet.add(d));
      if(r.priority==='A1') a1++;
      const diff = (new Date(r.valid_from)-now)/(1000*3600*24);
      if(diff <= 7 && diff >= 0) due++;
    }
    document.getElementById('k_total').textContent = rows.length;
    document.getElementById('k_a1').textContent = a1;
    document.getElementById('k_due').textContent = due;
    document.getElementById('k_dept').textContent = [...deptSet].length;
  }
  refreshTable(ECN_DATA);

  document.getElementById('traceBtn')?.addEventListener('click', () => {
    const code = document.getElementById('traceCode').value.trim() || 'A';
    const targets = aliasMap(code);
    const rows = ECN_DATA.filter(e =>
      e.parts.some(p => targets.some(t => fuzzyIncludes(p,t))) ||
      e.models.some(m => targets.some(t => fuzzyIncludes(m,t)))
    ).sort((a,b)=> (a.valid_from<b.valid_from?1:-1));
    refreshTable(rows);
    appendMsg('ai', renderTraceMarkdown(code));
  });

  // CSV export
  document.getElementById('exportCSV')?.addEventListener('click', () => {
    const headers = ['ECN No','Status','Priority','Valid From','Part/Model','Change','Depts'];
    const lines = [headers.join(',')];
    for(const r of ECN_DATA){
      const row = [
        r.ecn_no, r.status, r.priority, r.valid_from,
        [...r.parts, ...r.models].join(' '),
        r.change.replace(/,/g,';'),
        r.depts.join('|')
      ].map(x=>`&quot;${(x+'').replace(/&quot;/g,'&quot;&quot;')}&quot;`).join(',');
      lines.push(row);
    }
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='ecn_history_sample.csv'; a.click();
    URL.revokeObjectURL(url);
  });

  // Mermaid
  document.getElementById('renderMermaid')?.addEventListener('click', () => {
    const code = document.getElementById('mermaidSrc').value.trim() ||
`flowchart TD
A([Submit ECN]) --> B[AI Parse (OCR)]
B --> C{Validate}
C -->|OK| D[Assign Dept]
C -->|Fail| A
D --> E[Schedule & Notify]
E --> F[Implement @ Line]
F --> G[Approve & eSign]
G --> H[Effective: Lock old WI / Release new WI]`;
    const el = document.getElementById('mermaid');
    el.innerHTML = code.replace(/</g,'&lt;');
    mermaid.render('m1', code, (svg)=>{ el.innerHTML = svg; });
  });

  // Admin lock/unlock
  const ADMIN_UNLOCK_KEY = 'ecn_admin_unlock';
  function isUnlocked(){ return localStorage.getItem(ADMIN_UNLOCK_KEY)==='1' }
  function setUnlocked(v){ localStorage.setItem(ADMIN_UNLOCK_KEY, v?'1':'0') }
  function syncAdminUI(){
    const panel = document.getElementById('adminPanel');
    const hint = document.getElementById('lockHint');
    if(isUnlocked()){ panel.style.display='block'; hint.textContent='*Äang má»Ÿ khoÃ¡ Admin Training.*' }
    else { panel.style.display='none'; hint.textContent='*Máº·c Ä‘á»‹nh bá»‹ khoÃ¡. Sau khi má»Ÿ khoÃ¡, admin cÃ³ thá»ƒ thÃªm/sá»­a tri thá»©c.*' }
  }
  syncAdminUI();

  document.getElementById('unlock').addEventListener('click', () => {
    const key = document.getElementById('adminKey').value.trim();
    // Simple local unlock: accept any non-empty for demo; replace by real auth in production.
    if(!key){ alert('Nháº­p mÃ£ admin (demo cháº¥p nháº­n báº¥t ká»³ chuá»—i nÃ o)'); return; }
    setUnlocked(true); syncAdminUI();
  });
  document.getElementById('lock').addEventListener('click', () => { setUnlocked(false); syncAdminUI(); });

  // Admin add/import/export
  document.getElementById('addQA').addEventListener('click', () => {
    if(!isUnlocked()) return alert('ChÆ°a má»Ÿ khoÃ¡ admin.');
    const q = document.getElementById('adminQ').value.trim();
    const a = document.getElementById('adminA').value.trim();
    if(!q || !a) return alert('Nháº­p Ä‘á»§ cÃ¢u há»i & tráº£ lá»i');
    const kb = loadUserKB(); kb.push({q,a}); saveUserKB(kb);
    document.getElementById('adminQ').value=''; document.getElementById('adminA').value='';
    alert('ÄÃ£ thÃªm vÃ o KB (lÆ°u trong trÃ¬nh duyá»‡t nÃ y).');
  });
  document.getElementById('exportKB').addEventListener('click', () => {
    if(!isUnlocked()) return alert('ChÆ°a má»Ÿ khoÃ¡ admin.');
    const data = JSON.stringify(loadUserKB(), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'ecn_kb_export.json'; a.click(); URL.revokeObjectURL(url);
  });
  document.getElementById('importFile').addEventListener('change', (e) => {
    if(!isUnlocked()) return alert('ChÆ°a má»Ÿ khoÃ¡ admin.');
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const arr = JSON.parse(reader.result);
        if(Array.isArray(arr)){ saveUserKB(arr); alert('ÄÃ£ nháº­p KB.'); }
        else alert('File khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng.');
      }catch(err){ alert('KhÃ´ng Ä‘á»c Ä‘Æ°á»£c JSON.'); }
    };
    reader.readAsText(f);
  });
</script>


"></iframe>
    </div>
  </div>
</div>


<script>
(function(){
  var aiBtn = document.getElementById('openAI') || document.querySelector('.ai-launch');
  var modal = document.getElementById('aiModal');
  var closeBtn = document.getElementById('aiClose');
  var openNew = document.getElementById('aiOpenNew');
  if(aiBtn && modal){
    aiBtn.addEventListener('click', function(e){ e.preventDefault(); modal.style.display = 'block'; });
  }
  if(closeBtn){
    closeBtn.addEventListener('click', function(){ modal.style.display = 'none'; });
  }
  if(openNew){
    openNew.addEventListener('click', function(){
      var html = atob("CjwhRE9DVFlQRSBodG1sPgo8aHRtbCBsYW5nPSJ2aSI+CjxoZWFkPgo8bWV0YSBjaGFyc2V0PSJ1dGYtOCIgLz4KPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIiAvPgo8dGl0bGU+RUNOIEFJIEFkdmlzb3Ig4oCUIExpZ2h0IFVJIChDaGF0IOKAoiBUcmFjZSDigKIgQWRtaW4pPC90aXRsZT4KPGxpbmsgcmVsPSJwcmVjb25uZWN0IiBocmVmPSJodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tIj4KPGxpbmsgcmVsPSJwcmVjb25uZWN0IiBocmVmPSJodHRwczovL2ZvbnRzLmdzdGF0aWMuY29tIiBjcm9zc29yaWdpbj4KPGxpbmsgaHJlZj0iaHR0cHM6Ly9mb250cy5nb29nbGVhcGlzLmNvbS9jc3MyP2ZhbWlseT1JbnRlcjp3Z2h0QDQwMDs2MDA7NzAwJmRpc3BsYXk9c3dhcCIgcmVsPSJzdHlsZXNoZWV0Ij4KPHN0eWxlPgogIDpyb290ewogICAgLS1iZzojZjZmN2ZiOwogICAgLS1wYW5lbDojZmZmZmZmOwogICAgLS1tdXRlZDojZWVmMmY3OwogICAgLS10ZXh0OiMwZjE3MmE7CiAgICAtLXRleHQtZGltOiM0YjU1NjM7CiAgICAtLXByaW1hcnk6IzI1NjNlYjsKICAgIC0tYWNjZW50OiMwZWE1ZTk7CiAgICAtLWdvb2Q6IzE2YTM0YTsKICAgIC0td2FybjojZDk3NzA2OwogICAgLS1kYW5nZXI6I2RjMjYyNjsKICAgIC0tYm9yZGVyOiNlNWU3ZWI7CiAgICAtLXJhZGl1czoxNHB4OwogICAgLS1zaGFkb3c6MCA2cHggMjBweCByZ2JhKDE1LCAyMywgNDIsIDAuMDgpOwogICAgLS1jb2RlOiMwYjEyMjA7CiAgfQogICp7Ym94LXNpemluZzpib3JkZXItYm94fQogIGh0bWwsYm9keXtoZWlnaHQ6MTAwJX0KICBib2R5e21hcmdpbjowO2JhY2tncm91bmQ6dmFyKC0tYmcpO2ZvbnQtZmFtaWx5OkludGVyLHN5c3RlbS11aSwtYXBwbGUtc3lzdGVtLFNlZ29lIFVJLFJvYm90byxBcmlhbDtjb2xvcjp2YXIoLS10ZXh0KX0KICAuY29udGFpbmVye21heC13aWR0aDoxMjAwcHg7bWFyZ2luOjE4cHggYXV0bztwYWRkaW5nOjAgMTZweH0KICBoZWFkZXJ7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjttYXJnaW4tYm90dG9tOjE0cHh9CiAgLnRpdGxle2ZvbnQtd2VpZ2h0OjgwMDtsZXR0ZXItc3BhY2luZzouMnB4O2ZvbnQtc2l6ZToyMHB4fQogIC5iYWRnZXN7ZGlzcGxheTpmbGV4O2dhcDo4cHg7ZmxleC13cmFwOndyYXB9CiAgLmJhZGdle2JhY2tncm91bmQ6dmFyKC0tbXV0ZWQpO2NvbG9yOnZhcigtLXRleHQtZGltKTtwYWRkaW5nOjZweCAxMHB4O2JvcmRlci1yYWRpdXM6OTk5cHg7Zm9udC1zaXplOjEycHg7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpfQogIC50YWJze2Rpc3BsYXk6ZmxleDtnYXA6OHB4O21hcmdpbi1ib3R0b206MTJweDtmbGV4LXdyYXA6d3JhcH0KICAudGFie3BhZGRpbmc6MTBweCAxNHB4O2JvcmRlci1yYWRpdXM6OTk5cHg7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JhY2tncm91bmQ6I2ZmZjtjdXJzb3I6cG9pbnRlcjtmb250LXdlaWdodDo2MDA7Y29sb3I6IzMzNDE1NX0KICAudGFiLmFjdGl2ZXtiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxODBkZWcsI2VmZjZmZiwjZmZmZmZmKTtib3JkZXItY29sb3I6I2M3ZDJmZTtjb2xvcjojMWUzYThhfQogIC5jYXJke2JhY2tncm91bmQ6dmFyKC0tcGFuZWwpO2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtib3JkZXItcmFkaXVzOnZhcigtLXJhZGl1cyk7Ym94LXNoYWRvdzp2YXIoLS1zaGFkb3cpfQogIC5jYXJkIGgye21hcmdpbjowO3BhZGRpbmc6MTRweCAxNnB4O2JvcmRlci1ib3R0b206MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Zm9udC1zaXplOjE2cHh9CiAgLnNlY3Rpb257cGFkZGluZzoxNnB4fQogIGlucHV0LHRleHRhcmVhLHNlbGVjdCxidXR0b257CiAgICBiYWNrZ3JvdW5kOiNmZmY7Y29sb3I6dmFyKC0tdGV4dCk7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JvcmRlci1yYWRpdXM6MTJweDtwYWRkaW5nOjEwcHggMTJweDsKICAgIGZvbnQtZmFtaWx5OmluaGVyaXQ7Zm9udC1zaXplOjE0cHgKICB9CiAgaW5wdXQ6Zm9jdXMsdGV4dGFyZWE6Zm9jdXMsc2VsZWN0OmZvY3Vze291dGxpbmU6M3B4IHNvbGlkICNkYmVhZmU7Ym9yZGVyLWNvbG9yOnRyYW5zcGFyZW50fQogIGJ1dHRvbntiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxODBkZWcsIzNiODJmNiwjMWQ0ZWQ4KTtjb2xvcjp3aGl0ZTtib3JkZXI6bm9uZTtjdXJzb3I6cG9pbnRlcn0KICBidXR0b24uc2Vjb25kYXJ5e2JhY2tncm91bmQ6I2ZmZjtjb2xvcjojMWYyOTM3O2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKX0KICBidXR0b24uZ2hvc3R7YmFja2dyb3VuZDp0cmFuc3BhcmVudDtib3JkZXI6MXB4IGRhc2hlZCB2YXIoLS1ib3JkZXIpO2NvbG9yOiM0NzU1Njl9CiAgYnV0dG9uLmdvb2R7YmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCMyMmM1NWUsIzE1ODAzZCl9CiAgYnV0dG9uLndhcm57YmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCNmNTllMGIsI2I0NTMwOSl9CiAgLmZsZXh7ZGlzcGxheTpmbGV4O2dhcDoxMHB4fQogIC5ncm93e2ZsZXg6MSAxIGF1dG99CiAgLmNoYXQtd3JhcHtwYWRkaW5nOjB9CiAgLmNoYXQtdG9vbGJhcntwYWRkaW5nOjE2cHg7Ym9yZGVyLWJvdHRvbToxcHggc29saWQgdmFyKC0tYm9yZGVyKTtkaXNwbGF5OmZsZXg7Z2FwOjEwcHg7ZmxleC13cmFwOndyYXB9CiAgLmNoYXR7aGVpZ2h0OjUyMHB4O292ZXJmbG93OmF1dG87cGFkZGluZzoxOHB4O2Rpc3BsYXk6ZmxleDtmbGV4LWRpcmVjdGlvbjpjb2x1bW47Z2FwOjE0cHh9CiAgLm1zZ3tkaXNwbGF5OmZsZXg7Z2FwOjEwcHg7YWxpZ24taXRlbXM6ZmxleC1zdGFydH0KICAubXNnIC5hdmF0YXJ7d2lkdGg6MjhweDtoZWlnaHQ6MjhweDtib3JkZXItcmFkaXVzOjUwJTtiYWNrZ3JvdW5kOiNkYmVhZmU7Ym9yZGVyOjFweCBzb2xpZCAjYmZkYmZlO2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7anVzdGlmeS1jb250ZW50OmNlbnRlcjtmb250LXdlaWdodDo3MDA7Y29sb3I6IzFkNGVkOH0KICAubXNnLm1lIC5hdmF0YXJ7YmFja2dyb3VuZDojZGNmY2U3O2JvcmRlci1jb2xvcjojYmJmN2QwO2NvbG9yOiMxNTgwM2R9CiAgLm1zZyAuYnViYmxlewogICAgcGFkZGluZzoxMnB4IDE0cHg7YmFja2dyb3VuZDojZmZmZmZmO2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtib3JkZXItcmFkaXVzOjE0cHg7bWF4LXdpZHRoOjEwMCU7Ym94LXNoYWRvdzp2YXIoLS1zaGFkb3cpCiAgfQogIC5tc2cubWV7anVzdGlmeS1jb250ZW50OmZsZXgtZW5kfQogIC5tc2cubWUgLmJ1YmJsZXtiYWNrZ3JvdW5kOiNlZWYyZmY7Ym9yZGVyLWNvbG9yOiNjN2QyZmV9CiAgLmFuc3dlcntsaW5lLWhlaWdodDoxLjU1fQogIC5hbnN3ZXIgaDR7bWFyZ2luOjAgMCA4cHggMH0KICAuYW5zd2VyIHVse21hcmdpbjo4cHggMCAwIDE4cHh9CiAgLm1vbm97Zm9udC1mYW1pbHk6dWktbW9ub3NwYWNlLE1lbmxvLENvbnNvbGFzLG1vbm9zcGFjZX0KICAuaGx7Y29sb3I6IzFkNGVkODtmb250LXdlaWdodDo3MDB9CiAgLmZvb3Rlci1ub3Rle3BhZGRpbmc6MCAxNnB4IDE2cHg7Y29sb3I6IzY0NzQ4Yjtmb250LXNpemU6MTJweH0KICAuZ3JpZC0ye2Rpc3BsYXk6Z3JpZDtncmlkLXRlbXBsYXRlLWNvbHVtbnM6MmZyIDFmcjtnYXA6MTZweH0KICAua3Bpe2Rpc3BsYXk6Z3JpZDtncmlkLXRlbXBsYXRlLWNvbHVtbnM6cmVwZWF0KDQsMWZyKTtnYXA6MTBweH0KICAua3BpIC5ib3h7YmFja2dyb3VuZDojZmZmO2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKTtwYWRkaW5nOjEycHg7Ym9yZGVyLXJhZGl1czoxMnB4O2JveC1zaGFkb3c6dmFyKC0tc2hhZG93KX0KICB0YWJsZXt3aWR0aDoxMDAlO2JvcmRlci1jb2xsYXBzZTpjb2xsYXBzZX0KICB0aCx0ZHtib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO3BhZGRpbmc6OHB4O2ZvbnQtc2l6ZToxM3B4fQogIHRoe3RleHQtYWxpZ246bGVmdDtjb2xvcjojMzM0MTU1fQogIC5waWxse2Rpc3BsYXk6aW5saW5lLWJsb2NrO3BhZGRpbmc6NHB4IDlweDtib3JkZXItcmFkaXVzOjk5OXB4O2ZvbnQtc2l6ZToxMnB4O2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyKX0KICAucGlsbC5hMXtiYWNrZ3JvdW5kOiNmZWUyZTI7Y29sb3I6Izk5MWIxYjtib3JkZXItY29sb3I6I2ZlY2FjYX0KICAucGlsbC5hMntiYWNrZ3JvdW5kOiNmZmVkZDU7Y29sb3I6IzlhMzQxMjtib3JkZXItY29sb3I6I2ZlZDdhYX0KICAucGlsbC5ie2JhY2tncm91bmQ6I2RjZmNlNztjb2xvcjojMDY1ZjQ2O2JvcmRlci1jb2xvcjojYmJmN2QwfQogIC5tZXJtYWlke2JhY2tncm91bmQ6I2ZmZjtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlcik7Ym9yZGVyLXJhZGl1czoxMnB4O3BhZGRpbmc6MTBweDtvdmVyZmxvdzphdXRvfQogIC5tdXRlZHtjb2xvcjojNmI3MjgwfQogIC5yaWdodHt0ZXh0LWFsaWduOnJpZ2h0fQogIEBtZWRpYSAobWF4LXdpZHRoOiA5NjBweCl7CiAgICAuZ3JpZC0ye2dyaWQtdGVtcGxhdGUtY29sdW1uczoxZnJ9CiAgICAua3Bpe2dyaWQtdGVtcGxhdGUtY29sdW1uczpyZXBlYXQoMiwxZnIpfQogIH0KPC9zdHlsZT4KPC9oZWFkPgo8Ym9keT4KPGRpdiBjbGFzcz0iY29udGFpbmVyIj4KICA8aGVhZGVyPgogICAgPGRpdiBjbGFzcz0idGl0bGUiPkVDTiBBSSBBZHZpc29yIOKAlCBMaWdodCBVSSAoRnVsbC1XaWR0aCBDaGF0KTwvZGl2PgogICAgPGRpdiBjbGFzcz0iYmFkZ2VzIj4KICAgICAgPHNwYW4gY2xhc3M9ImJhZGdlIj5MaWdodCBUaGVtZTwvc3Bhbj4KICAgICAgPHNwYW4gY2xhc3M9ImJhZGdlIj5GdWxsLXdpZHRoIENoYXQ8L3NwYW4+CiAgICAgIDxzcGFuIGNsYXNzPSJiYWRnZSI+VGFiYmVkIExheW91dDwvc3Bhbj4KICAgIDwvZGl2PgogIDwvaGVhZGVyPgoKICA8IS0tIFRhYnMgLS0+CiAgPGRpdiBjbGFzcz0idGFicyI+CiAgICA8YnV0dG9uIGNsYXNzPSJ0YWIgYWN0aXZlIiBkYXRhLXRhYj0iY2hhdFRhYiI+8J+SrCBDaGF0ICYgVHJhaW5lcjwvYnV0dG9uPgogICAgPGJ1dHRvbiBjbGFzcz0idGFiIiBkYXRhLXRhYj0idHJhY2VUYWIiPvCfp60gVHJhY2UgJiBM4buLY2ggc+G7rTwvYnV0dG9uPgogICAgPGJ1dHRvbiBjbGFzcz0idGFiIiBkYXRhLXRhYj0iYWRtaW5UYWIiPvCflJAgQWRtaW4gVHJhaW5pbmc8L2J1dHRvbj4KICA8L2Rpdj4KCiAgPCEtLSBDaGF0IFRhYiAtLT4KICA8ZGl2IGlkPSJjaGF0VGFiIiBjbGFzcz0iY2FyZCI+CiAgICA8ZGl2IGNsYXNzPSJjaGF0LXRvb2xiYXIiPgogICAgICA8aW5wdXQgaWQ9InEiIGNsYXNzPSJncm93IiBwbGFjZWhvbGRlcj0iSOG7j2kgduG7gSBFQ04vUXV5IHRyw6xuaCBQU05WL1RyYWNl4oCmIOKAoiB2w60gZOG7pTogRUNOIHZp4bq/dCB04bqvdCBsw6AgZ8OsPyB8IExp4buHdCBrw6ogRUNOIGxpw6puIHF1YW4gbcOjIEEgfCBTbyBzw6FuaCBFQ04tMjAyNC0xMTggdsOgIEVDTi0yMDI1LTA0NSI+CiAgICAgIDxidXR0b24gaWQ9ImFzayI+SOG7j2k8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBpZD0iY2xlYXIiIGNsYXNzPSJzZWNvbmRhcnkiPlhvw6E8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBpZD0iaW5zZXJ0RXhhbXBsZXMiIGNsYXNzPSJnaG9zdCI+R+G7o2kgw70gY8OidSBo4buPaTwvYnV0dG9uPgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJjaGF0IiBjbGFzcz0iY2hhdCI+PC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJmb290ZXItbm90ZSI+TeG6uW86IEfDtSDigJxRdXkgdHLDrG5oIEVDTiB04bqhaSBQU05WP+KAnSwg4oCcWGVtIGNodeG7l2kgdGhheSDEkeG7lWkgREMtUzlIUDktS+KAnSwg4oCcU28gc8OhbmggRUNOLTIwMjQtMTE4IHbDoCBFQ04tMjAyNS0wNDXigJ0uPC9kaXY+CiAgPC9kaXY+CgogIDxkaXYgc3R5bGU9ImhlaWdodDoxNnB4Ij48L2Rpdj4KCiAgPCEtLSBUcmFjZSBUYWIgLS0+CiAgPGRpdiBpZD0idHJhY2VUYWIiIGNsYXNzPSJjYXJkIiBzdHlsZT0iZGlzcGxheTpub25lIj4KICAgIDxoMj5UcnV5IHbhur90ICYgTOG7i2NoIHPhu60gRUNOIChEZW1vIGRhdGEpPC9oMj4KICAgIDxkaXYgY2xhc3M9InNlY3Rpb24iPgogICAgICA8ZGl2IGNsYXNzPSJmbGV4Ij4KICAgICAgICA8aW5wdXQgaWQ9InRyYWNlQ29kZSIgY2xhc3M9Imdyb3cgbW9ubyIgcGxhY2Vob2xkZXI9Ik5o4bqtcCBtw6MgbGluaCBraeG7h24gLyBtb2RlbCDigJQgdsOtIGThu6U6IEEsIFBOTFBWNTcwTDFZQi1BLCBEQy1TOUhQOS1LIj4KICAgICAgICA8YnV0dG9uIGlkPSJ0cmFjZUJ0biI+VHJ1eSB24bq/dDwvYnV0dG9uPgogICAgICAgIDxidXR0b24gaWQ9ImV4cG9ydENTViIgY2xhc3M9InNlY29uZGFyeSI+WHXhuqV0IENTVjwvYnV0dG9uPgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBjbGFzcz0ic2VjdGlvbiI+CiAgICAgIDxkaXYgY2xhc3M9ImtwaSI+CiAgICAgICAgPGRpdiBjbGFzcz0iYm94Ij48ZGl2IGNsYXNzPSJtdXRlZCI+VOG7lW5nIEVDTjwvZGl2PjxkaXYgaWQ9ImtfdG90YWwiIHN0eWxlPSJmb250LXdlaWdodDo3MDA7Zm9udC1zaXplOjE4cHgiPuKAlDwvZGl2PjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImJveCI+PGRpdiBjbGFzcz0ibXV0ZWQiPkVDTiDGsHUgdGnDqm4gQTE8L2Rpdj48ZGl2IGlkPSJrX2ExIiBzdHlsZT0iZm9udC13ZWlnaHQ6NzAwO2ZvbnQtc2l6ZToxOHB4Ij7igJQ8L2Rpdj48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJib3giPjxkaXYgY2xhc3M9Im11dGVkIj5FQ04gaGnhu4d1IGzhu7FjIHPhuq9wIHThu5tpPC9kaXY+PGRpdiBpZD0ia19kdWUiIHN0eWxlPSJmb250LXdlaWdodDo3MDA7Zm9udC1zaXplOjE4cHgiPuKAlDwvZGl2PjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImJveCI+PGRpdiBjbGFzcz0ibXV0ZWQiPkLhu5kgcGjhuq1uIGxpw6puIHF1YW48L2Rpdj48ZGl2IGlkPSJrX2RlcHQiIHN0eWxlPSJmb250LXdlaWdodDo3MDA7Zm9udC1zaXplOjE4cHgiPuKAlDwvZGl2PjwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICAgPGRpdiBjbGFzcz0ic2VjdGlvbiI+CiAgICAgIDx0YWJsZSBpZD0idGJsIj4KICAgICAgICA8dGhlYWQ+CiAgICAgICAgICA8dHI+CiAgICAgICAgICAgIDx0aD5FQ04gTm88L3RoPgogICAgICAgICAgICA8dGg+VHLhuqFuZyB0aMOhaTwvdGg+CiAgICAgICAgICAgIDx0aD7Gr3UgdGnDqm48L3RoPgogICAgICAgICAgICA8dGg+VmFsaWQgRnJvbTwvdGg+CiAgICAgICAgICAgIDx0aD5QYXJ0L01vZGVsPC90aD4KICAgICAgICAgICAgPHRoPkNoYW5nZTwvdGg+CiAgICAgICAgICAgIDx0aD5EZXB0PC90aD4KICAgICAgICAgIDwvdHI+CiAgICAgICAgPC90aGVhZD4KICAgICAgICA8dGJvZHk+PC90Ym9keT4KICAgICAgPC90YWJsZT4KICAgIDwvZGl2PgogICAgPGRpdiBjbGFzcz0ic2VjdGlvbiI+CiAgICAgIDxkaXYgY2xhc3M9Im11dGVkIj5TxqEgxJHhu5MgcXV5IHRyw6xuaCAoTWVybWFpZCk8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0iZmxleCI+CiAgICAgICAgPHRleHRhcmVhIGlkPSJtZXJtYWlkU3JjIiBjbGFzcz0iZ3JvdyIgcm93cz0iNiIgcGxhY2Vob2xkZXI9Ik1lcm1haWQg4oCUIHbDrSBk4bulOgpmbG93Y2hhcnQgVEQKQShbU3VibWl0IEVDTl0pIC0tPiBCW0FJIFBhcnNlIChPQ1IpXQpCIC0tPiBDe1ZhbGlkYXRlfQpDIC0tPnxPS3wgRFtBc3NpZ24gRGVwdF0KQyAtLT58RmFpbHwgQQpEIC0tPiBFW1NjaGVkdWxlICYgTm90aWZ5XQpFIC0tPiBGW0ltcGxlbWVudCBAIExpbmVdCkYgLS0+IEdbQXBwcm92ZSAmIGVTaWduXQpHIC0tPiBIW0VmZmVjdGl2ZTogTG9jayBXSSAvIFJlbGVhc2UgbmV3IFdJXSI+PC90ZXh0YXJlYT4KICAgICAgICA8YnV0dG9uIGlkPSJyZW5kZXJNZXJtYWlkIiBjbGFzcz0ic2Vjb25kYXJ5Ij5SZW5kZXI8L2J1dHRvbj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9Im1lcm1haWQiIGNsYXNzPSJtZXJtYWlkIiBzdHlsZT0ibWFyZ2luLXRvcDoxMHB4Ij48L2Rpdj4KICAgIDwvZGl2PgogIDwvZGl2PgoKICA8IS0tIEFkbWluIFRhYiAtLT4KICA8ZGl2IGlkPSJhZG1pblRhYiIgY2xhc3M9ImNhcmQiIHN0eWxlPSJkaXNwbGF5Om5vbmUiPgogICAgPGgyPvCflJAgQWRtaW4gVHJhaW5pbmcgwrcgVGjDqm0gdHJpIHRo4bupYyAobMawdSB04bqhaSB0csOsbmggZHV54buHdCk8L2gyPgogICAgPGRpdiBjbGFzcz0ic2VjdGlvbiI+CiAgICAgIDxkaXYgY2xhc3M9ImZsZXgiPgogICAgICAgIDxpbnB1dCBpZD0iYWRtaW5LZXkiIHBsYWNlaG9sZGVyPSJOaOG6rXAgbcOjIGFkbWluIMSR4buDIG3hu58ga2hvw6EgdGFiIG7DoHkiPgogICAgICAgIDxidXR0b24gaWQ9InVubG9jayIgY2xhc3M9Imdvb2QiPk3hu58ga2hvw6E8L2J1dHRvbj4KICAgICAgICA8YnV0dG9uIGlkPSJsb2NrIiBjbGFzcz0ic2Vjb25kYXJ5Ij5LaG/DoSBs4bqhaTwvYnV0dG9uPgogICAgICA8L2Rpdj4KICAgICAgPHAgY2xhc3M9Im11dGVkIiBpZD0ibG9ja0hpbnQiPipN4bq3YyDEkeG7i25oIGLhu4sga2hvw6EuIFNhdSBraGkgbeG7nyBraG/DoSwgYWRtaW4gY8OzIHRo4buDIHRow6ptL3Phu61hIHRyaSB0aOG7qWMuKjwvcD4KICAgIDwvZGl2PgogICAgPGRpdiBpZD0iYWRtaW5QYW5lbCIgY2xhc3M9InNlY3Rpb24iIHN0eWxlPSJkaXNwbGF5Om5vbmUiPgogICAgICA8ZGl2IGNsYXNzPSJncmlkLTIiPgogICAgICAgIDxkaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJtdXRlZCI+VOG6oW8gY+G6t3AgSOG7j2kvxJDDoXAgKHJlZ2V4L2tleXdvcmRzICsgbWFya2Rvd24gbmfhuq9uKTo8L2Rpdj4KICAgICAgICAgIDxpbnB1dCBpZD0iYWRtaW5RIiBwbGFjZWhvbGRlcj0iQ8OidSBo4buPaSAocmVnZXgva2V5d29yZHMpIj4KICAgICAgICAgIDx0ZXh0YXJlYSBpZD0iYWRtaW5BIiByb3dzPSI2IiBwbGFjZWhvbGRlcj0iQ8OidSB0cuG6oyBs4budaeKApiAoY2hvIHBow6lwIHh14buRbmcgZMOybmcpIj48L3RleHRhcmVhPgogICAgICAgICAgPGRpdiBzdHlsZT0iaGVpZ2h0OjhweCI+PC9kaXY+CiAgICAgICAgICA8YnV0dG9uIGlkPSJhZGRRQSI+VGjDqm0gdsOgbyBLQjwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBpZD0iZXhwb3J0S0IiIGNsYXNzPSJzZWNvbmRhcnkiPlh14bqldCBLQiAoLmpzb24pPC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im11dGVkIj5OaOG6rXAgS0IgKC5qc29uKTo8L2Rpdj4KICAgICAgICAgIDxpbnB1dCBpZD0iaW1wb3J0RmlsZSIgdHlwZT0iZmlsZSIgYWNjZXB0PSJhcHBsaWNhdGlvbi9qc29uIj4KICAgICAgICAgIDxkaXYgc3R5bGU9ImhlaWdodDoxMHB4Ij48L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9Im11dGVkIj5H4bujaSDDvTogbsOqbiBleHBvcnQvYmFja3VwIEtCIMSR4buLbmgga+G7syBraGkgxJHDoyB0cmFpbiB4b25nLjwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogIDwvZGl2PgoKPC9kaXY+Cgo8IS0tIE1lcm1haWQgQ0ROIC0tPgo8c2NyaXB0IHNyYz0iaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9tZXJtYWlkQDEwL2Rpc3QvbWVybWFpZC5taW4uanMiPjwvc2NyaXB0Pgo8c2NyaXB0PgogIG1lcm1haWQuaW5pdGlhbGl6ZSh7IHN0YXJ0T25Mb2FkOiBmYWxzZSwgdGhlbWU6ICdkZWZhdWx0JyB9KTsKCiAgLy8gU2ltcGxlIG1hcmtkb3duIHRvIEhUTUwgKHZlcnkgc21hbGwgc3Vic2V0OiAqKmJvbGQqKiwgKml0YWxpYyosIGJ1bGxldHMsIGNvZGUgdGlja3MpCiAgZnVuY3Rpb24gbWQocyl7CiAgICByZXR1cm4gKHN8fCcnKS5yZXBsYWNlKC8mL2csJyZhbXA7JykucmVwbGFjZSgvPC9nLCcmbHQ7JykucmVwbGFjZSgvPi9nLCcmZ3Q7JykKICAgICAgLnJlcGxhY2UoL1wqXCooLis/KVwqXCovZywnPHN0cm9uZz4kMTwvc3Ryb25nPicpCiAgICAgIC5yZXBsYWNlKC9cKiguKz8pXCovZywnPGVtPiQxPC9lbT4nKQogICAgICAucmVwbGFjZSgvYCguKz8pYC9nLCc8c3BhbiBjbGFzcz0ibW9ubyI+JDE8L3NwYW4+JykKICAgICAgLnJlcGxhY2UoL1xuLSAoLispL2csJzxicj7igKIgJDEnKQogICAgICAucmVwbGFjZSgvXG4vZywnPGJyPicpOwogIH0KCiAgLy8gVGFicwogIGNvbnN0IHRhYnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiJyk7CiAgdGFicy5mb3JFYWNoKHQgPT4gdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgIHRhYnMuZm9yRWFjaCh4PT54LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpKTsKICAgIHQuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcjY2hhdFRhYiwjdHJhY2VUYWIsI2FkbWluVGFiJykuZm9yRWFjaCh4PT54LnN0eWxlLmRpc3BsYXk9J25vbmUnKTsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHQuZGF0YXNldC50YWIpLnN0eWxlLmRpc3BsYXk9J2Jsb2NrJzsKICB9KSk7CgogIC8vIC0tLSBTYW1wbGUgS0IgYW5kIERhdGEgLS0tCiAgY29uc3QgQkFTRV9LQiA9IFsKICAgIHtxOi9cYkVDTlxiLioobMOgfHZp4bq/dCB04bqvdHzEkeG7i25oIG5naMSpYSkvaSwgYTpgKipFQ04qKiA9ICoqRW5naW5lZXJpbmcgQ2hhbmdlIE5vdGljZSoqIChUaMO0bmcgYsOhbyB0aGF5IMSR4buVaSBr4bu5IHRodeG6rXQpLgrigKIgRMO5bmcgxJHhu4MgZ2hpIG5o4bqtbuKAk3Bow6ogZHV54buHdOKAk3RyaeG7g24ga2hhaSB0aGF5IMSR4buVaSB0aGnhur90IGvhur8vcXV5IHRyw6xuaC4K4oCiIEzhu6NpIMOtY2g6IG1pbmggYuG6oWNoLCDEkeG7k25nIGLhu5ksIGdp4bqjbSBs4buXaSwgY8OzIGhp4buHdSBs4buxYyAmIG5o4bqtdCBrw70uYH0sCiAgICB7cTovXGJxdXkgdHLDrG5oXGIuKnBzbnZ8XGJwc252XGIuKnF1eSB0csOsbmgvaSwgYTpgKipRdXkgdHLDrG5oIEVDTiB04bqhaSBQU05WIOKAlCAxMCBixrDhu5tjOioqCjEpIE7hu5lwIEVDTiAoUERGL0V4Y2VsL+G6om5oKSDihpIgMikgQUkgdHLDrWNoIHRyxrDhu51uZwrihpIgMykgS2nhu4NtIHRyYSBo4bujcCBs4buHIOKGkiA0KSBHw6FuIHZp4buHYyBsacOqbiBwaMOybmcgYmFuCuKGkiA1KSBMxrB1ICYgxJHhu5NuZyBi4buZIOKGkiA2KSBUaMO0bmcgYsOhbyAmIGRhc2hib2FyZArihpIgNykgVHJp4buDbiBraGFpIHThuqFpIHjGsOG7n25nIOKGkiA4KSBEdXnhu4d0ICYga8O9IHPhu5EK4oaSIDkpIFThu5tpIGhp4buHdSBs4buxYzogbG9jayBXSSBjxaksIHBow6F0IGjDoG5oIFdJIG3hu5tpIOKGkiAxMCkgQXVkaXQgJiBLUEkuYH0sCiAgICB7cTovXGJraeG6v24gdHLDumNcYnxcYmPhuqV1IHRyw7pjIGjhu4cgdGjhu5FuZ1xifFxiaHlicmlkXGIvaSwgYTpgKipIeWJyaWQgV2ViICsgV2luZG93czoqKgrigKIgV2ViIChSZWFjdCkgcXXhuqNuIGzDvSAmIGLDoW8gY8OhbzsgV2luZG93cyAoVGF1cmkvLk5FVCkgY2hvIHjGsOG7n25nIG9mZmxpbmUuCuKAoiBCYWNrZW5kIEZhc3RBUEkgKyBPQ1IvUGFyc2VyL1JBRyArIFBvc3RncmVTUUwgKyBGaWxlIFN0b3JlLgrigKIgU3luYyAyIGNoaeG7gXUgRWRnZeKGlFNlcnZlciwgUkJBQywgYXVkaXQsIGFsZXJ0IGhp4buHdSBs4buxYy5gfQogIF07CiAgY29uc3QgRUNOX0RBVEEgPSBbCiAgICB7ZWNuX25vOidFQ04tMjAyNC0xMTgnLCBzdGF0dXM6J0FwcHJvdmVkJywgcHJpb3JpdHk6J0ExJywgdmFsaWRfZnJvbTonMjAyNC0xMi0yMCcsIHBhcnRzOlsnQScsJ1BOTFBWNTcwTDFZQi1BJ10sIG1vZGVsczpbJ0RDLVM5SFA5LUsnXSwgY2hhbmdlOidSZXBsYWNlIHJlc2lzdG9yIHNwZWMnLCBkZXB0czpbJ1NNVCcsJ1FDJ119LAogICAge2Vjbl9ubzonRUNOLTIwMjUtMDQ1Jywgc3RhdHVzOidBc3NpZ25lZCcsIHByaW9yaXR5OidBMicsIHZhbGlkX2Zyb206JzIwMjUtMDktMTUnLCBwYXJ0czpbJ1BOTFBWNTcwTDFXQS1BJ10sIG1vZGVsczpbJ0RDLVM5SFA5LUsnXSwgY2hhbmdlOidSZXYgV0kgcGFnZSAxMicsIGRlcHRzOlsnQ09TJywnUE1TJywnUUMnXX0sCiAgICB7ZWNuX25vOidFQ04tMjAyNS0wNDYnLCBzdGF0dXM6J0RyYWZ0JywgcHJpb3JpdHk6J0InLCB2YWxpZF9mcm9tOicyMDI1LTEwLTAxJywgcGFydHM6WydCJ10sIG1vZGVsczpbJ01ELTEwMCddLCBjaGFuZ2U6J0FkZCBESVAgc3RlcCcsIGRlcHRzOlsnRElQJywnRkEnXX0sCiAgICB7ZWNuX25vOidFQ04tMjAyNS0wNDcnLCBzdGF0dXM6J0VmZmVjdGl2ZScsIHByaW9yaXR5OidBMScsIHZhbGlkX2Zyb206JzIwMjUtMDgtMDEnLCBwYXJ0czpbJ0EtUkVWMSddLCBtb2RlbHM6WydNRC0yMDAnXSwgY2hhbmdlOidCb00gYWx0IHBhcnQnLCBkZXB0czpbJ1BFJywnU01UJ119LAogIF07CiAgY29uc3QgQUxJQVMgPSBbCiAgICB7ZnJvbTonQScsIHRvOidBJ30sIHtmcm9tOidBLVJFVjEnLCB0bzonQSd9LAogICAge2Zyb206J1BOTFBWNTcwTDFZQi1BJywgdG86J1BOTFBWNTcwTDFZQi1BJ30sCiAgICB7ZnJvbTonUE5MUFY1NzBMMVdBLUEnLCB0bzonUE5MUFY1NzBMMVdBLUEnfQogIF07CiAgY29uc3QgTFNfS0VZID0gJ2Vjbl9rYl91c2VyJzsKCiAgZnVuY3Rpb24gbG9hZFVzZXJLQigpeyB0cnl7cmV0dXJuIEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oTFNfS0VZKXx8J1tdJyl9Y2F0Y2goZSl7cmV0dXJuW119IH0KICBmdW5jdGlvbiBzYXZlVXNlcktCKGFycil7IGxvY2FsU3RvcmFnZS5zZXRJdGVtKExTX0tFWSwgSlNPTi5zdHJpbmdpZnkoYXJyKSkgfQoKICAvLyBDaGF0CiAgY29uc3QgY2hhdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGF0Jyk7CiAgZnVuY3Rpb24gYXBwZW5kTXNnKHdobywgaHRtbCl7CiAgICBjb25zdCByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIHJvdy5jbGFzc05hbWUgPSAnbXNnICcgKyAod2hvPT09J21lJz8nbWUnOicnKTsKICAgIGNvbnN0IGF2YXRhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgYXZhdGFyLmNsYXNzTmFtZSA9ICdhdmF0YXInOwogICAgYXZhdGFyLnRleHRDb250ZW50ID0gKHdobz09PSdtZScpPydZJzonQUknOwogICAgY29uc3QgYnViYmxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBidWJibGUuY2xhc3NOYW1lID0gJ2J1YmJsZSBhbnN3ZXInOwogICAgYnViYmxlLmlubmVySFRNTCA9IGh0bWw7CiAgICBpZih3aG89PT0nbWUnKXsgcm93LmFwcGVuZENoaWxkKGJ1YmJsZSk7IHJvdy5hcHBlbmRDaGlsZChhdmF0YXIpOyB9IGVsc2UgeyByb3cuYXBwZW5kQ2hpbGQoYXZhdGFyKTsgcm93LmFwcGVuZENoaWxkKGJ1YmJsZSk7IH0KICAgIGNoYXQuYXBwZW5kQ2hpbGQocm93KTsKICAgIGNoYXQuc2Nyb2xsVG9wID0gY2hhdC5zY3JvbGxIZWlnaHQ7CiAgfQoKICBmdW5jdGlvbiBub3JtKHMpeyByZXR1cm4gKHN8fCcnKS50b1N0cmluZygpLnRyaW0oKS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1tccyNfLV0rL2csJycpIH0KICBmdW5jdGlvbiBhbGlhc01hcChjb2RlKXsKICAgIGNvbnN0IG4gPSBub3JtKGNvZGUpOwogICAgY29uc3QgZm91bmQgPSBBTElBUy5maWx0ZXIoYSA9PiBub3JtKGEuZnJvbSk9PT1uKS5tYXAoYT0+YS50byk7CiAgICByZXR1cm4gZm91bmQubGVuZ3RoPyBmb3VuZCA6IFtjb2RlXTsKICB9CiAgZnVuY3Rpb24gZnV6enlJbmNsdWRlcyhoYXksIG5lZWRsZSl7CiAgICBjb25zdCBuSGF5ID0gbm9ybShoYXkpLCBuTmQgPSBub3JtKG5lZWRsZSk7CiAgICByZXR1cm4gbkhheS5pbmNsdWRlcyhuTmQpIHx8IG5OZC5pbmNsdWRlcyhuSGF5KTsKICB9CgogIGZ1bmN0aW9uIHJlbmRlclRyYWNlTWFya2Rvd24oY29kZSl7CiAgICBjb25zdCB0YXJnZXRzID0gYWxpYXNNYXAoY29kZSk7CiAgICBjb25zdCByb3dzID0gRUNOX0RBVEEuZmlsdGVyKGUgPT4KICAgICAgZS5wYXJ0cy5zb21lKHAgPT4gdGFyZ2V0cy5zb21lKHQgPT4gZnV6enlJbmNsdWRlcyhwLHQpKSkgfHwKICAgICAgZS5tb2RlbHMuc29tZShtID0+IHRhcmdldHMuc29tZSh0ID0+IGZ1enp5SW5jbHVkZXMobSx0KSkpCiAgICApLnNvcnQoKGEsYik9PiAoYS52YWxpZF9mcm9tPGIudmFsaWRfZnJvbT8xOi0xKSk7CiAgICBpZighcm93cy5sZW5ndGgpIHJldHVybiBtZChgS2jDtG5nIHTDrG0gdGjhuqV5IEVDTiBsacOqbiBxdWFuIHThu5tpICoqJHtjb2RlfSoqIHRyb25nIGThu68gbGnhu4d1IGRlbW8uYCk7CiAgICBjb25zdCBpdGVtcyA9IHJvd3MubWFwKHIgPT4gYOKAoiAqKiR7ci5lY25fbm99Kiog4oCUICR7ci5zdGF0dXN9LCDGsHUgdGnDqm46ICR7ci5wcmlvcml0eX0sIGhp4buHdSBs4buxYzogJHtyLnZhbGlkX2Zyb219CiAgLSBQYXJ0cy9Nb2RlbHM6ICR7Wy4uLnIucGFydHMsIC4uLnIubW9kZWxzXS5qb2luKCcsICcpfQogIC0gQ2hhbmdlOiAke3IuY2hhbmdlfQogIC0gRGVwdDogJHtyLmRlcHRzLmpvaW4oJywgJyl9YCkuam9pbignXG4nKTsKICAgIHJldHVybiBtZChgKipL4bq/dCBxdeG6oyB0cnV5IHbhur90IGNobzoqKiBcYCR7Y29kZX1cYFxuJHtpdGVtc31cblxuKkfhu6NpIMO9OiogZ8O1IOKAnFNvIHPDoW5oIEVDTi0yMDI0LTExOCB2w6AgRUNOLTIwMjUtMDQ14oCdLmApOwogIH0KCiAgZnVuY3Rpb24gcmVuZGVyQ29tcGFyZU1hcmtkb3duKGEsYil7CiAgICBjb25zdCBBID0gRUNOX0RBVEEuZmluZCh4PT54LmVjbl9ubz09PWEpOwogICAgY29uc3QgQiA9IEVDTl9EQVRBLmZpbmQoeD0+eC5lY25fbm89PT1iKTsKICAgIGlmKCFBIHx8ICFCKSByZXR1cm4gbWQoYEtow7RuZyB0w6xtIHRo4bqleSBk4buvIGxp4buHdSBkZW1vIGNobyAke2F9IGhv4bq3YyAke2J9LmApOwogICAgZnVuY3Rpb24gc2V0RGlmZihhcnIxLCBhcnIyKXsKICAgICAgY29uc3QgczEgPSBuZXcgU2V0KGFycjEpLCBzMiA9IG5ldyBTZXQoYXJyMik7CiAgICAgIGNvbnN0IG9ubHkxID0gWy4uLnMxXS5maWx0ZXIoeD0+IXMyLmhhcyh4KSk7CiAgICAgIGNvbnN0IG9ubHkyID0gWy4uLnMyXS5maWx0ZXIoeD0+IXMxLmhhcyh4KSk7CiAgICAgIHJldHVybiB7b25seTEsIG9ubHkyfTsKICAgIH0KICAgIGNvbnN0IHBkID0gc2V0RGlmZihBLnBhcnRzLCBCLnBhcnRzKTsKICAgIGNvbnN0IG1kaWZmID0gc2V0RGlmZihBLm1vZGVscywgQi5tb2RlbHMpOwogICAgcmV0dXJuIG1kKGAqKlNvIHPDoW5oICR7YX0g4oaUICR7Yn0qKgotIFRy4bqhbmcgdGjDoWk6ICR7QS5zdGF0dXN9IOKGlCAke0Iuc3RhdHVzfQotIMavdSB0acOqbjogJHtBLnByaW9yaXR5fSDihpQgJHtCLnByaW9yaXR5fQotIEhp4buHdSBs4buxYzogJHtBLnZhbGlkX2Zyb219IOKGlCAke0IudmFsaWRfZnJvbX0KLSBQYXJ0cyBjaOG7iSDhu58gJHthfTogJHtwZC5vbmx5MS5qb2luKCcsICcpIHx8ICcobm9uZSknfQotIFBhcnRzIGNo4buJIOG7nyAke2J9OiAke3BkLm9ubHkyLmpvaW4oJywgJykgfHwgJyhub25lKSd9Ci0gTW9kZWxzIGNo4buJIOG7nyAke2F9OiAke21kaWZmLm9ubHkxLmpvaW4oJywgJykgfHwgJyhub25lKSd9Ci0gTW9kZWxzIGNo4buJIOG7nyAke2J9OiAke21kaWZmLm9ubHkyLmpvaW4oJywgJykgfHwgJyhub25lKSd9Ci0gVGhheSDEkeG7lWk6ICR7QS5jaGFuZ2V9IHwgJHtCLmNoYW5nZX0KLSBEZXB0OiAke0EuZGVwdHMuam9pbignLCAnKX0gfCAke0IuZGVwdHMuam9pbignLCAnKX1gKTsKICB9CgogIGZ1bmN0aW9uIGFuc3dlcihxKXsKICAgIC8vIHVzZXIgS0IgZmlyc3QKICAgIGZvcihjb25zdCBpdGVtIG9mIGxvYWRVc2VyS0IoKSl7CiAgICAgIHRyeXsKICAgICAgICBjb25zdCByZSA9IG5ldyBSZWdFeHAoaXRlbS5xLCdpJyk7CiAgICAgICAgaWYocmUudGVzdChxKSkgcmV0dXJuIG1kKGl0ZW0uYSk7CiAgICAgIH1jYXRjaChlKXsvKiBpZ25vcmUgKi99CiAgICB9CiAgICAvLyBiYXNlIEtCCiAgICBmb3IoY29uc3QgaXRlbSBvZiBCQVNFX0tCKXsKICAgICAgaWYoaXRlbS5xLnRlc3QocSkpIHJldHVybiBtZChpdGVtLmEpOwogICAgfQogICAgLy8gaW50ZW50cwogICAgaWYoL1xiKGVjbnxtw6N8cGFydHxtb2RlbCkuKihsacOqbiBxdWFufHRyYWNlfHRydXl8bGnhu4d0IGvDqikvaS50ZXN0KHEpIHx8IC9cYmNodeG7l2kgdGhheSDEkeG7lWlcYi9pLnRlc3QocSkpewogICAgICBjb25zdCBtID0gcS5tYXRjaCgvKD86bcOjfHBhcnR8bW9kZWwpXHMrKFtBLVphLXowLTkjXC1cX10rKS9pKTsKICAgICAgY29uc3Qga2V5ID0gbT8gbVsxXSA6ICdBJzsKICAgICAgcmV0dXJuIHJlbmRlclRyYWNlTWFya2Rvd24oa2V5KTsKICAgIH0KICAgIGNvbnN0IG1jID0gcS5tYXRjaCgvRUNOWy1cc10/KFxkezR9KVstXHNdPyhcZCspLitFQ05bLVxzXT8oXGR7NH0pWy1cc10/KFxkKykvaSk7CiAgICBpZihtYyl7CiAgICAgIGNvbnN0IGlkQSA9IGBFQ04tJHttY1sxXX0tJHttY1syXX1gOwogICAgICBjb25zdCBpZEIgPSBgRUNOLSR7bWNbM119LSR7bWNbNF19YDsKICAgICAgcmV0dXJuIHJlbmRlckNvbXBhcmVNYXJrZG93bihpZEEsIGlkQik7CiAgICB9CiAgICByZXR1cm4gbWQoIk3DrG5oIGNoxrBhIGPDsyBjw6J1IHRy4bqjIGzhu51pLiBWw6BvIHRhYiAqKkFkbWluIFRyYWluaW5nKiogxJHhu4MgdGjDqm0gUS9BIChyZWdleCkg4oCUIGhv4bq3YyB0aOG7rTogKkVDTiB2aeG6v3QgdOG6r3QgbMOgIGfDrD8qIik7CiAgfQoKICAvLyB3aXJlIGNoYXQKICBjb25zdCBxSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncScpOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhc2snKS5vbmNsaWNrID0gKCkgPT4gewogICAgY29uc3QgcSA9IHFJbnB1dC52YWx1ZS50cmltKCk7IGlmKCFxKSByZXR1cm47CiAgICBhcHBlbmRNc2coJ21lJywgbWQocSkpOwogICAgcUlucHV0LnZhbHVlPScnOwogICAgc2V0VGltZW91dCgoKT0+IGFwcGVuZE1zZygnYWknLCBhbnN3ZXIocSkpLCAyMDApOwogIH07CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NsZWFyJykub25jbGljayA9ICgpID0+IGNoYXQuaW5uZXJIVE1MPScnOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbnNlcnRFeGFtcGxlcycpLm9uY2xpY2sgPSAoKSA9PiB7CiAgICBxSW5wdXQudmFsdWUgPSAiUXV5IHRyw6xuaCBFQ04gdOG6oWkgUFNOVj8iOwogICAgcUlucHV0LmZvY3VzKCk7CiAgfTsKICBxSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGUgPT4geyBpZihlLmtleT09PSdFbnRlcicpIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhc2snKS5jbGljaygpOyB9KTsKCiAgLy8gVHJhY2UgdGFibGUKICBjb25zdCB0Ym9keSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyN0YmwgdGJvZHknKTsKICBmdW5jdGlvbiByZWZyZXNoVGFibGUocm93cyl7CiAgICB0Ym9keS5pbm5lckhUTUw9Jyc7CiAgICBsZXQgZGVwdFNldD1uZXcgU2V0KCksIGExPTAsIGR1ZT0wOwogICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTsKICAgIGZvcihjb25zdCByIG9mIHJvd3MpewogICAgICBjb25zdCB0ciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyk7CiAgICAgIHRyLmlubmVySFRNTCA9IGAKICAgICAgICA8dGQgY2xhc3M9Im1vbm8iPiR7ci5lY25fbm99PC90ZD4KICAgICAgICA8dGQ+JHtyLnN0YXR1c308L3RkPgogICAgICAgIDx0ZD48c3BhbiBjbGFzcz0icGlsbCAke3IucHJpb3JpdHkudG9Mb3dlckNhc2UoKX0iPiR7ci5wcmlvcml0eX08L3NwYW4+PC90ZD4KICAgICAgICA8dGQgY2xhc3M9Im1vbm8iPiR7ci52YWxpZF9mcm9tfTwvdGQ+CiAgICAgICAgPHRkIGNsYXNzPSJtb25vIj4ke1suLi5yLnBhcnRzLCAuLi5yLm1vZGVsc10uam9pbignLCAnKX08L3RkPgogICAgICAgIDx0ZD4ke3IuY2hhbmdlfTwvdGQ+CiAgICAgICAgPHRkPiR7ci5kZXB0cy5qb2luKCcsICcpfTwvdGQ+YDsKICAgICAgdGJvZHkuYXBwZW5kQ2hpbGQodHIpOwogICAgICByLmRlcHRzLmZvckVhY2goZD0+ZGVwdFNldC5hZGQoZCkpOwogICAgICBpZihyLnByaW9yaXR5PT09J0ExJykgYTErKzsKICAgICAgY29uc3QgZGlmZiA9IChuZXcgRGF0ZShyLnZhbGlkX2Zyb20pLW5vdykvKDEwMDAqMzYwMCoyNCk7CiAgICAgIGlmKGRpZmYgPD0gNyAmJiBkaWZmID49IDApIGR1ZSsrOwogICAgfQogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2tfdG90YWwnKS50ZXh0Q29udGVudCA9IHJvd3MubGVuZ3RoOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2tfYTEnKS50ZXh0Q29udGVudCA9IGExOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2tfZHVlJykudGV4dENvbnRlbnQgPSBkdWU7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgna19kZXB0JykudGV4dENvbnRlbnQgPSBbLi4uZGVwdFNldF0ubGVuZ3RoOwogIH0KICByZWZyZXNoVGFibGUoRUNOX0RBVEEpOwoKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndHJhY2VCdG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICBjb25zdCBjb2RlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RyYWNlQ29kZScpLnZhbHVlLnRyaW0oKSB8fCAnQSc7CiAgICBjb25zdCB0YXJnZXRzID0gYWxpYXNNYXAoY29kZSk7CiAgICBjb25zdCByb3dzID0gRUNOX0RBVEEuZmlsdGVyKGUgPT4KICAgICAgZS5wYXJ0cy5zb21lKHAgPT4gdGFyZ2V0cy5zb21lKHQgPT4gZnV6enlJbmNsdWRlcyhwLHQpKSkgfHwKICAgICAgZS5tb2RlbHMuc29tZShtID0+IHRhcmdldHMuc29tZSh0ID0+IGZ1enp5SW5jbHVkZXMobSx0KSkpCiAgICApLnNvcnQoKGEsYik9PiAoYS52YWxpZF9mcm9tPGIudmFsaWRfZnJvbT8xOi0xKSk7CiAgICByZWZyZXNoVGFibGUocm93cyk7CiAgICBhcHBlbmRNc2coJ2FpJywgcmVuZGVyVHJhY2VNYXJrZG93bihjb2RlKSk7CiAgfSk7CgogIC8vIENTViBleHBvcnQKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXhwb3J0Q1NWJyk/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgY29uc3QgaGVhZGVycyA9IFsnRUNOIE5vJywnU3RhdHVzJywnUHJpb3JpdHknLCdWYWxpZCBGcm9tJywnUGFydC9Nb2RlbCcsJ0NoYW5nZScsJ0RlcHRzJ107CiAgICBjb25zdCBsaW5lcyA9IFtoZWFkZXJzLmpvaW4oJywnKV07CiAgICBmb3IoY29uc3QgciBvZiBFQ05fREFUQSl7CiAgICAgIGNvbnN0IHJvdyA9IFsKICAgICAgICByLmVjbl9ubywgci5zdGF0dXMsIHIucHJpb3JpdHksIHIudmFsaWRfZnJvbSwKICAgICAgICBbLi4uci5wYXJ0cywgLi4uci5tb2RlbHNdLmpvaW4oJyAnKSwKICAgICAgICByLmNoYW5nZS5yZXBsYWNlKC8sL2csJzsnKSwKICAgICAgICByLmRlcHRzLmpvaW4oJ3wnKQogICAgICBdLm1hcCh4PT5gIiR7KHgrJycpLnJlcGxhY2UoLyIvZywnIiInKX0iYCkuam9pbignLCcpOwogICAgICBsaW5lcy5wdXNoKHJvdyk7CiAgICB9CiAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2xpbmVzLmpvaW4oJ1xuJyldLCB7dHlwZTondGV4dC9jc3Y7Y2hhcnNldD11dGYtOCd9KTsKICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOyBhLmhyZWY9dXJsOyBhLmRvd25sb2FkPSdlY25faGlzdG9yeV9zYW1wbGUuY3N2JzsgYS5jbGljaygpOwogICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpOwogIH0pOwoKICAvLyBNZXJtYWlkCiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbmRlck1lcm1haWQnKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICBjb25zdCBjb2RlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lcm1haWRTcmMnKS52YWx1ZS50cmltKCkgfHwKYGZsb3djaGFydCBURApBKFtTdWJtaXQgRUNOXSkgLS0+IEJbQUkgUGFyc2UgKE9DUildCkIgLS0+IEN7VmFsaWRhdGV9CkMgLS0+fE9LfCBEW0Fzc2lnbiBEZXB0XQpDIC0tPnxGYWlsfCBBCkQgLS0+IEVbU2NoZWR1bGUgJiBOb3RpZnldCkUgLS0+IEZbSW1wbGVtZW50IEAgTGluZV0KRiAtLT4gR1tBcHByb3ZlICYgZVNpZ25dCkcgLS0+IEhbRWZmZWN0aXZlOiBMb2NrIG9sZCBXSSAvIFJlbGVhc2UgbmV3IFdJXWA7CiAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZXJtYWlkJyk7CiAgICBlbC5pbm5lckhUTUwgPSBjb2RlLnJlcGxhY2UoLzwvZywnJmx0OycpOwogICAgbWVybWFpZC5yZW5kZXIoJ20xJywgY29kZSwgKHN2Zyk9PnsgZWwuaW5uZXJIVE1MID0gc3ZnOyB9KTsKICB9KTsKCiAgLy8gQWRtaW4gbG9jay91bmxvY2sKICBjb25zdCBBRE1JTl9VTkxPQ0tfS0VZID0gJ2Vjbl9hZG1pbl91bmxvY2snOwogIGZ1bmN0aW9uIGlzVW5sb2NrZWQoKXsgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKEFETUlOX1VOTE9DS19LRVkpPT09JzEnIH0KICBmdW5jdGlvbiBzZXRVbmxvY2tlZCh2KXsgbG9jYWxTdG9yYWdlLnNldEl0ZW0oQURNSU5fVU5MT0NLX0tFWSwgdj8nMSc6JzAnKSB9CiAgZnVuY3Rpb24gc3luY0FkbWluVUkoKXsKICAgIGNvbnN0IHBhbmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FkbWluUGFuZWwnKTsKICAgIGNvbnN0IGhpbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9ja0hpbnQnKTsKICAgIGlmKGlzVW5sb2NrZWQoKSl7IHBhbmVsLnN0eWxlLmRpc3BsYXk9J2Jsb2NrJzsgaGludC50ZXh0Q29udGVudD0nKsSQYW5nIG3hu58ga2hvw6EgQWRtaW4gVHJhaW5pbmcuKicgfQogICAgZWxzZSB7IHBhbmVsLnN0eWxlLmRpc3BsYXk9J25vbmUnOyBoaW50LnRleHRDb250ZW50PScqTeG6t2MgxJHhu4tuaCBi4buLIGtob8OhLiBTYXUga2hpIG3hu58ga2hvw6EsIGFkbWluIGPDsyB0aOG7gyB0aMOqbS9z4butYSB0cmkgdGjhu6ljLionIH0KICB9CiAgc3luY0FkbWluVUkoKTsKCiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VubG9jaycpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgY29uc3Qga2V5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FkbWluS2V5JykudmFsdWUudHJpbSgpOwogICAgLy8gU2ltcGxlIGxvY2FsIHVubG9jazogYWNjZXB0IGFueSBub24tZW1wdHkgZm9yIGRlbW87IHJlcGxhY2UgYnkgcmVhbCBhdXRoIGluIHByb2R1Y3Rpb24uCiAgICBpZigha2V5KXsgYWxlcnQoJ05o4bqtcCBtw6MgYWRtaW4gKGRlbW8gY2jhuqVwIG5o4bqtbiBi4bqldCBr4buzIGNodeG7l2kgbsOgbyknKTsgcmV0dXJuOyB9CiAgICBzZXRVbmxvY2tlZCh0cnVlKTsgc3luY0FkbWluVUkoKTsKICB9KTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9jaycpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4geyBzZXRVbmxvY2tlZChmYWxzZSk7IHN5bmNBZG1pblVJKCk7IH0pOwoKICAvLyBBZG1pbiBhZGQvaW1wb3J0L2V4cG9ydAogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhZGRRQScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgaWYoIWlzVW5sb2NrZWQoKSkgcmV0dXJuIGFsZXJ0KCdDaMawYSBt4bufIGtob8OhIGFkbWluLicpOwogICAgY29uc3QgcSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhZG1pblEnKS52YWx1ZS50cmltKCk7CiAgICBjb25zdCBhID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FkbWluQScpLnZhbHVlLnRyaW0oKTsKICAgIGlmKCFxIHx8ICFhKSByZXR1cm4gYWxlcnQoJ05o4bqtcCDEkeG7pyBjw6J1IGjhu49pICYgdHLhuqMgbOG7nWknKTsKICAgIGNvbnN0IGtiID0gbG9hZFVzZXJLQigpOyBrYi5wdXNoKHtxLGF9KTsgc2F2ZVVzZXJLQihrYik7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWRtaW5RJykudmFsdWU9Jyc7IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhZG1pbkEnKS52YWx1ZT0nJzsKICAgIGFsZXJ0KCfEkMOjIHRow6ptIHbDoG8gS0IgKGzGsHUgdHJvbmcgdHLDrG5oIGR1eeG7h3QgbsOgeSkuJyk7CiAgfSk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2V4cG9ydEtCJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICBpZighaXNVbmxvY2tlZCgpKSByZXR1cm4gYWxlcnQoJ0NoxrBhIG3hu58ga2hvw6EgYWRtaW4uJyk7CiAgICBjb25zdCBkYXRhID0gSlNPTi5zdHJpbmdpZnkobG9hZFVzZXJLQigpLCBudWxsLCAyKTsKICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbZGF0YV0sIHt0eXBlOidhcHBsaWNhdGlvbi9qc29uJ30pOwogICAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsKICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7IGEuaHJlZiA9IHVybDsgYS5kb3dubG9hZCA9ICdlY25fa2JfZXhwb3J0Lmpzb24nOyBhLmNsaWNrKCk7IFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICB9KTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW1wb3J0RmlsZScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7CiAgICBpZighaXNVbmxvY2tlZCgpKSByZXR1cm4gYWxlcnQoJ0NoxrBhIG3hu58ga2hvw6EgYWRtaW4uJyk7CiAgICBjb25zdCBmID0gZS50YXJnZXQuZmlsZXNbMF07IGlmKCFmKSByZXR1cm47CiAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwogICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHsKICAgICAgdHJ5ewogICAgICAgIGNvbnN0IGFyciA9IEpTT04ucGFyc2UocmVhZGVyLnJlc3VsdCk7CiAgICAgICAgaWYoQXJyYXkuaXNBcnJheShhcnIpKXsgc2F2ZVVzZXJLQihhcnIpOyBhbGVydCgnxJDDoyBuaOG6rXAgS0IuJyk7IH0KICAgICAgICBlbHNlIGFsZXJ0KCdGaWxlIGtow7RuZyDEkcO6bmcgxJHhu4tuaCBk4bqhbmcuJyk7CiAgICAgIH1jYXRjaChlcnIpeyBhbGVydCgnS2jDtG5nIMSR4buNYyDEkcaw4bujYyBKU09OLicpOyB9CiAgICB9OwogICAgcmVhZGVyLnJlYWRBc1RleHQoZik7CiAgfSk7Cjwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4K");
      var url = 'data:text/html;charset=utf-8,' + encodeURIComponent(html);
      window.open(url, '_blank');
    });
  }
  // Close by clicking backdrop
  if(modal){
    modal.addEventListener('click', function(e){ if(e.target === modal) modal.style.display = 'none'; });
  }
})();
</script>


<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const K='ecn_master_v8';

  function ensureSeed(){
    let arr=[];
    try{ arr = JSON.parse(localStorage.getItem(K)||'[]'); }catch(e){ arr=[]; }
    if(arr.length >= 400) return;
    const depts=['SMT','DIP','FA','FE','PE','QC','PMS','PSCD','COS'];
    const statuses=['Not Yet Apply','In progress','Completed'];
    const models=['VL-MZ35-K01','VL-MZ35-K02','VC-700L','DC-S9HP9-K','AC-M4X2-P','NX-3000','MK-450A','PP-12F','HX-9Z'];
    arr=[]; let n=1001;
    for(let i=0;i<460;i++){
      const m=String(1+Math.floor(Math.random()*12)).padStart(2,'0');
      const d=String(1+Math.floor(Math.random()*28)).padStart(2,'0');
      arr.push({
        rank:['A','B','C','D'][Math.floor(Math.random()*4)],
        no:'ECN-'+(n++), sub:'SUB-'+Math.floor(100+Math.random()*900),
        model:models[Math.floor(Math.random()*models.length)],
        title:'Change part & routing '+(i+1),
        before:'#PART-'+Math.floor(100+Math.random()*999),
        after:'#PART-'+Math.floor(100+Math.random()*999),
        effective:'2025-'+m+'-'+d,
        valid: Math.random()>.4?'OK':'N/A',
        status: statuses[Math.floor(Math.random()*statuses.length)],
        dept: depts[Math.floor(Math.random()*depts.length)],
        tna:[{k:'Create',v:'2025-'+m+'-'+d,by:'PE'}]
      });
    }
    localStorage.setItem(K, JSON.stringify(arr));
  }

  function renderKPIs(){
    const data = JSON.parse(localStorage.getItem(K)||'[]');
    const total = data.length;
    const notYet = data.filter(x=>x.status==='Not Yet Apply').length;
    const inProg = data.filter(x=>x.status==='In progress').length;
    const completed = data.filter(x=>x.status==='Completed').length;
    $('#kPending') && ($('#kPending').textContent = total);
    $('#kProgress') && ($('#kProgress').textContent = notYet);
    $('#kEffective') && ($('#kEffective').textContent = inProg);
    $('#kArchived') && ($('#kArchived').textContent = completed);
  }

  function renderCharts(){
    if(!window.Chart) return;
    const ctx1 = $('#yearlyChart')?.getContext('2d');
    const ctx2 = $('#monthlyChart')?.getContext('2d');
    if(!ctx1||!ctx2) return;
    const data = JSON.parse(localStorage.getItem(K)||'[]');
    const byMonth = Array(12).fill(0);
    data.forEach(r=>{ const m=parseInt((r.effective||'2025-01-01').split('-')[1]||'1',10)-1; if(m>=0&&m<12) byMonth[m]++; });
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec/2025'];
    const colors = byMonth.map(v=> v>=38 ? '#ea580c' : (v>=30 ? '#f59e0b' : '#22c55e'));
    if(window._yearlyChart) window._yearlyChart.destroy();
    window._yearlyChart = new Chart(ctx1,{type:'bar',data:{labels:months,datasets:[{label:'ECN 2025',data:byMonth,backgroundColor:colors}]},
      options:{responsive:true,scales:{y:{beginAtZero:true}}}});
    const days=['1','4','7','10','12','15','17','19','21','23','25','27'];
    const lineVals=days.map((_,i)=> (i%5===0?4:(i%3===0?3:(i%2===0?2:1))));
    if(window._monthlyChart) window._monthlyChart.destroy();
    window._monthlyChart = new Chart(ctx2,{type:'line',data:{labels:days,datasets:[{label:'ECN/day',data:lineVals,tension:.3}]},
      options:{responsive:true,scales:{y:{beginAtZero:true,suggestedMax:4}}}});
  }

  function renderHeatmap(){
    const host = $('#heatmap'); if(!host) return;
    const data = JSON.parse(localStorage.getItem(K)||'[]');
    const depts = ['SMT','DIP','FA','FE','PE','QC','PMS','PSCD','COS'];
    const head = ['Dept','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    host.innerHTML = head.map(h=>`<div class="hhead">${h}</div>`).join('');
    const matrix = depts.map(_=>Array(12).fill(0));
    data.forEach(r=>{ const m=parseInt((r.effective||'2025-01-01').split('-')[1]||'1',10)-1; const di=depts.indexOf(r.dept); if(di>=0&&m>=0) matrix[di][m]++; });
    depts.forEach((d,i)=>{
      const row = [`<div>${d}</div>`].concat(matrix[i].map(v=>`<div style="background:rgba(14,165,233,${Math.min(0.1+v/40,0.35)})">${v}</div>`)).join('');
      host.insertAdjacentHTML('beforeend', row);
    });
  }

  // Department simple paging (12 per page)
  let dPage=1, dPageSize=12;
  function renderDept(){
    const body=$('#deptRows'); if(!body) return;
    const all = JSON.parse(localStorage.getItem(K)||'[]');
    const dept = $('#dDept')?.value||'';
    const fil = all.filter(r=>!dept || r.dept===dept);
    const start=(dPage-1)*dPageSize;
    const view=fil.slice(start, start+dPageSize);
    body.innerHTML='';
    view.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td><span class="rank-badge rank-${r.rank}">${r.rank}</span></td>
        <td class="mono">${r.no}</td><td>${r.sub}</td><td class="mono">${r.model}</td><td>${r.title}</td>
        <td class="mono">${r.before}</td><td class="mono">${r.after}</td><td>${r.effective}</td><td>${r.valid}</td>
        <td><span class="badge-mini">${r.status}</span></td><td><button class="btn sm">View</button></td>`;
      body.appendChild(tr);
    });
  }
  $('#dDept')?.addEventListener('change',()=>{dPage=1;renderDept();});

  function autoResizeIframe(id){
    const el=document.getElementById(id); if(!el) return;
    const res=()=>{ try{ const h=el.contentWindow.document.body.scrollHeight; el.style.height=Math.max(780, h+20)+'px'; }catch(e){} };
    el.addEventListener('load', res); setTimeout(res, 600); window.addEventListener('resize', res);
  }

  function boot(){
    ensureSeed();
    renderKPIs();
    renderCharts();
    renderHeatmap();
    renderDept();
    autoResizeIframe('adminFrame');
    autoResizeIframe('wiFrame');
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
})();
</script>


<script>
/* ECN v8 FIX v5 â€” final dashboard, charts, master table, popup view, status dots, valid date */
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const K='ecn_master_v8';

  function seedExact(){
    let arr=[];
    try{ arr = JSON.parse(localStorage.getItem(K)||'[]'); }catch(e){ arr=[]; }
    const cnt = (st)=>arr.filter(x=>x.status===st).length;
    if(arr.length===460 && cnt('Not Yet Apply')===167 && cnt('In progress')===133 && cnt('Completed')===160){
      return;
    }
    const depts=['SMT','DIP','FA','FE','PE','QC','PMS','PSCD','COS'];
    const models=['MDL-310','MDL-900','MDL-500','MDL-220','MDL-700','VC-700L','NX-3000','MK-450A','PP-12F','HX-9Z'];
    const mk = (i, status)=>{
      const m = String(1+Math.floor(Math.random()*12)).padStart(2,'0');
      const d = String(1+Math.floor(Math.random()*28)).padStart(2,'0');
      const eff = `2025-${m}-${d}`;
      return {
        rank:['A','B','C','D'][Math.floor(Math.random()*4)],
        no:'ECN-'+(1219+i),
        sub:'SUB-'+(1219+i),
        model:models[Math.floor(Math.random()*models.length)],
        title:['Firmware update','Safety marking adj','Relocate label','Connector pin swap','Sealant change'][i%5],
        before: Math.random().toString(36).slice(2,12).toUpperCase(),
        after:  Math.random().toString(36).slice(2,12).toUpperCase(),
        effective: eff,
        valid: eff,
        status: status,
        dept: depts[Math.floor(Math.random()*depts.length)],
        reason: 'Regulatory label relocation per IEC update',
        latest: `2025-08-0${1+(i%6)} by QC Team â€” WI reference updated`,
        perDept: {SMT:eff, DIP:eff, FA:eff, FE:eff, PE:eff, QC:eff, PMS:eff, PSCD:eff, COS:eff}
      };
    };
    const build = (n, st, startIndex)=> Array.from({length:n}, (_,k)=> mk(startIndex+k, st));
    arr=[].concat(
      build(167,'Not Yet Apply',0),
      build(133,'In progress',167),
      build(160,'Completed',300)
    );
    localStorage.setItem(K, JSON.stringify(arr));
  }

  function renderKPIs_v5(){
    const total=460, nya=167, prog=133, done=160;
    $('#kPending') && ($('#kPending').textContent = total);
    $('#kProgress') && ($('#kProgress').textContent = nya);
    $('#kEffective') && ($('#kEffective').textContent = prog);
    $('#kArchived') && ($('#kArchived').textContent = done);
    const labels=$$('#page-dashboard .kpi .k');
    if(labels[0]) labels[0].textContent='Total ECN';
    if(labels[1]) labels[1].textContent='Not yet apply';
    if(labels[2]) labels[2].textContent='In progress';
    if(labels[3]) labels[3].textContent='Completed';
  }

  let yearlyChart, monthlyChart;
  function renderCharts_v5(){
    if(!window.Chart) return;
    const ctx1=$('#yearlyChart')?.getContext('2d');
    const ctx2=$('#monthlyChart')?.getContext('2d');
    if(!ctx1||!ctx2) return;
    const data=JSON.parse(localStorage.getItem(K)||'[]');
    const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec/2025'];
    const byMonth=Array(12).fill(0);
    data.forEach(r=>{ const m=parseInt(r.effective.split('-')[1]||'1',10)-1; if(m>=0 && m<12) byMonth[m]++; });
    const colors = byMonth.map(v=> v>38 ? '#ea580c' : (v>=32 ? '#f59e0b' : '#22c55e'));
    if(yearlyChart) yearlyChart.destroy();
    yearlyChart = new Chart(ctx1, {
      type:'bar',
      data:{labels:months, datasets:[{label:'ECN 2025', data:byMonth, backgroundColor:colors}]},
      options:{
        responsive:true,
        plugins:{legend:{display:true}},
        scales:{
          x:{grid:{display:false}},
          y:{beginAtZero:true, grid:{display:false}}
        }
      }
    });
    const days=['1','4','7','10','12','15','17','19','21','23','25','27'];
    const lineVals=days.map((_,i)=> (i%5===0?4:(i%3===0?3:(i%2===0?2:1))));
    if(monthlyChart) monthlyChart.destroy();
    monthlyChart = new Chart(ctx2, {
      type:'line',
      data:{labels:days, datasets:[{label:'ECN/day', data:lineVals, tension:.35, pointRadius:4, pointHoverRadius:5}]},
      options:{
        responsive:true,
        plugins:{legend:{display:true}},
        scales:{
          x:{grid:{display:false}},
          y:{beginAtZero:true, suggestedMax:4, grid:{display:false}}
        }
      }
    });
  }

  function statusDot(st){
    let cls='s-pending';
    if(st==='In progress') cls='s-progress';
    if(st==='Completed') cls='s-done';
    return `<span class="s-dot ${cls}"></span>`;
  }

  let page=1, pageSize=10;
  function applyFilters(rows){
    const sSel = $('#fStatusSel')?.value||'';
    const dSel = $('#fDept')?.value||'';
    const df = $('#fDateFrom')?.value||'';
    const dt = $('#fDateTo')?.value||'';
    const kw = ($('#q')?.value||'').toLowerCase();
    return rows.filter(r=>{
      const byS = !sSel || r.status===sSel;
      const byD = !dSel || r.dept===dSel;
      const byKw = !kw || (r.no+r.sub+r.model+r.title+r.before+r.after).toLowerCase().includes(kw);
      const byDate = (!df || r.effective>=df) && (!dt || r.effective<=dt);
      return byS && byD && byKw && byDate;
    });
  }
  function renderECN(){
    const host=$('#ecnRows'); if(!host) return;
    const all = JSON.parse(localStorage.getItem(K)||'[]');
    const fil = applyFilters(all);
    const total = fil.length;
    const totalPages = Math.max(1, Math.ceil(total/pageSize));
    if(page>totalPages) page=totalPages;
    const start = (page-1)*pageSize;
    const view = fil.slice(start, start+pageSize);
    host.innerHTML='';
    view.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML =
        `<td><span class="rank-badge rank-${r.rank}">${r.rank}</span></td>
         <td class="mono">${r.no}</td>
         <td>${r.sub}</td>
         <td class="mono">${r.model}</td>
         <td>${r.title}</td>
         <td class="mono">${r.before}</td>
         <td class="mono">${r.after}</td>
         <td>${r.effective}</td>
         <td>${r.valid}</td>
         <td>${statusDot(r.status)}</td>
         <td><button class="btn sm" data-no="${r.no}">View</button></td>`;
      host.appendChild(tr);
    });
    const info = $('#miniInfo'); if(info) info.textContent = `Page ${page}/${totalPages} â€” ${total} items`;
    $$('#ecnRows .btn.sm').forEach(btn=>{
      btn.onclick = ()=>{
        const rec = view.find(x=>x.no===btn.dataset.no);
        openPopup(rec);
      };
    });
  }
  $('#prevPage')?.addEventListener('click',()=>{ if(page>1){page--; renderECN();} });
  $('#nextPage')?.addEventListener('click',()=>{ page++; renderECN(); });
  $('#q')?.addEventListener('input', ()=>{ page=1; renderECN(); });
  $('#fStatusSel')?.addEventListener('change', ()=>{ page=1; renderECN(); });
  $('#fDept')?.addEventListener('change', ()=>{ page=1; renderECN(); });
  $('#fDateFrom')?.addEventListener('change', ()=>{ page=1; renderECN(); });
  $('#fDateTo')?.addEventListener('change', ()=>{ page=1; renderECN(); });

  let dPage=1, dSize=12;
  function dRender(){
    const body=$('#deptRows'); if(!body) return;
    const all = JSON.parse(localStorage.getItem(K)||'[]');
    const dept=$('#dDept')?.value||'';
    const fil = all.filter(r=>!dept||r.dept===dept);
    const total=fil.length, totalPages=Math.max(1,Math.ceil(total/dSize));
    if(dPage>totalPages) dPage=totalPages;
    const start=(dPage-1)*dSize;
    const view=fil.slice(start,start+dSize);
    body.innerHTML='';
    view.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><span class="rank-badge rank-${r.rank}">${r.rank}</span></td>
        <td class="mono">${r.no}</td><td>${r.sub}</td><td class="mono">${r.model}</td><td>${r.title}</td>
        <td class="mono">${r.before}</td><td class="mono">${r.after}</td><td>${r.effective}</td><td>${r.valid}</td>
        <td>${statusDot(r.status)}</td>
        <td><button class="btn sm" data-no="${r.no}">View</button></td>`;
      body.appendChild(tr);
    });
    const mini=$('#deptMini'); if(mini) mini.textContent=`Page ${dPage}/${totalPages} â€” ${total} items`;
    $$('#deptRows .btn.sm').forEach(btn=>{
      btn.onclick=()=>{
        const rec=view.find(x=>x.no===btn.dataset.no);
        openPopup(rec);
      };
    });
  }
  $('#dPrev')?.addEventListener('click',()=>{ if(dPage>1){dPage--; dRender();} });
  $('#dNext')?.addEventListener('click',()=>{ dPage++; dRender(); });
  $('#dDept')?.addEventListener('change',()=>{ dPage=1; dRender(); });

  function ensurePopup(){
    if($('#ecnPopup')) return;
    const wrap=document.createElement('div');
    wrap.id='ecnPopup';
    wrap.innerHTML=`
      <div class="popup-backdrop"></div>
      <div class="popup-panel">
        <div class="pp-head">
          <div class="title">ECN Detail</div>
          <button class="btn secondary" id="ppClose">Close</button>
        </div>
        <div class="pp-tabs">
          <div class="tab active" data-tab="info">Info</div>
          <div class="tab" data-tab="history">History</div>
          <div class="tab" data-tab="fb">Feedback</div>
        </div>
        <div class="pp-body">
          <div id="ppInfo">
            <div class="kv-tile"><div class="k">ISSUE DATE</div><div id="ppIssue"></div></div>
            <div class="kv-tile"><div class="k">TITLE</div><div id="ppTitle" class="mono"></div></div>
            <div class="kv-tile"><div class="k">REASON</div><div id="ppReason"></div></div>
            <div class="kv-tile"><div class="k">EFFECTIVE</div><div id="ppEffective"></div></div>
            <div class="grid2">
              <div class="kv-tile"><div class="k">STATUS</div><div id="ppStatus"></div></div>
              <div class="kv-tile"><div class="k">PER-DEPARTMENT EFFECTIVE</div><div id="ppPerDept" class="chips"></div></div>
            </div>
            <div class="kv-tile"><div class="k">LATEST CHANGE</div><div id="ppLatest"></div></div>
          </div>
          <div id="ppHistory" class="hidden"><div class="mono">No history (demo)</div></div>
          <div id="ppFB" class="hidden"><div class="mono">No feedback (demo)</div></div>
        </div>
      </div>`;
    document.body.appendChild(wrap);
    $('#ppClose').onclick=()=>wrap.classList.remove('open');
    $('.popup-backdrop').onclick=()=>wrap.classList.remove('open');
    $$('#ecnPopup .tab').forEach(t=>t.addEventListener('click',()=>{
      $$('#ecnPopup .tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      $('#ppInfo').classList.toggle('hidden', t.dataset.tab!=='info');
      $('#ppHistory').classList.toggle('hidden', t.dataset.tab!=='history');
      $('#ppFB').classList.toggle('hidden', t.dataset.tab!=='fb');
    }));
  }
  function openPopup(rec){
    ensurePopup();
    $('#ppIssue').textContent = rec.effective;
    $('#ppTitle').textContent = `${rec.title} (${rec.model}) â€” ${rec.no}`;
    $('#ppReason').textContent = rec.reason || 'â€”';
    $('#ppEffective').textContent = `Effective: ${rec.effective} â€” Valid BOM: ${rec.valid}`;
    $('#ppStatus').innerHTML = (function(){ return (rec.status==='Completed'?'ðŸŸ¢':rec.status==='In progress'?'ðŸ”µ':'ðŸŸ ') })();
    const chips=$('#ppPerDept'); chips.innerHTML='';
    const pd=rec.perDept||{}; Object.keys(pd).forEach(k=>{
      const c=document.createElement('span'); c.className='chip'; c.textContent=`${k}: ${pd[k]}`; chips.appendChild(c);
    });
    $('#ppLatest').textContent = rec.latest || 'â€”';
    $('#ecnPopup').classList.add('open');
  }
  window.openPopup = openPopup;

  function autoResizeIframe(id){
    const el=document.getElementById(id); if(!el) return;
    const resize=()=>{ try{ const h=el.contentWindow.document.body.scrollHeight; el.style.height=Math.max(780, h+20)+'px'; }catch(e){} };
    el.addEventListener('load', resize); setTimeout(resize, 600); window.addEventListener('resize', resize);
  }

  function boot(){
    seedExact();
    renderKPIs_v5();
    renderCharts_v5();
    renderECN();
    dRender();
    autoResizeIframe('adminFrame');
    autoResizeIframe('wiFrame');
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
})();
</script>

<style>
#ecnPopup{position:fixed; inset:0; display:none; z-index:50;}
#ecnPopup.open{display:block;}
#ecnPopup .popup-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.2);}
#ecnPopup .popup-panel{position:absolute; top:0; right:0; width:520px; height:100%; background:#fff; box-shadow:-6px 0 24px rgba(0,0,0,.12); display:flex; flex-direction:column;}
#ecnPopup .pp-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #eee;}
#ecnPopup .pp-tabs{display:flex; gap:8px; padding:10px 14px; border-bottom:1px solid #f0f0f0;}
#ecnPopup .pp-tabs .tab{padding:6px 10px; border-radius:8px; background:#f3f4f6; cursor:pointer; font-weight:600;}
#ecnPopup .pp-tabs .tab.active{background:#e5e7eb;}
#ecnPopup .pp-body{padding:14px; overflow:auto}
#ecnPopup .kv-tile{background:#fafafa; border-radius:10px; padding:10px 12px; margin-bottom:10px;}
#ecnPopup .kv-tile .k{font-size:12px; color:#6b7280; margin-bottom:6px; text-transform:uppercase; letter-spacing:.04em}
#ecnPopup .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
#ecnPopup .chips{display:flex; flex-wrap:wrap; gap:6px}
#ecnPopup .chip{background:#eef2ff; color:#1f2937; padding:4px 8px; border-radius:20px; font-size:12px}
</style>

<script src="ecn_ai_module_adapter.js"></script>
</body>
</html>
